<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>알림 시스템 종합 문서</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Pretendard','Apple SD Gothic Neo','Malgun Gothic',sans-serif;background:#f8f9fa;color:#1a1a2e;line-height:1.8}
.container{max-width:900px;margin:0 auto;padding:40px 24px}
.download-bar{position:sticky;top:0;z-index:100;background:#fff;border-bottom:1px solid #e2e8f0;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.download-bar h2{font-size:16px;color:#334155}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 20px;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;text-decoration:none;transition:opacity .2s}
.btn-primary{background:#3b82f6;color:#fff}
.btn-primary:hover{opacity:.85}
.btn-outline{background:#fff;color:#3b82f6;border:1px solid #3b82f6}
.btn-outline:hover{background:#eff6ff}
h1{font-size:28px;font-weight:800;margin:32px 0 8px;color:#0f172a;border-bottom:3px solid #3b82f6;padding-bottom:8px}
h2{font-size:22px;font-weight:700;margin:28px 0 12px;color:#1e293b;border-left:4px solid #3b82f6;padding-left:12px}
h3{font-size:17px;font-weight:600;margin:20px 0 8px;color:#334155}
h4{font-size:15px;font-weight:600;margin:16px 0 6px;color:#475569}
p{margin:6px 0}
blockquote{background:#f1f5f9;border-left:4px solid #94a3b8;padding:12px 16px;margin:12px 0;border-radius:0 6px 6px 0;color:#475569;font-size:14px}
table{width:100%;border-collapse:collapse;margin:12px 0;font-size:14px}
th{background:#f1f5f9;font-weight:600;text-align:left;padding:10px 12px;border:1px solid #e2e8f0;white-space:nowrap}
td{padding:8px 12px;border:1px solid #e2e8f0;vertical-align:top}
tr:hover td{background:#fafbfc}
code{background:#f1f5f9;padding:2px 6px;border-radius:4px;font-size:13px;font-family:'Fira Code','Consolas',monospace;color:#e11d48}
pre{background:#1e293b;color:#e2e8f0;padding:16px;border-radius:8px;overflow-x:auto;margin:12px 0;font-size:13px;line-height:1.6}
pre code{background:none;color:inherit;padding:0}
ul,ol{padding-left:24px;margin:8px 0}
li{margin:4px 0}
hr{border:none;border-top:1px solid #e2e8f0;margin:24px 0}
.toc{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:20px 24px;margin:16px 0}
.toc a{color:#3b82f6;text-decoration:none}
.toc a:hover{text-decoration:underline}
.toc ol{counter-reset:toc;list-style:none;padding-left:0}
.toc li{counter-increment:toc;margin:6px 0}
.toc li::before{content:counter(toc)". ";font-weight:600;color:#94a3b8;margin-right:4px}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:12px;font-weight:600}
.badge-auto{background:#dcfce7;color:#166534}
.badge-manual{background:#dbeafe;color:#1e40af}
.badge-active{background:#dcfce7;color:#166534}
.section{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:24px;margin:16px 0}
@media print{.download-bar{display:none}.container{padding:0}body{background:#fff}}
@media(max-width:640px){.container{padding:20px 12px}h1{font-size:22px}h2{font-size:18px}table{font-size:12px}pre{font-size:11px}}
</style>
</head>
<body>

<div class="download-bar">
  <h2>알림 시스템 종합 문서 - 탑셀러</h2>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn btn-primary" onclick="downloadMD()">MD 파일 다운로드</button>
    <button class="btn btn-outline" onclick="window.print()">PDF 인쇄</button>
  </div>
</div>

<div class="container">

<h1>알림 시스템 종합 문서</h1>
<blockquote>
  작성일: 2026-02-19<br>
  시스템: 탑셀러 주문관리 시스템<br>
  연동 서비스: Solapi (솔라피)
</blockquote>

<div class="toc">
  <h3>목차</h3>
  <ol>
    <li><a href="#s1">시스템 개요</a></li>
    <li><a href="#s2">환경 설정</a></li>
    <li><a href="#s3">Solapi SDK 연동 구조</a></li>
    <li><a href="#s4">알림톡 (Alimtalk) 시스템</a></li>
    <li><a href="#s5">브랜드톡 (Brandtalk/친구톡) 시스템</a></li>
    <li><a href="#s6">SMS 발송 시스템</a></li>
    <li><a href="#s7">데이터베이스 스키마</a></li>
    <li><a href="#s8">API 엔드포인트 목록</a></li>
    <li><a href="#s9">프론트엔드 페이지</a></li>
    <li><a href="#s10">등록된 템플릿 목록</a></li>
    <li><a href="#s11">자동 발송 시나리오</a></li>
    <li><a href="#s12">수동 발송 시나리오</a></li>
    <li><a href="#s13">매입업체 배분 알림 (SMS)</a></li>
    <li><a href="#s14">발송 이력 및 통계</a></li>
    <li><a href="#s15">비용 구조</a></li>
    <li><a href="#s16">핵심 파일 구조</a></li>
    <li><a href="#s17">주의사항 및 트러블슈팅</a></li>
  </ol>
</div>

<hr>

<div class="section" id="s1">
<h2>1. 시스템 개요</h2>
<p>탑셀러 주문관리 시스템은 <strong>Solapi(솔라피) API</strong>를 연동하여 3가지 채널의 알림 발송을 지원합니다:</p>
<table>
  <tr><th>채널</th><th>용도</th><th>특징</th></tr>
  <tr><td><strong>알림톡 (Alimtalk)</strong></td><td>회원 대상 카카오톡 알림</td><td>템플릿 기반, 사전 승인 필요</td></tr>
  <tr><td><strong>브랜드톡 (Brandtalk/친구톡)</strong></td><td>회원 대상 마케팅/정보 메시지</td><td>자유 메시지, 카카오 채널 친구 대상</td></tr>
  <tr><td><strong>SMS</strong></td><td>매입업체 대상 문자 발송</td><td>배분 요청 알림 용도</td></tr>
</table>

<h3>인증 방식</h3>
<ul>
  <li><strong>Solapi SDK</strong>: 공식 <code>solapi</code> npm 패키지 사용 (알림톡, SMS)</li>
  <li><strong>REST API 직접 호출</strong>: HMAC-SHA256 인증 (템플릿 조회, 브랜드톡)</li>
</ul>
</div>

<hr>

<div class="section" id="s2">
<h2>2. 환경 설정</h2>
<h3>필수 환경변수 (Secrets)</h3>
<table>
  <tr><th>변수명</th><th>설명</th><th>상태</th></tr>
  <tr><td><code>SOLAPI_API_KEY</code></td><td>Solapi API 키</td><td><span class="badge badge-active">설정됨</span></td></tr>
  <tr><td><code>SOLAPI_API_SECRET</code></td><td>Solapi API 시크릿</td><td><span class="badge badge-active">설정됨</span></td></tr>
  <tr><td><code>SOLAPI_SENDER</code></td><td>발신번호 (예: 1588-xxxx 또는 010-xxxx-xxxx)</td><td><span class="badge badge-active">설정됨</span></td></tr>
  <tr><td><code>KAKAO_PFID</code></td><td>카카오 비즈니스 채널 프로필 ID</td><td><span class="badge badge-active">설정됨</span></td></tr>
</table>

<h3>환경변수 사용처</h3>
<pre><code>SOLAPI_API_KEY    -> SDK 초기화, HMAC 인증 헤더 생성
SOLAPI_API_SECRET -> SDK 초기화, HMAC 서명 생성
SOLAPI_SENDER     -> 알림톡/SMS 발신번호 (from 필드)
KAKAO_PFID        -> 알림톡/브랜드톡 카카오 채널 식별 (pfId 필드)</code></pre>
</div>

<hr>

<div class="section" id="s3">
<h2>3. Solapi SDK 연동 구조</h2>
<h3>파일 위치</h3>
<p><code>server/services/solapi.ts</code></p>

<h3>클래스 구조: SolapiService</h3>
<pre><code>SolapiService (싱글턴 export: solapiService)
+-- constructor()            -> SDK 초기화, 환경변수 로드
+-- generateAuthHeader()     -> HMAC-SHA256 인증 헤더 생성 (REST API용)
+-- sendAlimTalk()           -> 알림톡 단건 발송
+-- sendAlimtalkBulk()       -> 알림톡 대량 발송
+-- sendBrandtalk()          -> 브랜드톡 발송 (SDK)
+-- sendBrandTalkDirect()    -> 브랜드톡 직접 발송 (REST API)
+-- sendSMS()                -> SMS 단건 발송
+-- getTemplateDetail()      -> 솔라피 알림톡 템플릿 상세 조회
+-- getBrandTemplates()      -> 브랜드 템플릿 목록 조회
+-- getBrandTemplateDetail() -> 브랜드 템플릿 상세 조회</code></pre>

<h3>SDK 초기화 로직</h3>
<pre><code>// 서버 시작 시 자동 초기화
if (SOLAPI_API_KEY && SOLAPI_API_SECRET) {
  this.messageService = new SolapiMessageService(apiKey, apiSecret);
  // "Solapi SDK 초기화 완료" 로그 출력
} else {
  // "Solapi API 키가 설정되지 않았습니다" 경고 출력
}</code></pre>

<h3>HMAC-SHA256 인증 방식 상세</h3>
<pre><code>1. date = ISO 8601 형식 현재 시간
2. salt = 32바이트(또는 16바이트) 랜덤 hex
3. hmacData = date + salt (연결)
4. signature = HMAC-SHA256(apiSecret, hmacData) -> hex
5. Authorization: "HMAC-SHA256 apiKey={key}, date={date}, salt={salt}, signature={sig}"</code></pre>
</div>

<hr>

<div class="section" id="s4">
<h2>4. 알림톡 (Alimtalk) 시스템</h2>
<h3>개념</h3>
<ul>
  <li>카카오톡 알림톡은 <strong>사전 등록/승인된 템플릿</strong> 기반으로만 발송 가능</li>
  <li>각 템플릿에는 <strong>솔라피 템플릿 ID</strong> (예: <code>KA01TP...</code>)가 할당됨</li>
  <li>변수 치환을 통해 동적 내용 삽입 가능 (예: <code>#{이름}</code>, <code>#{주문번호}</code>)</li>
</ul>

<h3>발송 흐름</h3>
<h4>알림톡 단건 발송</h4>
<pre><code>sendAlimTalk(templateId, receiverPhone, variables)
  -> sendAlimtalkBulk([{ to, templateId, variables }])
    -> messageService.send([{ to, from, kakaoOptions }])</code></pre>

<h4>알림톡 대량 발송</h4>
<pre><code>sendAlimtalkBulk(params[])
  1. 환경변수 검증 (API키, PFID, 발신번호)
  2. 메시지 배열 구성:
     - to: 수신번호 (하이픈 제거)
     - from: 발신번호 (하이픈 제거)
     - kakaoOptions: { pfId, templateId, variables }
  3. SDK send() 호출
  4. 결과 분석:
     - registeredSuccess = 큐 등록 성공 (발송 예정)
     - registeredFailed = 등록 실패
     - sentSuccess = 실제 발송 완료 (비동기)
  5. SendResult 반환: { successCount, failCount, data }</code></pre>

<h3>수신자 선택 로직</h3>
<ul>
  <li><strong>전체 활성 회원</strong>: <code>status === '활성'</code>인 모든 회원</li>
  <li><strong>등급별 필터링</strong>: <code>targetType === 'grade'</code> + <code>selectedGrades[]</code> 조합</li>
  <li><strong>연락처 수집</strong>: 대표번호 + 담당자1~3 전화번호 모두 수집</li>
  <li><strong>중복 제거</strong>: <code>Set</code>으로 전화번호 중복 자동 제거</li>
</ul>

<h3>모드 구분</h3>
<table>
  <tr><th>모드</th><th>필드</th><th>설명</th></tr>
  <tr><td>자동 (Auto)</td><td><code>isAuto: true</code></td><td>시스템 이벤트 발생 시 자동 발송</td></tr>
  <tr><td>수동 (Manual)</td><td><code>isAuto: false</code></td><td>관리자가 직접 수신자 선택 후 발송</td></tr>
</table>

<h3>ON/OFF 토글</h3>
<ul>
  <li><code>isActive: true/false</code>로 템플릿 활성/비활성 전환</li>
  <li>비활성 템플릿은 자동/수동 모두 발송 불가</li>
</ul>
</div>

<hr>

<div class="section" id="s5">
<h2>5. 브랜드톡 (Brandtalk/친구톡) 시스템</h2>
<h3>개념</h3>
<ul>
  <li>카카오 비즈니스 채널 친구에게 보내는 자유 형식 메시지</li>
  <li>알림톡과 달리 <strong>템플릿 사전 승인 불필요</strong></li>
  <li>정보성(I), 마케팅(M), 무분류(N) 유형으로 구분</li>
</ul>

<h3>발송 메시지 구조 (SDK 방식)</h3>
<pre><code>{
  to: 수신번호,
  from: 발신번호,
  kakaoOptions: {
    pfId: 카카오 채널 ID,
    bms: {
      targeting: 'I',           // 정보성
      chatBubbleType: 'TEXT',   // 텍스트형
      content: 메시지 내용,
      buttons: [{ linkType: 'WL', name, linkMobile, linkPc }]
    }
  }
}</code></pre>

<h3>REST API 방식 (sendBrandTalkDirect)</h3>
<ul>
  <li><code>POST https://api.solapi.com/messages/v4/send-many</code></li>
  <li>HMAC-SHA256 인증 헤더 사용</li>
  <li>템플릿 없이 직접 메시지 구성</li>
</ul>

<h3>프론트엔드 페이지</h3>
<ul>
  <li>경로: <code>/admin/kakao-notifications/brandtalk</code></li>
  <li>메뉴명: "친구톡 관리"</li>
  <li>현재 기본 구조만 구현 (60줄)</li>
</ul>
</div>

<hr>

<div class="section" id="s6">
<h2>6. SMS 발송 시스템</h2>
<h3>용도</h3>
<p><strong>매입업체(Vendor) 배분 알림</strong> 전용. 카카오톡 기반이 아닌 일반 문자 메시지.</p>

<h3>발송 메서드</h3>
<pre><code>sendSMS(to: string, text: string): Promise&lt;SendResult&gt;

// SDK 사용:
messageService.send([{ to, from: sender, text }])</code></pre>

<h3>호출 시점</h3>
<ul>
  <li>관리자가 배분(Allocation) 요청 시 매입업체에 자동 발송</li>
  <li>추가 배분 요청 시에도 발송</li>
</ul>

<h3>메시지 형식 예시</h3>
<pre><code>[탑셀러] 배분 요청
상품: {상품명}
요청수량: {수량}박스
매입가: {가격}원
마감시간: {시간}
대시보드에서 가능수량을 입력해 주세요.</code></pre>
</div>

<hr>

<div class="section" id="s7">
<h2>7. 데이터베이스 스키마</h2>

<h3>alimtalk_templates (알림톡 템플릿)</h3>
<table>
  <tr><th>컬럼</th><th>타입</th><th>설명</th></tr>
  <tr><td>id</td><td>serial (PK)</td><td>자동 증가 ID</td></tr>
  <tr><td>template_code</td><td>text (UNIQUE)</td><td>시스템 내부 코드 (예: SHIPPING, WELCOME)</td></tr>
  <tr><td>template_id</td><td>text (UNIQUE)</td><td>솔라피 템플릿 ID (예: KA01TP...)</td></tr>
  <tr><td>template_name</td><td>text</td><td>템플릿 표시명</td></tr>
  <tr><td>description</td><td>text</td><td>설명</td></tr>
  <tr><td>is_auto</td><td>boolean</td><td>자동 발송 여부 (default: false)</td></tr>
  <tr><td>is_active</td><td>boolean</td><td>활성 여부 (default: true)</td></tr>
  <tr><td>total_sent</td><td>integer</td><td>누적 발송 수 (default: 0)</td></tr>
  <tr><td>total_cost</td><td>integer</td><td>누적 비용 (default: 0)</td></tr>
  <tr><td>created_at</td><td>timestamp</td><td>생성일시</td></tr>
  <tr><td>updated_at</td><td>timestamp</td><td>수정일시</td></tr>
</table>

<h3>alimtalk_history (알림톡 발송 이력)</h3>
<table>
  <tr><th>컬럼</th><th>타입</th><th>설명</th></tr>
  <tr><td>id</td><td>serial (PK)</td><td>자동 증가 ID</td></tr>
  <tr><td>template_id</td><td>integer (FK)</td><td>알림톡 템플릿 ID</td></tr>
  <tr><td>recipient_count</td><td>integer</td><td>수신자 수</td></tr>
  <tr><td>success_count</td><td>integer</td><td>성공 건수</td></tr>
  <tr><td>fail_count</td><td>integer</td><td>실패 건수</td></tr>
  <tr><td>cost</td><td>integer</td><td>비용 (원)</td></tr>
  <tr><td>sent_by</td><td>varchar (FK)</td><td>발송자 (users.id)</td></tr>
  <tr><td>sent_at</td><td>timestamp</td><td>발송일시</td></tr>
  <tr><td>response_data</td><td>jsonb</td><td>솔라피 API 응답 데이터</td></tr>
</table>

<h3>brandtalk_templates (브랜드톡 템플릿)</h3>
<table>
  <tr><th>컬럼</th><th>타입</th><th>설명</th></tr>
  <tr><td>id</td><td>serial (PK)</td><td>자동 증가 ID</td></tr>
  <tr><td>title</td><td>text</td><td>제목</td></tr>
  <tr><td>message</td><td>text</td><td>메시지 내용</td></tr>
  <tr><td>button_name</td><td>text</td><td>버튼명</td></tr>
  <tr><td>button_url</td><td>text</td><td>버튼 URL</td></tr>
  <tr><td>total_sent</td><td>integer</td><td>누적 발송 수</td></tr>
  <tr><td>last_sent_at</td><td>timestamp</td><td>마지막 발송일시</td></tr>
  <tr><td>created_by</td><td>varchar (FK)</td><td>생성자 (users.id)</td></tr>
  <tr><td>created_at</td><td>timestamp</td><td>생성일시</td></tr>
  <tr><td>updated_at</td><td>timestamp</td><td>수정일시</td></tr>
</table>

<h3>brandtalk_history (브랜드톡 발송 이력)</h3>
<table>
  <tr><th>컬럼</th><th>타입</th><th>설명</th></tr>
  <tr><td>id</td><td>serial (PK)</td><td>자동 증가 ID</td></tr>
  <tr><td>template_id</td><td>integer (FK)</td><td>브랜드톡 템플릿 ID</td></tr>
  <tr><td>title</td><td>text</td><td>제목</td></tr>
  <tr><td>message</td><td>text</td><td>메시지 내용</td></tr>
  <tr><td>recipient_count</td><td>integer</td><td>수신자 수</td></tr>
  <tr><td>success_count</td><td>integer</td><td>성공 건수</td></tr>
  <tr><td>fail_count</td><td>integer</td><td>실패 건수</td></tr>
  <tr><td>cost</td><td>integer</td><td>비용 (원)</td></tr>
  <tr><td>sent_by</td><td>varchar (FK)</td><td>발송자 (users.id)</td></tr>
  <tr><td>sent_at</td><td>timestamp</td><td>발송일시</td></tr>
  <tr><td>response_data</td><td>jsonb</td><td>솔라피 API 응답 데이터</td></tr>
</table>
</div>

<hr>

<div class="section" id="s8">
<h2>8. API 엔드포인트 목록</h2>
<h3>알림톡 관리 API (관리자 전용)</h3>
<table>
  <tr><th>메서드</th><th>경로</th><th>설명</th></tr>
  <tr><td>GET</td><td><code>/api/admin/alimtalk/templates</code></td><td>템플릿 목록 조회</td></tr>
  <tr><td>POST</td><td><code>/api/admin/alimtalk/templates</code></td><td>템플릿 신규 등록</td></tr>
  <tr><td>GET</td><td><code>/api/admin/alimtalk/templates/:id/detail</code></td><td>템플릿 상세 조회 (DB)</td></tr>
  <tr><td>PUT</td><td><code>/api/admin/alimtalk/templates/:id</code></td><td>템플릿 수정</td></tr>
  <tr><td>PATCH</td><td><code>/api/admin/alimtalk/templates/:id</code></td><td>템플릿 ON/OFF 토글</td></tr>
  <tr><td>PATCH</td><td><code>/api/admin/alimtalk/templates/:id/mode</code></td><td>자동/수동 모드 변경</td></tr>
  <tr><td>DELETE</td><td><code>/api/admin/alimtalk/templates/:id</code></td><td>템플릿 삭제</td></tr>
  <tr><td>GET</td><td><code>/api/admin/alimtalk/statistics</code></td><td>전체 통계 조회</td></tr>
  <tr><td>GET</td><td><code>/api/admin/alimtalk/history</code></td><td>발송 이력 조회</td></tr>
  <tr><td>GET</td><td><code>/api/admin/alimtalk/recipients</code></td><td>수신자 목록 조회</td></tr>
  <tr><td>POST</td><td><code>/api/admin/alimtalk/send/:code</code></td><td>수동 발송</td></tr>
  <tr><td>POST</td><td><code>/api/admin/alimtalk/test/:code</code></td><td>테스트 발송</td></tr>
</table>
<h3>인증 요구사항</h3>
<ul>
  <li>모든 API: <code>req.session.userId</code> 필수</li>
  <li>권한: <code>SUPER_ADMIN</code> 또는 <code>ADMIN</code> 역할 필요</li>
</ul>
</div>

<hr>

<div class="section" id="s9">
<h2>9. 프론트엔드 페이지</h2>
<h3>라우팅 구조</h3>
<table>
  <tr><th>경로</th><th>컴포넌트</th><th>메뉴 위치</th></tr>
  <tr><td><code>/admin/kakao-notifications/alimtalk</code></td><td>AlimtalkPage</td><td>관리자 > 카카오 알림 > 알림톡(고정)</td></tr>
  <tr><td><code>/admin/kakao-notifications/brandtalk</code></td><td>BrandtalkPage</td><td>관리자 > 카카오 알림 > 친구톡 관리</td></tr>
</table>

<h3>알림톡 관리 페이지 기능 (1,078줄)</h3>
<ol>
  <li><strong>템플릿 목록</strong>: 전체 템플릿 카드 그리드 표시</li>
  <li><strong>ON/OFF 토글</strong>: 스위치로 활성/비활성 전환</li>
  <li><strong>자동/수동 모드</strong>: 토글 스위치로 모드 전환</li>
  <li><strong>템플릿 상세 보기</strong>: 다이얼로그에서 상세 정보 확인</li>
  <li><strong>템플릿 수정</strong>: 인라인 편집</li>
  <li><strong>템플릿 등록</strong>: 새 템플릿 추가 다이얼로그</li>
  <li><strong>템플릿 삭제</strong>: 확인 후 삭제</li>
  <li><strong>테스트 발송</strong>: 특정 번호로 테스트 발송</li>
  <li><strong>수동 발송</strong>: 수신자 선택 후 발송</li>
  <li><strong>발송 이력</strong>: 최근 발송 기록 목록</li>
  <li><strong>통계 대시보드</strong>: 전체 발송 통계 카드</li>
</ol>

<h3>브랜드톡 관리 페이지 (60줄)</h3>
<p>기본 레이아웃만 구현됨. 추후 확장 예정.</p>
</div>

<hr>

<div class="section" id="s10">
<h2>10. 등록된 템플릿 목록</h2>
<p>현재 DB에 등록된 알림톡 템플릿 (12개):</p>

<h3>자동 발송 (<span class="badge badge-auto">isAuto: true</span>) - 6개</h3>
<table>
  <tr><th>코드</th><th>이름</th><th>설명</th></tr>
  <tr><td><code>SHIPPING</code></td><td>배송중 알림</td><td>배송 출발 시 자동 발송</td></tr>
  <tr><td><code>ORDER_PREPARE</code></td><td>운송장 등록 알림</td><td>상품 준비 완료 시 자동 발송</td></tr>
  <tr><td><code>WELCOME</code></td><td>회원가입 환영 인사</td><td>신규 회원 환영 메시지</td></tr>
  <tr><td><code>ORDER_DEADLINE_9AM</code></td><td>9시 주문마감 알림</td><td>9시 주문 마감 알림</td></tr>
  <tr><td><code>ORDER_DEADLINE_10AM</code></td><td>10시 주문마감 알림</td><td>10시 주문 마감 알림</td></tr>
  <tr><td><code>MEMBER_CANCEL_ALT</code></td><td>회원취소 마감 알림(대체)</td><td>회원 취소 마감 대체 템플릿</td></tr>
</table>

<h3>수동 발송 (<span class="badge badge-manual">isAuto: false</span>) - 6개</h3>
<table>
  <tr><th>코드</th><th>이름</th><th>설명</th><th>누적발송</th></tr>
  <tr><td><code>ORDER_DEADLINE_10MIN</code></td><td>주문 마감 10분전 알림</td><td>마감 10분 전 발송</td><td>1건</td></tr>
  <tr><td><code>WAYBILL_DOWNLOAD</code></td><td>운송장 다운로드 마감 안내</td><td>운송장 안내</td><td>1건</td></tr>
  <tr><td><code>MEMBER_CANCEL</code></td><td>회원취소 마감 알림</td><td>취소 마감 알림</td><td>1건</td></tr>
  <tr><td><code>MEMBER_CANCEL_10MIN</code></td><td>회원취소 마감10분전 알림</td><td>취소 10분 전</td><td>0건</td></tr>
  <tr><td><code>MEMBER_CANCEL_10MIN_ALT</code></td><td>회원취소 마감10분전(대체)</td><td>취소 10분전 대체</td><td>0건</td></tr>
  <tr><td><code>FORCE_CANCEL</code></td><td>직권 취소 알림</td><td>관리자 직권 취소</td><td>0건</td></tr>
</table>
</div>

<hr>

<div class="section" id="s11">
<h2>11. 자동 발송 시나리오</h2>
<p><code>isAuto: true</code>인 템플릿은 시스템 이벤트 발생 시 자동으로 발송됩니다.</p>

<h4>시나리오 1: 배송중 전환 알림 (SHIPPING)</h4>
<pre><code>트리거: 주문 상태가 "배송중"으로 전환될 때
수신자: 해당 주문의 회원 연락처
내용: 배송 출발 안내</code></pre>

<h4>시나리오 2: 운송장 등록 알림 (ORDER_PREPARE)</h4>
<pre><code>트리거: 상품준비중 단계에서 운송장 정보 등록 시
수신자: 해당 주문의 회원 연락처
내용: 상품 준비 완료 안내</code></pre>

<h4>시나리오 3: 회원가입 환영 (WELCOME)</h4>
<pre><code>트리거: 신규 회원 가입 승인 시
수신자: 신규 회원 연락처
내용: 회원가입 환영 메시지</code></pre>

<h4>시나리오 4: 주문 마감 알림 (ORDER_DEADLINE_9AM, ORDER_DEADLINE_10AM)</h4>
<pre><code>트리거: 자동 발송 모드일 경우, 해당 시간에 자동 발송
수신자: 활성 회원 전체
내용: 주문 마감 안내</code></pre>

<h4>시나리오 5: 회원취소 마감 알림 대체 (MEMBER_CANCEL_ALT)</h4>
<pre><code>트리거: 자동 발송 모드일 경우
수신자: 활성 회원
내용: 회원 주문 취소 마감 안내</code></pre>
</div>

<hr>

<div class="section" id="s12">
<h2>12. 수동 발송 시나리오</h2>
<h3>발송 프로세스</h3>
<pre><code>1. 관리자 로그인
2. 카카오 알림 > 알림톡(고정) 페이지 진입
3. 수동 템플릿 선택
4. "발송" 버튼 클릭
5. 수신자 타입 선택:
   - 전체: 모든 활성 회원
   - 등급별: START, DRIVING, TOP 중 선택
6. 변수 입력 (템플릿에 따라)
7. 발송 실행
8. 결과 확인 (성공/실패 건수, 비용)</code></pre>

<h3>수신자 수집 로직</h3>
<pre><code>활성 회원 필터링 (status === '활성')
  -> 등급 필터 적용 (선택 시)
  -> 각 회원의 연락처 수집:
    - member.phone (대표번호)
    - member.managerPhone (담당자1)
    - member.manager2Phone (담당자2)
    - member.manager3Phone (담당자3)
  -> 하이픈 제거
  -> Set으로 중복 제거
  -> 발송 대상 확정</code></pre>

<h3>테스트 발송</h3>
<pre><code>1. 템플릿 카드에서 "테스트" 버튼 클릭
2. 수신 번호 입력 (직접 입력)
3. 발송 실행
4. 결과 확인

주의: SOLAPI_SENDER가 대표번호(1588-xxxx)인 경우,
      대표번호로는 알림톡 수신 불가
      -> 개인 휴대폰 번호로 테스트</code></pre>
</div>

<hr>

<div class="section" id="s13">
<h2>13. 매입업체 배분 알림 (SMS)</h2>
<h3>발송 시점</h3>
<p>매입업체(Vendor)에 대한 주문 배분(Allocation) 시 SMS 자동 발송</p>

<h4>시나리오 1: 초기 배분 알림</h4>
<pre><code>트리거: POST /api/admin/allocations/:allocationId/notify
동작:
  1. 배분 대상 업체별 반복
  2. vendor.contactPhone 존재 시 SMS 발송
  3. solapiService.sendSMS(vendor.contactPhone, message)
  4. 발송 결과를 notifiedVendors에 기록</code></pre>

<h4>시나리오 2: 추가 배분 알림</h4>
<pre><code>트리거: POST /api/admin/allocations/:allocationId/notify-additional
동작: 초기 배분과 동일한 로직
메시지: "[탑셀러] 추가 배분 요청" 제목으로 구분</code></pre>

<h3>SMS 메시지 구조</h3>
<pre><code>[탑셀러] 배분 요청
상품: {allocation.productName}
요청수량: {requestedQuantity}박스
매입가: {vendorPrice}원 (또는 "미정")
마감시간: {deadline}
대시보드에서 가능수량을 입력해 주세요.</code></pre>

<h3>에러 처리</h3>
<ul>
  <li>SMS 발송 실패 시 콘솔 에러 로그만 남기고 프로세스 계속 진행</li>
  <li><code>kakaoSent: boolean</code> 플래그로 발송 성공 여부 추적</li>
</ul>
</div>

<hr>

<div class="section" id="s14">
<h2>14. 발송 이력 및 통계</h2>
<h3>이력 저장 (알림톡)</h3>
<p>수동 발송 완료 후 자동 기록:</p>
<pre><code>alimtalk_history 레코드 생성:
  - templateId: 사용된 템플릿 ID
  - recipientCount: 수신자 수
  - successCount: 성공 건수
  - failCount: 실패 건수
  - cost: successCount * 13 (원)
  - sentBy: 발송한 관리자 ID
  - responseData: Solapi API 전체 응답 (JSON)</code></pre>

<h3>템플릿 통계 업데이트</h3>
<pre><code>발송 완료 시 alimtalk_templates 업데이트:
  - totalSent += successCount
  - totalCost += cost
  - updatedAt = 현재 시간</code></pre>

<h3>통계 API 응답 구조</h3>
<pre><code>{
  "totalTemplates": 12,       // 전체 템플릿 수
  "autoTemplates": 6,         // 자동 템플릿 수
  "manualTemplates": 6,       // 수동 템플릿 수
  "totalSent": 3,             // 이번 달 총 발송 수
  "totalCost": 39,            // 이번 달 총 비용 (원)
  "monthlySent": 0,           // 이번 달 이력 기반 발송 수
  "monthlyCost": 0            // 이번 달 이력 기반 비용
}</code></pre>
</div>

<hr>

<div class="section" id="s15">
<h2>15. 비용 구조</h2>
<table>
  <tr><th>채널</th><th>건당 비용</th><th>비고</th></tr>
  <tr><td>알림톡</td><td>13원</td><td>Solapi 기준</td></tr>
  <tr><td>브랜드톡</td><td>별도</td><td>마케팅/정보성에 따라 다름</td></tr>
  <tr><td>SMS</td><td>별도</td><td>단문/장문에 따라 다름</td></tr>
</table>
<h3>비용 계산 로직</h3>
<pre><code>const cost = result.successCount * 13; // 알림톡 건당 13원</code></pre>
</div>

<hr>

<div class="section" id="s16">
<h2>16. 핵심 파일 구조</h2>
<pre><code>프로젝트/
+-- server/
|   +-- services/
|   |   +-- solapi.ts              &lt;- Solapi SDK 서비스 (593줄)
|   +-- routes.ts                  &lt;- API 엔드포인트 (알림톡 12개 + SMS 2곳)
+-- shared/
|   +-- schema.ts                  &lt;- DB 스키마 (4개 테이블)
+-- client/src/
    +-- App.tsx                    &lt;- 라우팅 등록
    +-- pages/
    |   +-- admin/
    |       +-- admin-layout.tsx   &lt;- 사이드바 메뉴 (카카오 알림)
    |       +-- kakao-notifications/
    |           +-- alimtalk.tsx   &lt;- 알림톡 관리 페이지 (1,078줄)
    |           +-- brandtalk.tsx  &lt;- 브랜드톡 관리 페이지 (60줄)
    +-- components/
        +-- admin/
            +-- allocation-section.tsx  &lt;- 배분 알림 (SMS 호출 UI)</code></pre>
</div>

<hr>

<div class="section" id="s17">
<h2>17. 주의사항 및 트러블슈팅</h2>

<h4>1. 발신번호 관련</h4>
<ul>
  <li><code>SOLAPI_SENDER</code>가 대표번호(1588-xxxx)인 경우 알림톡 <strong>수신</strong> 불가</li>
  <li>테스트 시 반드시 카카오톡이 설치된 개인 휴대폰 번호 사용</li>
  <li>발신번호는 사전에 Solapi에서 등록/인증 필요</li>
</ul>

<h4>2. 솔라피 응답 해석</h4>
<ul>
  <li><code>registeredSuccess</code>: 메시지가 큐에 등록됨 (성공 지표)</li>
  <li><code>sentSuccess</code>: 실제 발송 완료 (비동기, 즉시 조회 시 0일 수 있음)</li>
  <li><code>registeredFailed</code>: 등록 실패 (형식 오류, API 오류)</li>
  <li>발송 직후에는 <code>registeredSuccess</code>를 기준으로 성공 판단</li>
</ul>

<h4>3. 템플릿 ID</h4>
<ul>
  <li>솔라피 콘솔에서 발급받은 ID 그대로 사용</li>
  <li>형식: <code>KA01TP</code> + 날짜/시간/랜덤 문자열</li>
  <li>잘못된 템플릿 ID 사용 시 발송 실패</li>
</ul>

<h4>4. KAKAO_PFID</h4>
<ul>
  <li>카카오 비즈니스 채널의 프로필 ID</li>
  <li>채널에 등록된 템플릿만 발송 가능</li>
</ul>

<h4>5. 전화번호 형식</h4>
<ul>
  <li>내부적으로 하이픈 자동 제거: <code>010-1234-5678</code> -> <code>01012345678</code></li>
  <li>하이픈 포함/미포함 모두 입력 가능</li>
</ul>

<h4>6. 중복 발송 방지</h4>
<ul>
  <li>수신자 목록에서 <code>Set</code>으로 전화번호 중복 제거</li>
  <li>같은 회원의 대표번호와 담당자 번호가 동일하면 1건만 발송</li>
</ul>

<h4>7. SMS 발송 실패 처리</h4>
<ul>
  <li>SMS 발송 실패 시 에러를 catch하고 로그만 남김</li>
  <li>배분 프로세스 자체는 중단되지 않음 (비핵심 기능)</li>
</ul>

<h4>8. 비활성 템플릿</h4>
<ul>
  <li><code>isActive: false</code>인 템플릿으로 발송 시도 시 400 에러 반환</li>
  <li>자동 발송도 비활성 체크 후 스킵</li>
</ul>
</div>

<hr>

<div class="section">
<h2>부록: Solapi SDK 설치 정보</h2>
<pre><code>패키지: solapi
설치: npm install solapi
공식 문서: https://docs.solapi.com

핵심 클래스:
import { SolapiMessageService } from 'solapi';
const messageService = new SolapiMessageService(apiKey, apiSecret);</code></pre>
</div>

<p style="text-align:center;color:#94a3b8;margin:32px 0;font-size:13px">
  이 문서는 탑셀러 주문관리 시스템의 알림 시스템 전체 현황을 정리한 것입니다.<br>
  최종 업데이트: 2026-02-19
</p>

</div>

<script>
function downloadMD() {
  fetch('/notification-system-docs.md')
    .then(r => r.blob())
    .then(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '알림시스템_종합문서.md';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    })
    .catch(() => {
      const content = document.querySelector('.container').innerText;
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '알림시스템_종합문서.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
}
</script>
</body>
</html>
