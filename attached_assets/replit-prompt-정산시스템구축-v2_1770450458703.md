⚠️ 모든 작업 보고와 설명을 반드시 한글(한국어)로 작성하세요. 영어 사용 금지.

# 작업 지시서: 정산 시스템 구축 (1단계 - 기본 정산)

## 📋 작업 개요

예치금과 포인터를 활용한 기본 정산 시스템을 구축합니다.
현재 DB에 잔액 컬럼은 존재하지만 사용되지 않고 있으므로, 이를 활성화하고 정산 로직을 전체적으로 구현합니다.

**후불결제, 행사 특가(쿠폰) 정산은 이번 작업에 포함하지 않습니다.**

---

## ⚠️ 예치금 vs 포인터 개념 (반드시 숙지)

| 구분 | 예치금 (Deposit) | 포인터 (Point) |
|------|-----------------|---------------|
| **지급 주체** | 회원이 직접 입금하여 충전 | 관리자(탑셀러)가 지급 |
| **현금 환급** | ✅ 가능 | ❌ 불가 |
| **소멸** | 소멸 없음 (환급 가능) | 거래 종료/탈퇴/장기 미사용 시 소멸 |
| **용도** | 상품 주문 결제 | 상품 주문 결제 (이벤트, CS환불, 프로모션 등) |
| **차감 우선순위** | 2순위 (포인터 다음) | 1순위 (먼저 차감) |

---

## 🎯 구현 대상 (총 5개 영역)

---

### 영역 1: DB 스키마 확인 및 정비

**1-1. 기존 members 테이블 잔액 컬럼 확인**

현재 members 테이블에 예치금/포인터 관련 컬럼이 있는지 확인:
```
예상 컬럼 (실제 확인 필요):
- deposit 또는 balance (예치금 잔액)
- points 또는 pointer (포인터 잔액)
```
- 컬럼이 있으면 그대로 활용
- 없거나 부족하면 추가

**1-2. 정산 이력 테이블 생성**

```sql
-- settlement_history (정산 이력)
-- 배송중 전환 시 자동 차감된 기록
id                  -- PK
member_id           -- 회원 ID (members 참조)
order_id            -- 주문 ID (pending_orders 참조)
settlement_type     -- 정산 유형: 'auto' (배송중 전환 자동), 'manual' (수동 조정)
pointer_amount      -- 포인터 차감 금액
deposit_amount      -- 예치금 차감 금액
total_amount        -- 총 정산 금액 (pointer_amount + deposit_amount)
pointer_balance     -- 정산 후 포인터 잔액
deposit_balance     -- 정산 후 예치금 잔액
description         -- 설명
created_at          -- 정산 일시
```

**1-3. 예치금 변동 이력 테이블 생성**

```sql
-- deposit_history (예치금 변동 이력)
id                  -- PK
member_id           -- 회원 ID
type                -- 유형: 'charge' (충전), 'deduct' (차감/정산), 'refund' (환급)
amount              -- 변동 금액 (양수로 저장, type으로 구분)
balance_after       -- 변동 후 잔액
description         -- 설명
admin_id            -- 처리한 관리자 ID (수동 충전/환급 시)
created_at          -- 변동 일시
```

**1-4. 포인터 변동 이력 테이블 생성**

```sql
-- pointer_history (포인터 변동 이력)
id                  -- PK
member_id           -- 회원 ID
type                -- 유형: 'grant' (지급), 'deduct' (차감/정산), 'expire' (소멸)
amount              -- 변동 금액
balance_after       -- 변동 후 잔액
description         -- 설명
admin_id            -- 처리한 관리자 ID (지급 시)
created_at          -- 변동 일시
```

---

### 영역 2: 주문 등록 시 잔액 검증 (기존 검증 체계에 통합)

⚠️ **매우 중요: 현재 주문 등록에는 이미 다단계 검증 체계가 있습니다. 잔액 검증을 기존 검증 흐름에 자연스럽게 추가해야 하며, 기존 검증 로직을 절대 변경하거나 손상시키면 안 됩니다.**

#### 현재 검증 흐름에 잔액 검증 삽입 위치

**[프론트엔드 검증 - 기존 ① ~ ④ 유지 + 잔액 표시 추가]**

| 순서 | 체크 항목 | 상태 |
|------|----------|------|
| ① | 회원 등급 체크 (PENDING, ASSOCIATE 차단) | 기존 유지 |
| ② | 버튼 비활성화 (canOrder=false) | 기존 유지 |
| ③ | 주문 등록 다이얼로그 차단 | 기존 유지 |
| ④ | 양식 다운로드 실패 | 기존 유지 |
| **⑤ 추가** | **사용 가능 잔액 표시** | **🆕 신규** |

**프론트엔드 추가 사항 (⑤):**
- 주문 등록 화면 상단에 **잔액 정보 배너** 항상 표시:
```
┌─────────────────────────────────────────────────────────────┐
│ 💰 사용 가능 잔액                                            │
│                                                             │
│   예치금: 100,000원  +  포인터: 30,000원  =  합계: 130,000원   │
│   (진행 중 주문 예상 금액: 50,000원)                           │
│   ✅ 사용 가능 잔액: 80,000원                                 │
│                                                             │
│   [예치금 충전하기]                                           │
└─────────────────────────────────────────────────────────────┘
```

---

**[개별 주문 등록 API - 기존 ① ~ ⑥ 유지 + 잔액 검증 추가]**

| 순서 | 체크 항목 | 상태 |
|------|----------|------|
| ① | 로그인 확인 | 기존 유지 |
| ② | 회원 존재 확인 | 기존 유지 |
| ③ | 등급 검증 (PENDING/ASSOCIATE) | 기존 유지 |
| ④ | 입력값 검증 (Zod 스키마) | 기존 유지 |
| ⑤ | 상품 존재 확인 | 기존 유지 |
| **⑤-1 추가** | **잔액 검증** | **🆕 신규** |
| ⑥ | 순번 생성 | 기존 유지 |

**⑤-1 잔액 검증 상세:**
```
1. 주문 금액 계산
   = 해당 상품의 회원등급별 공급가(current_products) × 수량

2. 사용 가능 잔액 계산
   = (예치금 + 포인터) - (대기~배송준비중 진행 중 주문 총액)

3. 검증
   - 사용 가능 잔액 ≥ 주문 금액 → 통과
   - 사용 가능 잔액 < 주문 금액 → 차단

4. 에러 응답 (400):
   "잔액이 부족합니다. 주문금액: ○○원, 사용가능잔액: ○○원 (예치금 ○○원 + 포인터 ○○원 - 진행중주문 ○○원), 부족금액: ○○원. 예치금을 충전 후 다시 시도해주세요."
```

---

**[엑셀 일괄 업로드 API - 기존 ① ~ ⑪ 유지 + 잔액 검증 추가]**

| 순서 | 체크 항목 | 상태 |
|------|----------|------|
| ① | 로그인 확인 | 기존 유지 |
| ② | 파일 존재 확인 | 기존 유지 |
| ③ | 우체국 양식 권한 | 기존 유지 |
| ④ | 데이터 존재 확인 | 기존 유지 |
| ⑤ | 회원 존재 확인 | 기존 유지 |
| ⑥ | 등급 검증 | 기존 유지 |
| ⑦ | 중복 파일 감지 (SHA-256) | 기존 유지 |
| ⑧ | 필수 필드 누락 체크 | 기존 유지 |
| ⑨ | 상품 존재 확인 | 기존 유지 |
| ⑩ | 공급중지 상품 체크 | 기존 유지 |
| **⑩-1 추가** | **잔액 검증 (전체 주문 합계)** | **🆕 신규** |
| ⑪ | 주소 검증 | 기존 유지 |

**⑩-1 잔액 검증 상세 (엑셀 일괄):**

```
1. 엑셀 내 전체 정상건(⑧~⑩ 통과한 건)의 총 주문 금액 계산
   = Σ (각 행의 상품 회원등급별 공급가 × 수량)

2. 사용 가능 잔액 계산
   = (예치금 + 포인터) - (기존 진행 중 주문 총액)

3. 검증 결과에 따른 처리:
```

**잔액 검증 결과 3가지 시나리오:**

```
[시나리오 A: 전체 등록 가능]
사용 가능 잔액 ≥ 전체 정상건 주문 총액
→ 전체 정상건 등록 진행 (기존 흐름대로)

[시나리오 B: 일부만 등록 가능 (잔액 부족)]
사용 가능 잔액 < 전체 정상건 주문 총액
→ 잔액 부족 알림 표시 + 등록 차단
→ 기존 "정상건만 등록" 방식처럼 부분 등록을 허용하지 않음
→ 잔액이 충분해야만 전체 등록 가능

[시나리오 C: 전혀 등록 불가]
사용 가능 잔액 = 0 또는 매우 부족
→ 잔액 부족 알림 + 등록 차단
```

---

#### 잔액 부족 시 알림 UI 디자인

**기존 알림 체계와 통일된 디자인으로 구현합니다.**

**토스트 알림 (간단한 경우):**
```
🔴 잔액 부족 - 주문 등록 불가
   주문 총액: 250,000원
   사용 가능 잔액: 80,000원
   부족 금액: 170,000원
   예치금을 충전 후 다시 시도해주세요.
```

**다이얼로그 알림 (엑셀 업로드 시 - 상세 정보 표시):**
```
┌─────────────────────────────────────────────────┐
│  ⚠️  잔액 부족으로 주문 등록이 불가합니다          │
│                                                 │
│  📊 주문 내역                                    │
│  ├ 전체 업로드 건수: 25건                         │
│  ├ 검증 오류 건수: 3건                           │
│  ├ 정상건 수: 22건                               │
│  └ 정상건 주문 총액: 350,000원                    │
│                                                 │
│  💰 잔액 현황                                    │
│  ├ 예치금: 100,000원                             │
│  ├ 포인터: 30,000원                              │
│  ├ 진행 중 주문: -50,000원                        │
│  ├ 사용 가능 잔액: 80,000원                       │
│  └ 🔴 부족 금액: 270,000원                       │
│                                                 │
│  [예치금 충전하기]              [닫기]             │
└─────────────────────────────────────────────────┘
```

**"예치금 충전하기" 버튼:**
- 클릭 시 예치금 충전 안내 페이지/모달로 이동
- 입금 계좌 정보(농협 대표 통장) 표시

---

#### 기존 검증 결과 처리 흐름 + 잔액 검증 통합

| 상황 | 프론트엔드 처리 | 변경 여부 |
|------|---------------|----------|
| 중복 파일 감지 | 이전 업로드 정보 표시 → "계속 진행"/"취소" 선택 | 기존 유지 |
| 검증 오류 있음 (confirmPartial 미설정) | 오류 목록 표시 → "정상건만 등록"/"취소" 선택 | 기존 유지 |
| **잔액 부족 (정상건 기준)** | **잔액 부족 다이얼로그 표시 → "예치금 충전하기"/"닫기"** | **🆕 신규** |
| 정상건만 등록 완료 (일부 오류) | 토스트 + 오류건 엑셀 자동 다운로드 | 기존 유지 |
| 전체 성공 | 토스트: "주문 등록 완료 - ○건" | 기존 유지 |
| 업로드 실패 | 토스트 (빨간색) | 기존 유지 |

**잔액 검증 타이밍:**
```
엑셀 업로드 → 파일/권한 체크(①~⑥) → 중복 감지(⑦)
→ 행별 검증(⑧~⑩) → ★잔액 검증(⑩-1)★ → 주소 검증(⑪)
→ 결과 표시 → 등록 처리
```

즉, 상품 검증까지 모두 통과한 **정상건의 총액**을 기준으로 잔액을 검증합니다.
상품 오류건은 이미 제외된 상태에서 잔액을 체크하므로, "정상건만 등록"하더라도 잔액이 충분해야 합니다.

---

### 영역 3: 배송중 전환 시 자동 정산 (핵심!)

**배송준비중 → 배송중 전환 API에 정산 로직 추가**

```
[배송중 전환 프로세스]

1. 해당 주문의 정산 금액 계산
   = 회원등급별 공급가 × 수량 (current_products 기준으로 확정, 10원 단위)

2. 차감 우선순위 적용
   ① 포인터 먼저 차감 (있는 만큼)
   ② 부족분은 예치금에서 차감

3. 잔액 업데이트
   - members 테이블의 포인터/예치금 잔액 업데이트

4. 이력 기록
   - settlement_history에 정산 기록 저장
   - pointer_history에 포인터 차감 기록 (차감된 경우)
   - deposit_history에 예치금 차감 기록 (차감된 경우)

5. 가격 확정
   - pending_orders에 확정 가격 저장 (배송중 전환 시점의 가격으로 잠금)

6. 상태 변경
   - pending_orders.status → "배송중"
```

**차감 예시:**

```
예시 1: 포인터로 전액 차감
  주문금액: 50,000원 / 포인터: 80,000원 / 예치금: 100,000원
  → 포인터 50,000원 차감 (잔액 30,000원)
  → 예치금 차감 없음 (잔액 100,000원 유지)

예시 2: 포인터 + 예치금 혼합
  주문금액: 100,000원 / 포인터: 30,000원 / 예치금: 100,000원
  → 포인터 30,000원 차감 (잔액 0원)
  → 예치금 70,000원 차감 (잔액 30,000원)

예시 3: 예치금만 차감
  주문금액: 100,000원 / 포인터: 0원 / 예치금: 150,000원
  → 포인터 차감 없음
  → 예치금 100,000원 차감 (잔액 50,000원)
```

**일괄 배송중 전환 처리:**
- 각 주문별로 순차 처리
- 동일 회원의 주문이 여러 건이면 잔액 순차 차감
- 중간에 잔액 부족 발생 시: 해당 주문부터 전환 실패, 관리자에게 알림
  ```
  ⚠️ 배송중 전환 부분 완료
  성공: 15건 / 실패: 3건
  실패 사유: 회원 "탑셀01" 잔액 부족 (부족금액: 50,000원)
  ```

**트랜잭션 처리:**
```
BEGIN TRANSACTION
  1. 잔액 확인 (SELECT FOR UPDATE - 동시성 제어)
  2. 포인터 차감
  3. 예치금 차감
  4. members 잔액 업데이트
  5. settlement_history 기록
  6. deposit_history / pointer_history 기록
  7. pending_orders 가격 확정 (배송중 시점 가격 잠금)
  8. pending_orders 상태 → "배송중"
COMMIT (모두 성공) 또는 ROLLBACK (하나라도 실패)
```

---

### 영역 4: 관리자 기능

**4-1. 관리자 예치금 수동 충전**

- 위치: 관리자 > 정산관리 또는 회원 상세
- 입력: 회원 선택, 충전 금액, 메모(입금 확인 내용)
- 처리: members.deposit 증가 + deposit_history 기록 (type: 'charge')
- UI: 충전 후 즉시 잔액 반영 확인

**4-2. 관리자 포인터 지급**

- 위치: 관리자 > 정산관리 또는 회원 상세
- 입력: 회원 선택, 지급 금액, 지급 사유(이벤트/CS환불/프로모션)
- 처리: members.points 증가 + pointer_history 기록 (type: 'grant')

**4-3. 관리자 예치금 환급 처리**

- 위치: 관리자 > 정산관리
- 입력: 회원 선택, 환급 금액, 메모
- 검증: 환급 금액 ≤ 현재 예치금 잔액
- 처리: members.deposit 감소 + deposit_history 기록 (type: 'refund')

**4-4. 정산관리 페이지 (/admin/settlements) 구현**

현재 "준비 중"인 페이지를 신규 구현:

```
[정산관리 페이지 구성]

상단: 정산 현황 요약 카드
  ├ 오늘 정산 건수 / 총 정산 금액
  ├ 이번 달 정산 건수 / 총 정산 금액
  └ 날짜 필터 (DateRangeFilter 컴포넌트 재사용)

탭 1: 예치금 관리
  ├ 회원별 예치금 잔액 목록 (테이블)
  ├ [충전] [환급] 버튼
  └ 예치금 변동 이력 (deposit_history)

탭 2: 포인터 관리
  ├ 회원별 포인터 잔액 목록 (테이블)
  ├ [지급] 버튼
  └ 포인터 변동 이력 (pointer_history)

탭 3: 정산 이력
  ├ 전체 정산 이력 (settlement_history)
  ├ 회원별 필터, 날짜 필터
  └ 엑셀 다운로드

공통: 모든 테이블에 기존 DateRangeFilter 적용 (기본: 오늘)
```

---

### 영역 5: 회원 기능

**5-1. 대시보드 잔액 표시 연동**

현재 회원 대시보드 "현재 예치금, 포인터 현황" 섹션:
- 예치금: members 테이블의 실제 예치금 잔액 표시
- 포인터: members 테이블의 실제 포인터 잔액 표시
- "예치금 충전하기" 버튼: 충전 안내 모달/페이지로 연결

**5-2. 주문 등록 화면 잔액 배너**

영역 2에서 설명한 잔액 정보 배너를 주문 등록 화면에 표시

**5-3. 예치금 충전 안내**

"예치금 충전하기" 버튼 클릭 시:
```
┌─────────────────────────────────────────────────┐
│  💳 예치금 충전 안내                               │
│                                                 │
│  아래 계좌로 입금해 주시면 확인 후 충전됩니다.        │
│                                                 │
│  🏦 입금 계좌: 농협 xxx-xxxx-xxxx-xx              │
│  📝 예금주: 현 농업회사법인 주식회사                 │
│  ℹ️  입금자명: 회원 상호명으로 입금해 주세요         │
│                                                 │
│  ※ 입금 확인 후 관리자가 충전 처리합니다.            │
│  ※ 영업일 기준 24시간 이내 충전됩니다.              │
│                                                 │
│                               [확인]             │
└─────────────────────────────────────────────────┘
```
(계좌 정보는 관리자 사이트 설정에서 관리 가능하도록 site_settings에 저장)

**5-4. 회원 정산/이력 조회**

회원 대시보드 사이드바의 "정산통계" 탭에서:
- 예치금 충전/차감/환급 이력
- 포인터 지급/차감 이력
- 정산(배송중 전환 시 차감) 이력
- 날짜 필터 적용

---

## 🔄 취소 시 처리

**대기~배송준비중 단계 취소:**
- 이 단계에서는 잔액 차감이 발생하지 않았으므로 환불 불필요
- "사용 가능 잔액" 계산에서 해당 주문이 제외되어 자동으로 잔액 복원 효과

**배송중 이후 취소/반품 (향후 구현):**
- 이미 차감된 금액 환불 필요
- settlement_history 참조하여 원래 차감 비율대로 환불
- 이 부분은 기본 정산 완성 후 추가 구현

---

## 🚨 필수 안전 규칙 (모든 작업 시 반드시 준수)

1. **작업 전 체크**: 수정/추가하려는 부분이 기존에 저장된 기능, 구조, 설정에 영향을 주는지 먼저 확인한 후 작업 시작
2. **작업 중 체크**: 코드 변경 시 관련된 다른 컴포넌트, API, DB 스키마, 스타일이 깨지지 않는지 확인하면서 진행
3. **작업 후 체크**: 하나의 작업이 완료되면, 해당 작업으로 인해 기존 전체 시스템(기능, 구조, 설정, UI)에 오류/에러/변형이 발생하지 않았는지 반드시 전체 점검
4. **기존 기능 보존**: 새로운 기능 추가나 수정으로 인해 기존에 정상 작동하던 기능이 망가지는 일이 절대 없어야 함
5. **특히 주의할 기존 기능들:**
   - 주문 등록 시 기존 검증 체계(등급, 상품, 중복파일, 필수필드, 공급중지, 주소검증) 절대 손상 금지
   - 배송중 전환 기존 워크플로우(운송장 전달, 취소마감, 가시성 제어) 정상 유지
   - 회원 취소 시 재고 자동 복원 기능 정상 유지
   - SSE 실시간 알림 정상 유지
   - 엑셀 업로드/다운로드 기존 기능 정상 유지

## 📝 작업 언어 규칙

- 모든 작업 상황 보고, 작업 결과, 진행 설명, 에러 메시지 설명 등을 **한글(한국어)**로 작성해주세요
- 코드 주석도 가능하면 한글로 작성
- 커밋 메시지, 콘솔 로그 설명 등도 한글로 작성

---

## ✅ 완료 기준

### DB
- [ ] members 테이블 예치금/포인터 잔액 컬럼 활성화
- [ ] settlement_history 테이블 생성
- [ ] deposit_history 테이블 생성
- [ ] pointer_history 테이블 생성

### 주문 등록 잔액 검증
- [ ] 개별 주문 등록 시 잔액 검증 추가 (기존 ⑤ 뒤에 ⑤-1로)
- [ ] 엑셀 일괄 업로드 시 잔액 검증 추가 (기존 ⑩ 뒤에 ⑩-1로)
- [ ] 진행 중 주문 금액 고려한 "사용 가능 잔액" 정확 계산
- [ ] 잔액 부족 시 다이얼로그/토스트로 상세 정보 표시
- [ ] 기존 검증 흐름(①~⑪) 전부 정상 작동 유지

### 배송중 전환 자동 정산
- [ ] 배송중 전환 시 포인터 우선 차감 → 예치금 차감 자동 처리
- [ ] members 잔액 정확히 업데이트
- [ ] 모든 이력 테이블에 기록 저장
- [ ] 일괄 전환 시에도 정상 작동 (잔액 부족 시 부분 실패 처리)
- [ ] 트랜잭션으로 안전 처리 (동시성 제어 포함)

### 관리자 기능
- [ ] 예치금 수동 충전 기능
- [ ] 포인터 지급 기능
- [ ] 예치금 환급 처리 기능
- [ ] 정산관리 페이지 구현 (/admin/settlements)

### 회원 기능
- [ ] 대시보드 잔액 실제 데이터 연동
- [ ] 주문 등록 화면 잔액 배너 표시
- [ ] 예치금 충전 안내 (농협 계좌 표시)
- [ ] 정산/충전/차감 이력 조회

### 기존 기능 보존
- [ ] 주문 등록 기존 검증 체계 전체 정상 작동
- [ ] 배송중 전환 기존 워크플로우 정상 작동
- [ ] 취소 시 재고 자동 복원 정상 작동
- [ ] SSE 실시간 알림 정상 작동
