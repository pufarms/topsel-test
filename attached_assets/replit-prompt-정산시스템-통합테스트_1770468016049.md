⚠️ 모든 작업 보고와 설명을 반드시 한글(한국어)로 작성하세요. 영어 사용 금지.

# 작업 지시서: 정산 시스템 통합 테스트 실행 및 결과 보고

## 📋 작업 개요

정산 시스템이 제대로 작동하는지 **실제 API를 호출하고 DB를 확인하는 통합 테스트**를 실행합니다.
테스트 스크립트를 작성하여 실행하고, 결과를 PDF 보고서로 출력해주세요.

**테스트 후 생성된 테스트 데이터는 반드시 정리(삭제)해주세요.**

---

## 🎯 테스트 실행 방법

아래 테스트들을 **실제 서버 API를 호출하는 스크립트**로 작성하여 실행해주세요.
(Node.js 스크립트 또는 서버 내부 테스트 코드 형태)

테스트 시 사용할 관리자 계정: **kgong5026**
테스트 시 사용할 회원: 기존 등록된 테스트 회원 중 1명 선택 (START 이상 등급)

---

## 테스트 항목

---

### TEST 1: 기존 페이지 정상 작동 확인

**목적: 정산 작업으로 기존 기능이 망가지지 않았는지 확인**

아래 페이지/API에 접근하여 정상 응답(200)이 오는지 확인:

```
1-1. 관리자 페이지 API 응답 확인
- GET /api/admin/orders (주문관리)
- GET /api/admin/members (회원관리)  
- GET /api/admin/products (상품관리)
- GET /api/admin/sales-dashboard (매출현황)
- GET /api/admin/purchase-dashboard (매입현황)
→ 각각 200 응답 + 데이터 반환 확인

1-2. 회원 페이지 API 응답 확인
- GET /api/member/dashboard (대시보드)
- GET /api/member/orders (주문현황)
- GET /api/member/products (상품목록)
→ 각각 200 응답 확인
```

---

### TEST 2: 관리자 정산 API 접근 권한 확인

**목적: 버그 #2(role 대소문자) 수정이 제대로 되었는지 재확인**

```
2-1. 관리자(kgong5026) 로그인 후 정산 API 호출
- GET /api/admin/members-balance → 200 확인
- GET /api/admin/settlements → 200 확인
- GET /api/admin/deposit-history → 200 확인
- GET /api/admin/pointer-history → 200 확인

2-2. 비로그인 상태에서 정산 API 호출
- GET /api/admin/members-balance → 401 확인
- POST /api/admin/members/:id/deposit/charge → 401 확인

2-3. 회원 계정으로 관리자 정산 API 호출
- GET /api/admin/members-balance → 403 확인
```

---

### TEST 3: 예치금 충전/환급 테스트

**목적: 예치금 CRUD가 정상 작동하는지 확인**

```
3-1. 테스트 회원의 현재 잔액 조회 → 기록해둠 (초기값)

3-2. 예치금 충전
- POST /api/admin/members/:id/deposit/charge
  body: { amount: 100000, description: "테스트 충전" }
→ 200 응답 확인
→ 회원 잔액 조회: 예치금이 100,000원 증가했는지 확인
→ deposit_history에 type:'charge', amount:100000 기록 확인
→ admin_id가 kgong5026의 ID로 기록되었는지 확인 (버그 #1 수정 확인)

3-3. 예치금 환급
- POST /api/admin/members/:id/deposit/refund
  body: { amount: 30000, description: "테스트 환급" }
→ 200 응답 확인
→ 회원 잔액: 예치금이 30,000원 감소했는지 확인
→ deposit_history에 type:'refund' 기록 확인

3-4. 초과 환급 시도 (에러 확인)
- POST /api/admin/members/:id/deposit/refund
  body: { amount: 99999999, description: "초과 환급 테스트" }
→ 400 에러 응답 확인 (잔액보다 큰 금액 환급 불가)
```

---

### TEST 4: 포인터 지급 테스트

```
4-1. 포인터 지급
- POST /api/admin/members/:id/pointer/grant
  body: { amount: 50000, description: "테스트 포인터 지급" }
→ 200 응답 확인
→ 회원 포인터 잔액이 50,000원 증가했는지 확인
→ pointer_history에 type:'grant', amount:50000 기록 확인
→ admin_id 기록 확인
```

---

### TEST 5: 사용 가능 잔액 계산 정확성

**목적: 진행 중 주문을 고려한 잔액 계산이 정확한지 확인**

```
5-1. 현재 잔액 확인
- GET /api/member/my-balance (테스트 회원 로그인)
→ 반환값 기록: 예치금, 포인터, 진행중주문총액, 사용가능잔액

5-2. 계산 검증
→ (예치금 + 포인터) - 진행중주문총액 = 사용가능잔액 이 맞는지 확인
→ 진행중주문에 포함된 상태값 확인 (대기, 상품준비중, 배송준비중만 포함)
→ 배송중, 취소 상태 주문은 제외되었는지 확인
```

---

### TEST 6: 엑셀 업로드 잔액 검증 테스트

**목적: 엑셀 업로드 시 잔액 검증이 정상 작동하는지 확인**

```
6-1. 잔액 충분 상태에서 엑셀 업로드
(테스트 회원 잔액이 충분한 상태에서)
- POST /api/member/orders/upload (정상 엑셀 파일)
→ 200 응답 + 주문 등록 성공 확인

6-2. 잔액 부족 상태에서 엑셀 업로드
(관리자에서 테스트 회원 예치금을 환급하여 잔액을 1원으로 만든 후)
- POST /api/member/orders/upload (동일 엑셀 파일)
→ 잔액 부족 에러 응답 확인
→ 응답에 포함된 데이터 확인:
  [ ] 업로드 건수
  [ ] 정상건 수
  [ ] 정상건 주문 총액
  [ ] 예치금 잔액
  [ ] 포인터 잔액
  [ ] 진행 중 주문 금액
  [ ] 사용 가능 잔액
  [ ] 부족 금액
→ 주문이 등록되지 않았음을 확인 (DB에 새 주문 없음)

6-3. 기존 검증 흐름 유지 확인
(존재하지 않는 상품코드가 포함된 엑셀로 테스트)
→ 상품 오류 응답이 기존과 동일한 형식인지 확인
→ 잔액 검증 이전에 상품 검증이 먼저 실행되는지 확인
```

---

### TEST 7: 배송중 전환 자동 정산 테스트

**목적: 배송중 전환 시 자동 정산이 정확하게 작동하는지 확인**

```
사전 준비:
- 테스트 회원에게 예치금 100,000원 + 포인터 50,000원 충전
- 테스트 주문 1건 등록 (예: 총액 80,000원)
- 해당 주문을 배송준비중 상태까지 진행

7-1. 배송중 전환 전 잔액 기록
→ 예치금: ?, 포인터: ?

7-2. 배송중 전환 실행
→ 성공 확인

7-3. 배송중 전환 후 검증
→ 차감 우선순위 확인:
  [ ] 포인터 50,000원 먼저 차감 (잔액 0원)
  [ ] 나머지 30,000원 예치금에서 차감 (잔액 70,000원)

→ 이력 기록 확인:
  [ ] settlement_history에 기록 존재 (pointer_amount:50000, deposit_amount:30000, total:80000)
  [ ] deposit_history에 type:'deduct' 기록 존재 (amount:30000)
  [ ] pointer_history에 type:'deduct' 기록 존재 (amount:50000)

→ 가격 확정 확인:
  [ ] 해당 주문의 priceConfirmed가 true로 설정되었는지

→ 주문 상태 확인:
  [ ] 해당 주문 상태가 "배송중"으로 변경되었는지
```

---

### TEST 8: 잔액 부족 시 배송중 전환 실패 테스트

```
사전 준비:
- 테스트 회원 잔액을 1원으로 설정
- 테스트 주문 등록 후 배송준비중까지 진행

8-1. 배송중 전환 시도
→ 잔액 부족 에러 확인
→ 주문 상태가 "배송준비중" 유지 확인 (변경 안 됨)
→ members 잔액 변동 없음 확인
→ 이력 테이블에 새 기록 없음 확인
```

---

### TEST 9: 회원 이력 조회 API 테스트

```
(테스트 회원 로그인 상태)

9-1. GET /api/member/my-settlements → 200 + 정산 이력 반환
9-2. GET /api/member/my-deposit-history → 200 + 예치금 이력 반환
9-3. GET /api/member/my-pointer-history → 200 + 포인터 이력 반환

→ 각 이력에 TEST 3~7에서 생성된 기록이 포함되어 있는지 확인
→ 다른 회원의 이력이 보이지 않는지 확인 (본인 것만)
```

---

### TEST 10: 주문 취소 시 잔액 영향 확인

```
10-1. 진행 중 주문(대기~배송준비중) 취소
→ 취소 성공 확인
→ "사용 가능 잔액"이 증가하는지 확인 (진행중 주문에서 제외되므로)
→ members의 예치금/포인터 잔액 자체는 변동 없음 확인 (아직 차감 전이므로)

10-2. 배송중 이후 주문의 취소
→ (이 부분은 현재 구현 범위 확인만 - 환불 로직이 있는지)
→ 있으면 테스트, 없으면 "미구현"으로 보고
```

---

## 📊 테스트 결과 보고 양식

아래 양식으로 보고서를 작성해주세요:

```
[TEST 1: 기존 페이지 정상 작동]
- 관리자 API: ✅ 전체 정상 / ❌ 문제 (상세)
- 회원 API: ✅ 전체 정상 / ❌ 문제 (상세)

[TEST 2: 정산 API 접근 권한]
- 관리자 접근: ✅ / ❌
- 비인증 차단: ✅ / ❌
- 회원 차단: ✅ / ❌

[TEST 3: 예치금 충전/환급]
- 충전: ✅ / ❌
- 환급: ✅ / ❌
- 초과 환급 차단: ✅ / ❌
- admin_id 기록: ✅ / ❌

[TEST 4: 포인터 지급]
- 지급: ✅ / ❌
- admin_id 기록: ✅ / ❌

[TEST 5: 사용 가능 잔액 계산]
- 계산 정확성: ✅ / ❌
- 실제 계산값: (예치금) + (포인터) - (진행중주문) = (사용가능잔액)

[TEST 6: 엑셀 업로드 잔액 검증]
- 잔액 충분 시 등록: ✅ / ❌
- 잔액 부족 시 차단: ✅ / ❌
- 부족 시 상세 데이터 반환: ✅ / ❌
- 기존 검증 흐름 유지: ✅ / ❌

[TEST 7: 배송중 전환 자동 정산]
- 포인터 우선 차감: ✅ / ❌
- 예치금 차감: ✅ / ❌
- settlement_history 기록: ✅ / ❌
- deposit_history 기록: ✅ / ❌
- pointer_history 기록: ✅ / ❌
- 가격 확정 (priceConfirmed): ✅ / ❌

[TEST 8: 잔액 부족 시 전환 실패]
- 전환 차단: ✅ / ❌
- 상태 유지: ✅ / ❌
- 잔액 변동 없음: ✅ / ❌

[TEST 9: 회원 이력 조회]
- 정산 이력: ✅ / ❌
- 예치금 이력: ✅ / ❌
- 포인터 이력: ✅ / ❌
- 본인 것만 조회: ✅ / ❌

[TEST 10: 주문 취소 영향]
- 취소 후 사용가능잔액 증가: ✅ / ❌
- 잔액 자체 변동 없음: ✅ / ❌
```

---

## 🧹 테스트 후 정리

테스트 완료 후 반드시 다음을 수행하세요:

1. 테스트로 생성된 주문 데이터 삭제
2. 테스트로 생성된 정산/이력 데이터 삭제
3. 테스트 회원의 예치금/포인터를 테스트 전 초기값으로 복원
4. file_hashes에 테스트 엑셀 해시가 남았으면 삭제

---

## 📄 보고서 출력

테스트 결과를 **PDF 파일로 생성**하여 다운로드할 수 있도록 해주세요.

- 파일명: `정산시스템-통합테스트-결과.pdf`
- PDF 다운로드 확인 후 해당 파일은 삭제해도 됩니다.
