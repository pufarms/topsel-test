# 재고 이력 (5단계)

## 📋 개요

**재고관리 > 재고 이력** 페이지를 구현해주세요.
공급상품과 원재료의 모든 입출고/조정 내역을 기록하고 조회하는 페이지입니다.

---

## 🎯 목적

**모든 재고 변동 내역을 통합 관리**

- 공급상품 + 원재료 이력 통합 조회
- 담당자(아이디) 기록 및 표시
- 날짜/유형별 필터 검색
- 주문관리 연동 대비 (미래)

---

## 🔵 현재 vs 🟢 미래 구현 범위

### 현재 구현 (수동)

| 재고유형 | 입고 | 조정 | 출고 |
|----------|:----:|:----:|:----:|
| **공급상품** | ✅ 수동 | ✅ 수동 | - |
| **원재료** | ✅ 수동 | ✅ 수동 | - |
| **반재료** | ✅ 수동 | ✅ 수동 | - |
| **부재료** | ✅ 수동 | ✅ 수동 | - |

### 미래 연동 (주문관리 작업 시 추가)

| 재고유형 | 출고 | 트리거 |
|----------|:----:|--------|
| **공급상품** | 자동 | 주문관리 → 배송중 전환 |
| **원재료** | 자동 | 주문관리 → 배송중 전환 (부족분) |
| **반재료** | 자동 | 주문관리 → 배송중 전환 (부족분) |
| **부재료** | 자동 | 주문관리 → 배송중 전환 (부족분) |

**※ 현재는 수동 입고/조정만 구현, 미래 연동을 위한 필드는 미리 준비!**

---

## 🔗 이력이 기록되는 시점

| 구분 | 시점 | 처리유형 | 자동/수동 |
|------|------|----------|:---------:|
| 공급상품 | 입고 등록 | 입고 | 수동 |
| 공급상품 | 재고 조정 | 조정 | 수동 |
| 공급상품 | 주문 배송중 전환 | 출고 | **자동** (미래) |
| 원재료 | 입고 등록 | 입고 | 수동 |
| 원재료 | 재고 조정 | 조정 | 수동 |
| 원재료 | 주문 배송중 전환 | 출고 | **자동** (미래) |

**※ 주문관리 연동은 미래에 구현 예정이며, 현재는 수동 입고/조정만 기록됩니다.**

---

## 🔄 주문관리 연동 시나리오 (미래 대비)

```
[주문관리]
    │
    │ 주문 상태: "배송중"으로 전환
    ▼
[재고관리 자동 작동]
    │
    ├─→ 1️⃣ 공급상품 재고 확인 & 차감
    │
    ├─→ 2️⃣ 부족분 원재료 재고 차감 (상품 매핑 기반)
    │
    └─→ 3️⃣ 재고 이력 자동 기록
         - 처리유형: 출고
         - 비고: 주문번호
         - 담당자: 처리자 또는 system
```

---

## 🎨 페이지 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 재고 이력                                                                         │
│ 공급상품과 원재료의 입출고/조정 내역을 조회합니다.                                   │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                              [엑셀 다운로드]      │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 검색 필터                                                                       │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 재고유형: [전체 ▼]      처리유형: [전체 ▼]      담당자: [전체 ▼]              │ │
│ │                                                                              │ │
│ │ 기간: [2025-01-01] ~ [2025-01-23]                                            │ │
│ │                                                                              │ │
│ │ 검색어: [__________________]  (품목명, 주문번호 검색)      [검색] [초기화]    │ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│                                                                  총 125건        │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 재고 이력                                                                       │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 일시           │재고유형│처리유형│품목코드│품목명            │ 수량 │담당자 │비고     │ │
│ ├──────────────────────────────────────────────────────────────────────────────┤ │
│ │ 01-23 14:30   │공급상품│ 입고  │ A001  │ 부사 3kg 선물세트 │ +10 │admin01│        │ │
│ │ 01-23 13:20   │공급상품│ 출고  │ A001  │ 부사 3kg 선물세트 │ -10 │admin01│#ORD-001│ │
│ │ 01-23 13:20   │원재료 │ 출고  │ R001  │ 부사 보통 3번(원물)│ -10 │admin01│#ORD-001│ │
│ │ 01-23 13:20   │원재료 │ 출고  │ R002  │ 부사 상 2번(원물) │  -5 │admin01│#ORD-001│ │
│ │ 01-23 13:20   │부재료 │ 출고  │ B001  │ 3kg 선물박스      │  -5 │admin01│#ORD-001│ │
│ │ 01-23 10:15   │공급상품│ 조정  │ A002  │ 부사 5kg 가정용   │  -2 │manager│파손     │ │
│ │ 01-22 16:40   │원재료 │ 입고  │ R001  │ 부사 보통 3번(원물)│ +50 │admin01│        │ │
│ │ 01-22 15:30   │부재료 │ 입고  │ B001  │ 3kg 선물박스      │+100 │admin01│        │ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│                              [1] [2] [3] ... [10]                                │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 테이블 컬럼

| 순번 | 컬럼명 | 설명 |
|:----:|--------|------|
| 1 | 일시 | 처리 일시 (MM-DD HH:mm) |
| 2 | 재고유형 | 공급상품 / 원재료 / 반재료 / 부재료 |
| 3 | 처리유형 | 입고 / 출고 / 조정 |
| 4 | 품목코드 | 상품코드 또는 재료코드 |
| 5 | 품목명 | 상품명 또는 재료명 |
| 6 | 수량 | +/- 표시 (증가: +10, 감소: -10) |
| 7 | 담당자 | 처리한 관리자 아이디 |
| 8 | 비고 | 조정사유, 주문번호 등 |

### 재고유형 표시

| DB 값 | 표시 값 |
|-------|--------|
| product | 공급상품 |
| raw | 원재료 |
| semi | 반재료 |
| sub | 부재료 |

### 처리유형 표시

| DB 값 | 표시 값 | 색상 |
|-------|--------|------|
| in | 입고 | 🟢 초록 |
| out | 출고 | 🔴 빨강 |
| adjust | 조정 | 🟡 노랑 |

### 수량 표시 규칙

| 상황 | 표시 |
|------|------|
| 증가 | +10 (초록색) |
| 감소 | -10 (빨간색) |

---

## 🔍 검색 필터

| 필터 | 타입 | 옵션 |
|------|------|------|
| 재고유형 | 드롭다운 | 전체 / 공급상품 / 원재료 / 반재료 / 부재료 |
| 처리유형 | 드롭다운 | 전체 / 입고 / 출고 / 조정 |
| 처리방식 | 드롭다운 | 전체 / 수동 / 자동(주문) |
| 담당자 | 드롭다운 | 전체 / (담당자 목록 - DB에서 조회) |
| 기간 | 날짜 선택 | 시작일 ~ 종료일 |
| 검색어 | 텍스트 | 품목명, 품목코드, 주문번호 검색 |

### 처리방식 필터 (🔮 미래 연동 대비)

| 값 | 표시 | 설명 |
|----|------|------|
| 전체 | 전체 | 모든 이력 |
| manual | 수동 | 수동 입고/조정 |
| order | 자동(주문) | 주문관리 연동 출고 (미래) |

**※ 현재는 모든 이력이 'manual'이지만, 미래 주문관리 연동 시 'order'로 구분됩니다.**

### 기간 기본값

| 항목 | 값 |
|------|-----|
| 시작일 | 이번 달 1일 |
| 종료일 | 오늘 |

---

## 📥 엑셀 다운로드

### [엑셀 다운로드] 버튼

클릭 시 현재 필터 적용된 이력 전체 다운로드

**파일명:** `재고이력_20250123.xlsx`

> ⚠️ **탑셀러 엑셀 파일 규칙**
> - 다운로드 파일: `.xlsx` 형식
> - **CSV 형식 사용 금지**

### 엑셀 파일 구조

| 일시 | 재고유형 | 처리유형 | 품목코드 | 품목명 | 수량 | 담당자 | 비고 |
|------|---------|---------|---------|--------|------|--------|------|
| 2025-01-23 14:30 | 공급상품 | 입고 | A001 | 부사 3kg 선물세트 | 10 | admin01 | |
| 2025-01-23 13:20 | 공급상품 | 출고 | A001 | 부사 3kg 선물세트 | -10 | admin01 | #ORD-001 |
| 2025-01-23 10:15 | 공급상품 | 조정 | A002 | 부사 5kg 가정용 | -2 | manager | 파손 |

---

## 📊 데이터 스키마

### stock_history (재고 이력)

```typescript
{
  id: number;
  
  // 기본 정보
  stockType: 'product' | 'raw' | 'semi' | 'sub';  // 공급상품/원재료/반재료/부재료
  actionType: 'in' | 'out' | 'adjust';            // 입고/출고/조정
  itemCode: string;                               // 상품코드 또는 재료코드
  itemName: string;                               // 상품명 또는 재료명
  quantity: number;                               // 수량 (+증가, -감소)
  
  // 상세 정보
  beforeStock: number;                            // 변경 전 재고 (선택)
  afterStock: number;                             // 변경 후 재고 (선택)
  reason: string;                                 // 조정 사유 (조정 시)
  note: string;                                   // 비고
  
  // 담당자
  adminId: string;                                // 담당자 아이디
  
  // 🔮 미래 연동 대비 필드 (현재는 기본값 사용)
  source: 'manual' | 'order';                     // 수동/자동 구분 (기본값: 'manual')
  orderId: string | null;                         // 주문번호 (기본값: null)
  
  createdAt: Date;
}
```

### SQL 스키마

```sql
CREATE TABLE stock_history (
  id SERIAL PRIMARY KEY,
  
  -- 기본 정보
  stock_type VARCHAR(20) NOT NULL,        -- 'product' | 'raw' | 'semi' | 'sub'
  action_type VARCHAR(20) NOT NULL,       -- 'in' | 'out' | 'adjust'
  item_code VARCHAR(50) NOT NULL,
  item_name VARCHAR(200) NOT NULL,
  quantity INT NOT NULL,                  -- +/- 표시
  
  -- 상세 정보
  before_stock INT,
  after_stock INT,
  reason VARCHAR(100),                    -- 조정 사유
  note VARCHAR(200),                      -- 비고
  
  -- 담당자
  admin_id VARCHAR(50) NOT NULL,
  
  -- 🔮 미래 연동 대비 필드
  source VARCHAR(20) DEFAULT 'manual',    -- 'manual' | 'order'
  order_id VARCHAR(50),                   -- 주문번호 (미래 연동 시 사용)
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스 (검색 성능)
CREATE INDEX idx_stock_history_created_at ON stock_history(created_at DESC);
CREATE INDEX idx_stock_history_stock_type ON stock_history(stock_type);
CREATE INDEX idx_stock_history_action_type ON stock_history(action_type);
CREATE INDEX idx_stock_history_admin_id ON stock_history(admin_id);
CREATE INDEX idx_stock_history_item_code ON stock_history(item_code);
CREATE INDEX idx_stock_history_order_id ON stock_history(order_id);  -- 미래 연동용
CREATE INDEX idx_stock_history_source ON stock_history(source);      -- 미래 연동용
```

---

## 🔧 이력 기록 함수

### 공통 이력 기록 함수

```typescript
interface CreateStockHistoryParams {
  stockType: 'product' | 'raw' | 'semi' | 'sub';
  actionType: 'in' | 'out' | 'adjust';
  itemCode: string;
  itemName: string;
  quantity: number;        // +증가, -감소
  beforeStock?: number;
  afterStock?: number;
  reason?: string;         // 조정 사유
  note?: string;           // 비고
  adminId: string;
  
  // 🔮 미래 연동 대비 파라미터
  source?: 'manual' | 'order';  // 기본값: 'manual'
  orderId?: string;             // 주문번호 (미래 연동 시 사용)
}

const createStockHistory = async (params: CreateStockHistoryParams) => {
  await db.stockHistory.create({
    data: {
      stockType: params.stockType,
      actionType: params.actionType,
      itemCode: params.itemCode,
      itemName: params.itemName,
      quantity: params.quantity,
      beforeStock: params.beforeStock,
      afterStock: params.afterStock,
      reason: params.reason || '',
      note: params.note || '',
      adminId: params.adminId,
      
      // 🔮 미래 연동 대비 필드
      source: params.source || 'manual',
      orderId: params.orderId || null,
      
      createdAt: new Date()
    }
  });
};
```

### 사용 예시

#### 1) 공급상품 입고 시 (현재 - 수동)

```typescript
// 공급상품 재고 관리 > 입고 등록
await createStockHistory({
  stockType: 'product',
  actionType: 'in',
  itemCode: 'A001',
  itemName: '부사 3kg 선물세트',
  quantity: 10,              // +10
  beforeStock: 5,
  afterStock: 15,
  adminId: 'admin01',
  source: 'manual'           // 수동
});
```

#### 2) 원재료 재고 조정 시 (현재 - 수동)

```typescript
// 원재료 관리 > 재고 조정
await createStockHistory({
  stockType: 'raw',
  actionType: 'adjust',
  itemCode: 'R001',
  itemName: '부사 보통 3번(원물)',
  quantity: -5,              // -5 (감소)
  beforeStock: 100,
  afterStock: 95,
  reason: '파손',
  adminId: 'manager',
  source: 'manual'           // 수동
});
```

#### 3) 🔮 주문 출고 시 (미래 - 자동)

```typescript
// 주문관리 > 배송중 전환 시 자동 호출 (미래 구현)
await createStockHistory({
  stockType: 'product',
  actionType: 'out',
  itemCode: 'A001',
  itemName: '부사 3kg 선물세트',
  quantity: -10,
  beforeStock: 10,
  afterStock: 0,
  adminId: 'admin01',
  source: 'order',                    // 자동 (주문 연동)
  orderId: 'ORD-20250123-001'         // 주문번호
});
```

---

## 🔔 알림

| 상황 | 타입 | 메시지 |
|------|------|--------|
| 엑셀 다운로드 | ✅ success | "엑셀 파일이 다운로드되었습니다." |
| 검색 결과 없음 | ℹ️ info | "검색 결과가 없습니다." |

---

## 🔌 API 엔드포인트

```
# 재고 이력 조회
GET    /api/stock-history                       # 이력 목록 (필터, 페이지네이션)
GET    /api/stock-history/admins                # 담당자 목록 (필터용)

# 엑셀 다운로드
GET    /api/stock-history/export                # 엑셀 다운로드 (필터 적용)

# 이력 기록 (내부 호출용)
POST   /api/stock-history                       # 이력 기록 (다른 기능에서 호출)
```

### 이력 조회 API 파라미터

```
GET /api/stock-history?
    stockType=product|raw|semi|sub&
    actionType=in|out|adjust&
    adminId=admin01&
    startDate=2025-01-01&
    endDate=2025-01-23&
    keyword=부사&
    page=1&
    limit=20
```

---

## ✅ 체크리스트

### 페이지 기본
- [ ] 재고 이력 테이블
- [ ] 최신순 정렬 (기본값)
- [ ] 페이지네이션

### 검색 필터
- [ ] 재고유형 필터 (전체/공급상품/원재료/반재료/부재료)
- [ ] 처리유형 필터 (전체/입고/출고/조정)
- [ ] 처리방식 필터 (전체/수동/자동) - 🔮 미래 연동 대비
- [ ] 담당자 필터 (전체/담당자 목록)
- [ ] 기간 필터 (시작일~종료일)
- [ ] 검색어 (품목명, 품목코드, 주문번호)
- [ ] [검색] 버튼
- [ ] [초기화] 버튼

### 테이블 표시
- [ ] 일시 (MM-DD HH:mm)
- [ ] 재고유형 (공급상품/원재료/반재료/부재료)
- [ ] 처리유형 (입고/출고/조정) + 색상 구분
- [ ] 품목코드
- [ ] 품목명
- [ ] 수량 (+/- 표시, 색상 구분)
- [ ] 담당자 (아이디)
- [ ] 비고 (조정사유, 주문번호)

### 엑셀 다운로드
- [ ] [엑셀 다운로드] 버튼
- [ ] 필터 적용된 전체 이력 다운로드
- [ ] .xlsx 형식

### 이력 기록 연동
- [ ] 공급상품 입고 시 이력 자동 기록 (source: 'manual')
- [ ] 공급상품 조정 시 이력 자동 기록 (source: 'manual')
- [ ] 원재료 입고 시 이력 자동 기록 (source: 'manual')
- [ ] 원재료 조정 시 이력 자동 기록 (source: 'manual')
- [ ] 담당자(아이디) 자동 기록

### 🔮 미래 연동 대비 (현재는 구현 X, 필드만 준비)
- [ ] source 필드 준비 ('manual' | 'order')
- [ ] order_id 필드 준비 (주문번호)
- [ ] 처리방식 필터 UI 준비

---

## ⚠️ 중요 규칙

| 항목 | 규칙 |
|------|------|
| **이력 삭제** | 불가 (이력은 삭제할 수 없음) |
| **이력 수정** | 불가 (이력은 수정할 수 없음) |
| **담당자 기록** | 모든 이력에 담당자(아이디) 필수 기록 |
| **수량 표시** | +/- 부호로 증감 구분 |
| **source 기본값** | 'manual' (수동) |
| **order_id 기본값** | null |
| **엑셀 형식** | .xlsx (CSV 금지) |
| **정렬** | 최신순 (createdAt DESC) |

---

## 🔮 미래 연동 대비

### 주문관리 연동 시 추가될 항목

| 항목 | 현재 | 미래 |
|------|------|------|
| **출고 이력** | 수동만 | 자동 추가 (배송중 전환 시) |
| **source 값** | 'manual' 만 | 'manual' + 'order' |
| **order_id 값** | null | 주문번호 (예: ORD-20250123-001) |

### 주문관리 연동 시 자동 처리 흐름

```
[주문관리 - 배송중 전환]
    │
    │ 주문: 부사 3kg 선물세트 15개
    ▼
┌─────────────────────────────────────────────────┐
│ 1️⃣ 공급상품 재고 차감 (자동)                     │
│    └─ 재고 이력 기록                            │
│       • actionType: 'out'                       │
│       • source: 'order'                         │
│       • orderId: 'ORD-20250123-001'             │
│                                                 │
│ 2️⃣ 부족분 원재료 차감 (자동)                     │
│    └─ 재고 이력 기록                            │
│       • actionType: 'out'                       │
│       • source: 'order'                         │
│       • orderId: 'ORD-20250123-001'             │
└─────────────────────────────────────────────────┘
```

### 미래 연동 시 이력 조회 예시

```
검색: source = 'order', orderId = 'ORD-20250123-001'

결과:
┌────────────────────────────────────────────────────────────────────────────────┐
│ 일시         │재고유형│처리유형│품목명             │ 수량│담당자 │주문번호          │
├────────────────────────────────────────────────────────────────────────────────┤
│ 01-23 14:30 │공급상품│ 출고  │ 부사 3kg 선물세트  │ -10│admin01│ORD-20250123-001│
│ 01-23 14:30 │원재료 │ 출고  │ 부사 보통 3번(원물)│ -10│admin01│ORD-20250123-001│
│ 01-23 14:30 │원재료 │ 출고  │ 부사 상 2번(원물)  │  -5│admin01│ORD-20250123-001│
│ 01-23 14:30 │부재료 │ 출고  │ 3kg 선물박스       │  -5│admin01│ORD-20250123-001│
└────────────────────────────────────────────────────────────────────────────────┘

→ 해당 주문으로 어떤 재고가 빠졌는지 한눈에 확인 가능!
```

---

## 📋 현재 작업 범위 요약

| 작업 | 상태 |
|------|:----:|
| 재고 이력 조회 (필터, 검색) | ✅ 현재 구현 |
| 수동 입고/조정 이력 기록 | ✅ 현재 구현 |
| 담당자(아이디) 표시 | ✅ 현재 구현 |
| 엑셀 다운로드 | ✅ 현재 구현 |
| source 필드 (수동/자동 구분) | ✅ 미리 준비 |
| order_id 필드 (주문번호) | ✅ 미리 준비 |
| 처리방식 필터 | ✅ 미리 준비 |
| **주문관리 자동 출고 연동** | 🔮 **미래** |
