⚠️ 모든 작업 보고와 설명을 반드시 한글(한국어)로 작성하세요. 영어 사용 금지.

# 작업 지시서: 정산 시스템 구현 검증 및 보완

## 📋 작업 개요

정산 시스템 통합 테스트(58/58 통과)를 완료한 상태입니다.
테스트에서 확인하기 어려운 **UI 세부사항과 코드 레벨 안전장치**를 추가 검증하고 보완합니다.

**이 작업은 기존 코드를 검증하고 부족한 부분만 보완하는 작업입니다. 이미 정상 작동하는 기능은 절대 수정하지 마세요.**

---

## 확인 및 보완 항목 (4가지)

---

### 항목 1: 주문 등록 화면 잔액 배너 세부 확인

**참고:** 점검 보고서에서 "3단계 색상(≥10만 파랑, <5만 주황, ≤0 빨강) 정상"으로 확인됨.
아래 세부 사항을 추가 확인합니다.

**확인할 것:**

(1) 배너에 다음 정보가 **모두** 표시되는지:
```
예치금: ○○원
포인터: ○○원
진행 중 주문 예상 금액: ○○원
사용 가능 잔액: ○○원
```

(2) 잔액이 충분할 때(10만원 이상)도 배너가 보이는지:
- 부족할 때만 보이면 안 됨
- 항상 표시되어야 회원이 사전에 잔액을 확인 가능

(3) [예치금 충전하기] 또는 [충전하기] 버튼이 배너에 포함되어 있는지:
- 버튼 클릭 시 예치금 충전 안내 페이지/탭으로 이동

(4) 금액 표시 형식:
- 천 단위 콤마 적용 (예: 100,000원)
- 음수 표시 시 마이너스(-) 또는 별도 색상 처리

**보완 방법 (누락 사항 있을 시):**
- 누락된 정보 항목만 추가 (기존 배너 레이아웃 유지)
- [충전하기] 버튼 없으면 추가 (대시보드의 예치금충전 탭으로 이동)
- 금액 포맷팅 누락 시 toLocaleString('ko-KR') 적용

---

### 항목 2: 잔액 부족 다이얼로그 세부 확인

**참고:** 통합 테스트에서 케이스 B(잔액 부족만), C(오류+잔액 부족) 모두 정상 작동 확인됨.
현재 동작 확인 사항:

- 케이스 B: 별도 잔액 부족 전용 다이얼로그 (max-w-500px)
- 케이스 C: 상품 오류 + 잔액 부족 복합 다이얼로그 (max-w-560px), "정상건만 등록" 버튼 없음
- 케이스 D: 상품 오류만 + 잔액 확인 블록(초록색) + "정상건만 등록" 버튼 활성

**추가 확인할 것:**

(1) 케이스 B 다이얼로그에 표시되는 정보가 충분한지:
```
필수 표시 항목:
- 주문 건수
- 주문 총액
- 예치금 잔액
- 포인터 잔액
- 진행 중 주문 금액
- 사용 가능 잔액
- 부족 금액 (빨간색 강조)
```

(2) 케이스 C에서 상품 오류 목록이 스크롤 가능한지 (오류가 많을 때)

(3) "확인" 버튼 클릭 시 다이얼로그가 정상적으로 닫히는지

**이미 정상 작동하면 "확인 완료"로 보고하고 넘어가세요.**

---

### 항목 3: 동시성 제어 (SELECT FOR UPDATE) 코드 레벨 확인

**참고:** 점검 보고서에서 "DB 트랜잭션 기반 데이터 일관성 보장 (SELECT FOR UPDATE)" 확인됨.
실제 코드에서 적용 범위를 확인합니다.

**확인할 것:**

아래 **5개 API 모두**에서 members 잔액 조회 시 FOR UPDATE가 적용되어 있는지:

| No | API | FOR UPDATE 필요 |
|----|-----|----------------|
| 1 | 배송중 전환 자동 정산 | ✅ 필수 |
| 2 | POST /api/admin/members/:id/deposit/charge (예치금 충전) | ✅ 필수 |
| 3 | POST /api/admin/members/:id/deposit/refund (예치금 환급) | ✅ 필수 |
| 4 | POST /api/admin/members/:id/pointer/grant (포인터 지급) | ✅ 필수 |
| 5 | 엑셀 업로드 잔액 검증 시 잔액 조회 | ⚠️ 권장 (필수 아님) |

**확인 방법:**
```
각 API의 트랜잭션 내부에서 members 테이블을 조회하는 코드를 찾고,
.for('update') 또는 FOR UPDATE가 붙어있는지 확인
```

**보완 방법 (누락 시):**
```typescript
// Drizzle ORM 예시
await tx.select()
  .from(members)
  .where(eq(members.id, memberId))
  .for('update')  // ← 이것이 있어야 함
```

- 1~4번 API에 누락되어 있으면 추가
- 5번은 읽기 전용이므로 권장사항 (추가하면 좋지만 필수는 아님)

---

### 항목 4: 배송중 전환 시 가격 확정 저장 코드 레벨 확인

**참고:** 점검 보고서에서 "가격 확정 priceConfirmed=true 동시 처리" 확인됨.
실제 저장되는 가격 데이터를 확인합니다.

**확인할 것:**

(1) 배송중 전환 시 pending_orders에 어떤 가격이 저장되는지:
```
- priceConfirmed = true (플래그) → 확인됨
- 실제 공급가 금액이 pending_orders에 저장되는지?
  예: confirmedPrice, supplyPrice, unitPrice 등의 컬럼에 금액 저장
- 또는 priceConfirmed 플래그만 있고, 금액은 여전히 current_products를 참조하는지?
```

(2) priceConfirmed=true인 주문의 가격 조회 시:
```
- pending_orders에 저장된 확정 가격을 사용하는지?
- 아니면 current_products에서 여전히 가격을 가져오는지?
```

(3) 시나리오 테스트:
```
만약 배송중 전환 후 current_products의 가격을 변경하면,
해당 주문의 표시 가격이 변경되는지(문제) 아니면 유지되는지(정상)?
```

**중요: 현재 구현 방식을 정확히 보고해주세요.**

가능한 구현 방식:
- A: pending_orders에 확정 금액을 직접 저장 → 이상적
- B: priceConfirmed 플래그만 있고 금액은 current_products 참조 → 가격 변동 시 문제
- C: 기타

**방식 B인 경우 보완 필요:**
- pending_orders에 confirmed_supply_price 컬럼 추가
- 배송중 전환 시 current_products의 회원등급별 공급가를 이 컬럼에 저장
- 주문 조회 시: priceConfirmed=true이면 confirmed_supply_price 사용

---

## 🚨 작업 시 주의사항

1. **검증 먼저**: 각 항목을 코드에서 확인한 후, 이미 구현되어 있으면 "확인 완료"로 보고하고 넘어가세요
2. **최소 변경**: 보완이 필요한 경우 해당 부분만 최소한으로 수정하세요
3. **기존 기능 보존**: 이미 정상 작동하는 정산 로직, 잔액 검증, 자동 정산 등을 건드리지 마세요
4. **테스트**: 보완 후 기존 기능(주문 등록, 배송중 전환, 충전/환급)이 정상 작동하는지 확인

## 📝 작업 언어 규칙

- 모든 작업 보고를 한글(한국어)로 작성해주세요

---

## ✅ 보고 양식

각 항목에 대해 다음 형식으로 보고해주세요:

```
[항목 1: 잔액 배너]
- 현재 상태: (이미 구현됨 / 부분 구현 / 미구현)
- 표시 항목: (예치금/포인터/진행중주문/사용가능잔액/충전버튼)
- 항상 표시 여부: (항상 / 조건부)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 2: 잔액 부족 다이얼로그]
- 현재 상태: (이미 구현됨 / 부분 구현 / 미구현)
- 케이스별 확인: B(잔액부족만) / C(복합) / D(오류+잔액OK)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 3: 동시성 제어 SELECT FOR UPDATE]
- 배송중 전환 정산: (적용됨 / 미적용)
- 예치금 충전: (적용됨 / 미적용)
- 예치금 환급: (적용됨 / 미적용)
- 포인터 지급: (적용됨 / 미적용)
- 엑셀 잔액 검증: (적용됨 / 미적용)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 4: 가격 확정 저장]
- 현재 구현 방식: (A: 금액 직접 저장 / B: 플래그만 / C: 기타)
- priceConfirmed 플래그: (있음 / 없음)
- 확정 금액 저장 컬럼: (컬럼명 또는 "없음")
- 가격 변동 시 영향: (영향 없음 / 영향 있음)
- 보완 내용: (수정한 내용 또는 "수정 불필요")
```
