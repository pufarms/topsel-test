⚠️ 모든 작업 보고와 설명을 반드시 한글(한국어)로 작성하세요. 영어 사용 금지.

# 작업 지시서: 정산 시스템 구현 검증 및 보완

## 📋 작업 개요

정산 시스템(예치금/포인터) 기본 구현이 완료되었습니다.
아래 4가지 항목이 제대로 구현되었는지 확인하고, 누락/미흡한 부분을 보완합니다.

**이 작업은 기존 코드를 검증하고 부족한 부분만 보완하는 작업입니다. 이미 정상 작동하는 기능은 절대 수정하지 마세요.**

---

## 확인 및 보완 항목 (4가지)

---

### 항목 1: 주문 등록 화면 잔액 배너 (항상 표시)

**요구사항:** 회원이 주문 등록 화면(엑셀 업로드 화면)에 들어가면 **잔액이 충분하든 부족하든 관계없이** 상단에 잔액 정보 배너가 항상 표시되어야 합니다.

**확인할 것:**
- 잔액이 충분할 때도 배너가 보이는지 (부족할 때만 보이면 안 됨)
- 배너에 다음 정보가 모두 표시되는지:
  ```
  예치금: ○○원 + 포인터: ○○원 = 합계: ○○원
  진행 중 주문 예상 금액: ○○원
  사용 가능 잔액: ○○원
  ```
- [예치금 충전하기] 버튼이 배너에 포함되어 있는지

**보완 방법 (누락 시):**
- 주문 등록 화면 컴포넌트 상단에 잔액 배너 컴포넌트 추가
- `/api/member/my-balance` API를 호출하여 실시간 잔액 표시
- 잔액이 충분하면 초록/파란 계열, 부족하면 빨간/주황 계열로 색상 구분

---

### 항목 2: 엑셀 업로드 잔액 부족 시 상세 다이얼로그

**요구사항:** 엑셀 업로드 후 잔액이 부족할 때, 단순 에러 메시지가 아니라 **상세 다이얼로그**가 표시되어야 합니다.

**확인할 것:**
- 잔액 부족 시 다이얼로그에 다음 정보가 모두 표시되는지:
  ```
  [주문 내역]
  - 전체 업로드 건수
  - 검증 오류 건수
  - 정상건 수
  - 정상건 주문 총액

  [잔액 현황]
  - 예치금: ○○원
  - 포인터: ○○원
  - 진행 중 주문: -○○원
  - 사용 가능 잔액: ○○원
  - 부족 금액: ○○원
  ```
- [예치금 충전하기] 버튼과 [닫기] 버튼이 있는지
- 기존의 검증 오류 다이얼로그(상품 오류, 필수필드 누락 등)와 디자인이 통일되어 있는지

**보완 방법 (단순 토스트만 뜨는 경우):**
- 서버에서 잔액 부족 응답 시 상세 데이터(주문건수, 정상건수, 총액, 잔액 상세, 부족금액)를 함께 반환
- 프론트엔드에서 해당 데이터를 받아 다이얼로그(Dialog/Modal) 컴포넌트로 표시
- 기존 검증 오류 다이얼로그와 동일한 UI 패턴 사용

---

### 항목 3: 동시성 제어 (SELECT FOR UPDATE)

**요구사항:** 동일 회원에 대해 동시에 정산/충전/차감이 발생할 경우 잔액이 꼬이지 않도록 DB 레벨에서 잠금이 필요합니다.

**확인할 것:**
- 배송중 전환 자동 정산 시, members 테이블의 해당 회원 잔액을 조회할 때 `SELECT ... FOR UPDATE` 또는 이에 준하는 잠금이 적용되어 있는지
- 관리자 예치금 충전/환급/포인터 지급 시에도 동일한 잠금이 적용되어 있는지
- Drizzle ORM 기준으로는 `db.select().from(members).where(...).for('update')` 형태

**확인 방법:**
```
1. 서버 코드에서 정산 관련 트랜잭션 내부를 확인
2. members 테이블에서 잔액을 읽는 쿼리에 FOR UPDATE가 있는지 확인
3. 없으면 추가
```

**보완 방법 (누락 시):**
- 정산/충전/환급/지급 API의 트랜잭션 내부에서 members 잔액 조회 시 FOR UPDATE 추가
- 이렇게 하면 같은 회원의 잔액을 동시에 수정하려는 다른 트랜잭션은 첫 번째 트랜잭션이 끝날 때까지 대기

---

### 항목 4: 배송중 전환 시 가격 확정 저장

**요구사항:** 배송중으로 전환할 때 해당 시점의 공급가를 pending_orders에 확정 저장해야 합니다. 배송중 전환 이후에는 current_products의 가격이 변경되어도 이미 확정된 가격이 유지되어야 합니다.

**확인할 것:**
- 배송중 전환 시 `current_products`의 회원등급별 공급가를 `pending_orders`의 가격 관련 컬럼에 저장하고 있는지
- 저장 후, 해당 주문의 공급가 조회 시 current_products가 아닌 pending_orders에 저장된 확정 가격을 사용하는지
- 정산 금액 계산도 이 확정 가격 기준으로 이루어지는지

**확인 방법:**
```
1. 배송중 전환 API 코드에서 pending_orders 업데이트 부분 확인
2. 가격 관련 컬럼(supply_price, confirmed_price 등)에 값이 저장되는지 확인
3. 정산 금액 계산 시 이 저장된 가격을 사용하는지 확인
```

**보완 방법 (누락 시):**
- pending_orders에 confirmed_price (또는 유사한) 컬럼이 없으면 추가
- 배송중 전환 트랜잭션 내에서: current_products에서 회원등급별 공급가 조회 → pending_orders에 저장 → 이 가격으로 정산 금액 계산
- 주문 조회/표시 시: 배송중 이상이면 pending_orders의 확정 가격 사용, 배송중 미만이면 current_products 가격 표시(미확정)

---

## 🚨 작업 시 주의사항

1. **검증 먼저**: 각 항목을 코드에서 확인한 후, 이미 구현되어 있으면 "확인 완료"로 보고하고 넘어가세요
2. **최소 변경**: 보완이 필요한 경우 해당 부분만 최소한으로 수정하세요
3. **기존 기능 보존**: 이미 정상 작동하는 정산 로직, 잔액 검증, 자동 정산 등을 건드리지 마세요
4. **테스트**: 보완 후 기존 기능(주문 등록, 배송중 전환, 충전/환급)이 정상 작동하는지 확인

## 📝 작업 언어 규칙

- 모든 작업 보고를 한글(한국어)로 작성해주세요

---

## ✅ 보고 양식

각 항목에 대해 다음 형식으로 보고해주세요:

```
[항목 1: 잔액 배너]
- 현재 상태: (이미 구현됨 / 부분 구현 / 미구현)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 2: 잔액 부족 다이얼로그]
- 현재 상태: (이미 구현됨 / 부분 구현 / 미구현)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 3: 동시성 제어]
- 현재 상태: (적용됨 / 미적용)
- 보완 내용: (수정한 내용 또는 "수정 불필요")

[항목 4: 가격 확정 저장]
- 현재 상태: (이미 구현됨 / 부분 구현 / 미구현)
- 보완 내용: (수정한 내용 또는 "수정 불필요")
```
