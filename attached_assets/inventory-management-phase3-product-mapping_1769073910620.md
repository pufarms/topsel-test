# 상품 매핑 (3단계)

## 📋 개요

**재고관리 > 상품 매핑** 페이지를 구현해주세요.
상품에 필요한 재료(원재료, 반재료, 부재료)를 매핑하는 페이지입니다.

---

## 🔗 매핑 개념

```
[상품]                              [재료 매핑]
부사사과 3kg 프리미엄 선물세트  =    부사 정품 4다이(원물) × 3.3
                                   3kg 선물박스 × 1
                                   고급 보자기 × 1

사과배 혼합 5kg 선물세트       =    부사 정품 4다이(원물) × 2.5
                                   신고 정품(원물) × 2.7
                                   5kg 선물박스 × 1
                                   고급 보자기 × 1
```

**특징:**
- 상품 1개 = 재료 여러 개 (복수 매핑)
- 원재료 + 반재료 + 부재료 혼합 가능
- 같은 종류 재료 여러 개 가능 (예: 원재료 2개)

---

## ⚠️ 매핑 필수 규칙

**매핑 완료된 상품만 "차주 예상공급가"로 전송 가능**

```
[상품등록(공급가계산)]
        │
        │ "차주 예상공급가로 전송" 클릭
        ▼
    매핑 체크 ──→ 미매핑 상품 있으면 ⚠️ 에러
        │
        │ 매핑 완료된 상품만
        ▼
[차주 예상공급가 상품]
```

---

## 🎨 페이지 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 상품 매핑                                                                         │
│ 상품에 필요한 재료를 매핑합니다. 매핑 완료된 상품만 차주 예상공급가로 전송할 수 있습니다.│
├──────────────────────────────────────────────────────────────────────────────────┤
│                                              [양식 다운로드] [엑셀 업로드]          │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 검색 필터                                                                       │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 상품코드: [________] 상품명: [______________] 매핑상태: [전체 ▼]              │ │
│ │                                                        [검색] [초기화]       │ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
├──────────────────────────────────────────────────────────────────────────────────┤
│ [+ 상품 추가]                                                      총 25개 상품  │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 상품 목록                                                                       │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 상품코드 │ 상품명                    │ 매핑상태 │ 재료 구성          │ 관리   │ │
│ ├──────────────────────────────────────────────────────────────────────────────┤ │
│ │ A001    │ 부사사과 3kg 프리미엄 선물  │ 🟢 완료  │ 부사 정품 4다이 외 2│ [상세] │ │
│ │ A002    │ 부사사과 5kg 가정용        │ 🟢 완료  │ 부사 정품 4다이 외 1│ [상세] │ │
│ │ A003    │ 사과배 혼합 5kg 선물       │ 🟢 완료  │ 부사 정품 외 3     │ [상세] │ │
│ │ B001    │ 신고배 3kg 선물           │ 🔴 미완료│ -                 │ [매핑] │ │
│ │ B002    │ 신고배 5kg 가정용         │ 🔴 미완료│ -                 │ [매핑] │ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│                              [1] [2] [3] ... [5]                                 │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 테이블 컬럼

| 순번 | 컬럼명 | 설명 |
|:----:|--------|------|
| 1 | 상품코드 | 고유 코드 |
| 2 | 상품명 | 상품 이름 |
| 3 | 매핑상태 | 🟢 완료 / 🔴 미완료 |
| 4 | 재료 구성 | 첫 번째 재료명 + "외 N" 또는 "-" |
| 5 | 관리 | [상세] 또는 [매핑] 버튼 |

### 재료 구성 표시 규칙

| 재료 개수 | 표시 예시 |
|:--------:|----------|
| 0개 (미매핑) | - |
| 1개 | 부사 정품 4다이 |
| 2개 | 부사 정품 4다이 외 1 |
| 3개 | 부사 정품 4다이 외 2 |

### 관리 버튼 규칙

| 매핑상태 | 버튼 |
|---------|------|
| 🟢 완료 | [상세] |
| 🔴 미완료 | [매핑] |

---

## 🔍 검색 필터

| 필터 | 타입 | 설명 |
|------|------|------|
| 상품코드 | 텍스트 | 부분 일치 검색 |
| 상품명 | 텍스트 | 부분 일치 검색 |
| 매핑상태 | 드롭다운 | 전체 / 완료 / 미완료 |

---

## 🔧 기능 상세

### 1) 상품 추가

#### [+ 상품 추가] 클릭 시 모달

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 추가                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ■ 추가 방식 선택                                             │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 상품등록에서 가져오기                                  │ │
│ │   상품등록(공급가계산)에 있는 상품 중 선택                 │ │
│ │                                                         │ │
│ │ ○ 직접 입력                                              │ │
│ │   상품코드와 상품명을 직접 입력                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                              [취소]  [다음]                  │
└─────────────────────────────────────────────────────────────┘
```

#### "상품등록에서 가져오기" 선택 시

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 선택                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 검색: [________________] 🔍                                 │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ □ │ 상품코드 │ 상품명                                   │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │ ☐ │ A001    │ 부사사과 3kg 프리미엄 선물세트            │ │
│ │ ☐ │ A002    │ 부사사과 5kg 가정용                      │ │
│ │ ☐ │ B001    │ 신고배 3kg 선물                         │ │
│ │ ☐ │ B002    │ 신고배 5kg 가정용                        │ │
│ │ ☐ │ C001    │ 사과배 혼합 5kg 선물                     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ※ 이미 매핑 목록에 있는 상품은 표시되지 않습니다.             │
│                                                             │
│                    [취소]  [선택한 5개 추가]                  │
└─────────────────────────────────────────────────────────────┘
```

#### "직접 입력" 선택 시

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 직접 입력                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 상품코드: [____________]                                    │
│                                                             │
│ 상품명:   [____________________________]                    │
│                                                             │
│ ※ 이미 존재하는 상품코드는 추가할 수 없습니다.                 │
│                                                             │
│                              [취소]  [추가]                  │
└─────────────────────────────────────────────────────────────┘
```

---

### 2) 상세 보기

#### [상세] 클릭 시 모달

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 매핑 상세                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 상품코드: A001                                               │
│ 상품명:   부사사과 3kg 프리미엄 선물세트                       │
│ 매핑상태: 🟢 완료                                            │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ■ 재료 구성 (3개)                                            │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │  No │ 재료명                           │ 수량           │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │  1  │ 부사 정품 4다이(원물)             │ 3.3           │ │
│ │  2  │ 3kg 선물박스                      │ 1             │ │
│ │  3  │ 고급 보자기                       │ 1             │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                       [삭제]     [닫기]  [수정]              │
└─────────────────────────────────────────────────────────────┘
```

---

### 3) 매핑 편집

#### [매핑] 또는 [수정] 클릭 시 모달

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 매핑 편집                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 상품코드: A001                                               │
│ 상품명:   부사사과 3kg 프리미엄 선물세트                       │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ■ 재료 구성                                    [+ 재료 추가] │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │  재료명                              │ 수량   │ 삭제    │ │
│ ├─────────────────────────────────────────────────────────┤ │
│ │  부사 정품 4다이(원물)     [변경]    │ [3.3 ] │  [X]    │ │
│ │  3kg 선물박스             [변경]    │ [1   ] │  [X]    │ │
│ │  고급 보자기              [변경]    │ [1   ] │  [X]    │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ※ 재료는 1개 이상 등록해야 매핑 완료 상태가 됩니다.           │
│                                                             │
│                              [취소]  [저장]                  │
└─────────────────────────────────────────────────────────────┘
```

#### [+ 재료 추가] 클릭 시

```
┌─────────────────────────────────────────────────────────────┐
│ 재료 선택                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 검색: [부사________________] 🔍                             │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 부사 정품 4다이(원물)                                  │ │
│ │ ○ 부사 정품 5다이(원물)                                  │ │
│ │ ○ 부사 상2번(원물)                                       │ │
│ │ ○ 부사 상2번(선별)                                       │ │
│ │ ○ 부사 보통1번(원물)                                     │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 수량: [_______] (소수점 1자리까지)                           │
│                                                             │
│                              [취소]  [추가]                  │
└─────────────────────────────────────────────────────────────┘
```

#### [변경] 클릭 시 - 재료 변경

```
┌─────────────────────────────────────────────────────────────┐
│ 재료 변경                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 현재: 부사 정품 4다이(원물)                                   │
│                                                             │
│ 검색: [________________] 🔍                                 │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ 부사 정품 4다이(원물)  ← 현재 선택                      │ │
│ │ ○ 부사 정품 5다이(원물)                                  │ │
│ │ ○ 부사 상2번(원물)                                       │ │
│ │ ○ 부사 상2번(선별)                                       │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                              [취소]  [변경]                  │
└─────────────────────────────────────────────────────────────┘
```

---

### 4) 상품 삭제

#### 상세 모달에서 [삭제] 클릭 시

```
┌─────────────────────────────────────────────────────────────┐
│ 상품 매핑 삭제                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ⚠️ 이 상품의 매핑 정보를 삭제하시겠습니까?                    │
│                                                             │
│ 상품코드: A001                                               │
│ 상품명:   부사사과 3kg 프리미엄 선물세트                       │
│                                                             │
│ ※ 상품 자체는 삭제되지 않고, 재료 매핑 정보만 삭제됩니다.      │
│                                                             │
│                              [취소]  [삭제]                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 📥 엑셀 기능

### [양식 다운로드] 버튼

클릭 시 엑셀 템플릿 파일 다운로드

**파일명:** `상품_매핑_양식.xlsx`

> ⚠️ **탑셀러 엑셀 파일 규칙**
> - 모든 엑셀 파일은 **xlsx 또는 xls 형식**만 사용
> - **CSV 형식 사용 금지**
> - 다운로드 파일: `.xlsx` 형식
> - 업로드 허용: `.xlsx`, `.xls` 형식

#### 엑셀 양식 구조

| 상품코드 | 상품명 | 재료명 | 수량 |
|---------|--------|--------|------|
| A001 | 부사 3kg 선물 | 부사 정품 4다이(원물) | 3.3 |
| A001 | 부사 3kg 선물 | 3kg 선물박스 | 1 |
| A001 | 부사 3kg 선물 | 고급 보자기 | 1 |
| A002 | 부사 5kg 가정 | 부사 정품 4다이(원물) | 5.5 |
| A002 | 부사 5kg 가정 | 5kg 일반박스 | 1 |
| B001 | 신고 3kg 선물 | | |

**※ 같은 상품코드가 여러 행 = 여러 재료 매핑**
**※ 재료명/수량이 비어있으면 상품만 추가 (매핑은 화면에서)**

#### 양식 파일 안내문

```
[상품 매핑 양식 안내]

1. 상품코드: 상품 고유 코드 (필수)
2. 상품명: 상품 이름 (필수)
3. 재료명: 등록된 재료명과 정확히 일치해야 함 (선택)
4. 수량: 숫자, 소수점 1자리까지 (선택)

※ 같은 상품에 여러 재료를 매핑하려면 상품코드를 반복해서 입력하세요.
※ 재료명/수량이 비어있으면 상품만 추가되고, 재료 매핑은 화면에서 진행합니다.
※ 재료명은 "재료 관리"에 등록된 이름과 정확히 일치해야 합니다.
※ 이미 존재하는 상품코드는 재료 매핑 정보가 업데이트됩니다.
```

---

### [엑셀 업로드] 버튼

클릭 시 파일 업로드 모달

```
┌───────────────────────────────────────────┐
│ 엑셀 업로드                                │
├───────────────────────────────────────────┤
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │                                     │  │
│  │     📄 엑셀 파일을 드래그하거나      │  │
│  │        클릭하여 업로드               │  │
│  │                                     │  │
│  │     (.xlsx, .xls 파일만 가능)       │  │
│  │                                     │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  [양식 다운로드]                           │
│                                           │
│                   [취소]  [업로드]         │
└───────────────────────────────────────────┘
```

---

### 엑셀 업로드 처리 로직

```javascript
const processExcelUpload = async (file) => {
  const rows = parseExcel(file);
  
  // 상품코드별로 그룹핑
  const productGroups = groupBy(rows, '상품코드');
  
  const results = {
    productOnly: [],      // 상품만 (매핑 없음)
    productWithMapping: [], // 상품 + 매핑 정보
    errors: []
  };
  
  for (const [productCode, productRows] of Object.entries(productGroups)) {
    const firstRow = productRows[0];
    
    // 필수값 체크
    if (!productCode || !firstRow.상품명) {
      results.errors.push(`상품코드 또는 상품명 누락`);
      continue;
    }
    
    // 재료 매핑 정보 확인
    const materials = [];
    for (const row of productRows) {
      if (row.재료명 && row.수량) {
        // 재료명으로 재료코드 자동 매칭
        const material = await db.materials.findFirst({
          where: { materialName: row.재료명 }
        });
        
        if (!material) {
          results.errors.push(`"${row.재료명}" 재료가 존재하지 않습니다.`);
          continue;
        }
        
        materials.push({
          materialCode: material.materialCode,  // 자동 매칭
          materialName: row.재료명,
          quantity: parseFloat(row.수량)
        });
      }
    }
    
    if (materials.length > 0) {
      results.productWithMapping.push({
        productCode,
        productName: firstRow.상품명,
        materials
      });
    } else {
      results.productOnly.push({
        productCode,
        productName: firstRow.상품명
      });
    }
  }
  
  return results;
};
```

---

### 업로드 결과 확인 모달

```
┌───────────────────────────────────────────────────────────────┐
│ 엑셀 업로드 결과                                               │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│ 📊 분석 결과                                                   │
│ ─────────────────────────────────────────────────────────     │
│ 전체 상품: 10개                                                │
│ ├── 📦 상품만 (매핑 없음): 3개 → 화면에서 매핑 필요            │
│ └── ✅ 상품 + 매핑 포함: 5개                                   │
│                                                               │
│ ■ 매핑 정보 확인                                               │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ ▼ A001 부사사과 3kg 선물                                  │ │
│ │   • 부사 정품 4다이(원물) × 3.3                           │ │
│ │   • 3kg 선물박스 × 1                                      │ │
│ │   • 고급 보자기 × 1                                       │ │
│ │                                                           │ │
│ │ ▼ A002 부사사과 5kg 가정                                  │ │
│ │   • 부사 정품 4다이(원물) × 5.5                           │ │
│ │   • 5kg 일반박스 × 1                                      │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                               │
│ ⚠️ 오류: 2건                                                  │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ • "부사 정품 3다이" 재료가 존재하지 않습니다.               │ │
│ │ • C003: 상품명 누락                                       │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                               │
│ ※ 오류가 있는 항목은 제외하고 등록됩니다.                       │
│                                                               │
│                          [취소]  [8개 상품 저장하기]           │
└───────────────────────────────────────────────────────────────┘
```

---

## 📊 데이터 스키마

### product_mappings (상품 매핑 - 상품 정보)

```typescript
{
  id: number;
  productCode: string;       // 상품코드 (unique)
  productName: string;       // 상품명
  mappingStatus: 'complete' | 'incomplete';  // 매핑상태
  createdAt: Date;
  updatedAt: Date;
}
```

### product_material_mappings (상품-재료 매핑)

```typescript
{
  id: number;
  productCode: string;       // 상품코드 (FK)
  materialCode: string;      // 재료코드 (FK) - 자동 저장
  materialName: string;      // 재료명 - 표시용
  quantity: number;          // 수량 (소수점 1자리)
  createdAt: Date;
  updatedAt: Date;
}
```

### 매핑상태 판단 로직

```javascript
// 재료가 1개 이상이면 '완료', 0개면 '미완료'
const mappingStatus = materials.length > 0 ? 'complete' : 'incomplete';
```

---

## 🔔 알림

| 상황 | 타입 | 메시지 |
|------|------|--------|
| 상품 추가 | ✅ success | "N개 상품이 추가되었습니다." |
| 매핑 저장 | ✅ success | "매핑 정보가 저장되었습니다." |
| 매핑 삭제 | ✅ success | "매핑 정보가 삭제되었습니다." |
| 엑셀 업로드 | ✅ success | "N개 상품이 등록되었습니다." |
| 재료 없음 | ⚠️ error | "재료를 1개 이상 추가해주세요." |
| 재료명 불일치 | ⚠️ error | "\"[재료명]\" 재료가 존재하지 않습니다." |
| 중복 상품코드 | ⚠️ warning | "이미 존재하는 상품코드입니다. 매핑 정보가 업데이트됩니다." |

---

## 🔌 API 엔드포인트

```
# 상품 매핑 목록
GET    /api/product-mappings                    # 목록 조회 (필터: productCode, productName, mappingStatus)
POST   /api/product-mappings                    # 상품 추가
DELETE /api/product-mappings/:productCode       # 상품 매핑 삭제

# 재료 매핑
GET    /api/product-mappings/:productCode/materials    # 재료 목록 조회
PUT    /api/product-mappings/:productCode/materials    # 재료 매핑 저장 (전체 교체)

# 상품등록에서 가져오기
GET    /api/product-mappings/available-products        # 매핑 목록에 없는 상품등록 상품 조회

# 엑셀
GET    /api/product-mappings/template                  # 양식 다운로드
POST   /api/product-mappings/upload                    # 엑셀 업로드
```

---

## 🔗 상품등록(공급가계산) 연동

### 매핑 체크 추가

"차주 예상공급가로 전송" 클릭 시:

```javascript
const handleSendToNextWeek = async () => {
  // 1. 공급가 검증 (기존)
  // ...
  
  // 2. 매핑 검증 (추가!)
  const unmappedProducts = products.filter(p => {
    const mapping = await getProductMapping(p.productCode);
    return !mapping || mapping.mappingStatus === 'incomplete';
  });
  
  if (unmappedProducts.length > 0) {
    showAlert({
      type: 'error',
      title: '전송 실패',
      message: `상품코드 [${unmappedProducts[0].productCode}]의 재료 매핑이 필요합니다.`,
      details: unmappedProducts.map(p => `${p.productCode} - ${p.productName}`)
    });
    return;
  }
  
  // 3. 신규 상품 안내 (기존)
  // ...
  
  // 4. 전송 (기존)
  // ...
};
```

### 상품등록 테이블에 매핑상태 컬럼 추가

```
│ □ │...│상품코드│상품명      │...│매핑상태│관리        │
│ □ │...│A001   │부사3kg선물 │...│🟢완료 │[매핑]      │
│ □ │...│A002   │부사5kg가정 │...│🔴미완료│[매핑]     │
```

- [매핑] 버튼 클릭 → 재고관리/상품 매핑 페이지로 이동

---

## ✅ 체크리스트

### 페이지 기본
- [ ] 상품 목록 테이블
- [ ] 검색 필터 (상품코드, 상품명, 매핑상태)
- [ ] 페이지네이션
- [ ] 재료 구성 요약 표시 (첫 번째 재료 외 N)

### 상품 추가
- [ ] [+ 상품 추가] 버튼
- [ ] 상품등록에서 가져오기
- [ ] 직접 입력

### 상세/편집
- [ ] [상세] 버튼 → 상세 모달
- [ ] [매핑] / [수정] 버튼 → 편집 모달
- [ ] [+ 재료 추가] → 재료 선택 (검색)
- [ ] 재료 수량 입력 (소수점 1자리)
- [ ] 재료 변경
- [ ] 재료 삭제 [X]
- [ ] 상품 매핑 삭제

### 엑셀 기능
- [ ] [양식 다운로드] 버튼 (.xlsx)
- [ ] [엑셀 업로드] 버튼 (.xlsx, .xls)
- [ ] 자동 판단 (상품만 / 상품+매핑)
- [ ] 재료명 → 재료코드 자동 매칭
- [ ] 업로드 결과 확인 모달
- [ ] 오류 표시

### 상품등록 연동
- [ ] 상품등록 테이블에 "매핑상태" 컬럼 추가
- [ ] [매핑] 버튼 추가 (상품 매핑 페이지로 이동)
- [ ] 전송 시 매핑 검증 추가

### 데이터 처리
- [ ] 재료코드 자동 저장 (화면에 표시 안 함)
- [ ] 매핑상태 자동 판단 (재료 1개 이상 = 완료)
- [ ] 수량 소수점 1자리

---

## ⚠️ 중요

| 항목 | 설명 |
|------|------|
| **복수 재료** | 상품 1개에 재료 여러 개 매핑 가능 |
| **재료코드 자동** | 사용자는 재료명만 선택, 재료코드는 자동 저장 |
| **매핑 필수** | 매핑 완료된 상품만 차주 예상공급가로 전송 가능 |
| **수량 소수점** | 1자리까지 (예: 3.3, 5.5) |
| **엑셀 자동 판단** | 재료 정보 있으면 매핑까지, 없으면 상품만 |
| **엑셀 형식** | xlsx, xls만 허용 (CSV 사용 금지) |
