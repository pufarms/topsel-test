# 재고관리 탭 수정 + 재료 관리 (통합)

## 📋 개요

재고관리 메뉴 구조를 수정하고, **재료 관리** 페이지를 구현해주세요.
기존 "재료 카테고리 관리" 메뉴를 삭제하고, "재료 관리"에서 카테고리와 재료를 모두 관리합니다.

---

## 🗂️ 메뉴 구조 변경

### 기존 (6개)

```
재고관리
├── 재료 카테고리 관리  ← 삭제!
├── 재료 관리
├── 상품 매핑
├── 재고 현황
├── 입고 관리
└── 재고 이력
```

### 변경 후 (5개)

```
재고관리
├── 재료 관리          ← 카테고리 + 재료 통합!
├── 상품 매핑
├── 재고 현황
├── 입고 관리
└── 재고 이력
```

---

## 🎨 재료 관리 페이지 레이아웃

### 전체 구조 (3단 레이아웃)

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 재료 관리                                                                         │
│ 원재료, 반재료, 부재료의 카테고리와 재료를 관리합니다.                                │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                    [양식 다운로드] [엑셀 일괄등록] │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ┌──────────────────┐ ┌──────────────────┐ ┌────────────────────────────────────┐│
│ │ ■ 대분류         │ │ ■ 중분류         │ │ ■ 재료 목록                        ││
│ │                  │ │                  │ │                                    ││
│ │ [+ 대분류 추가]  │ │ [+ 중분류 추가]  │ │ [+ 재료 등록]          [선택 삭제] ││
│ │ ──────────────── │ │ ──────────────── │ │ ────────────────────────────────── ││
│ │ 🍎 사과     [···]│ │ 부사        [···]│ │ □ │타입  │재료명        │현재재고 ││
│ │ 🍐 배      [···]│ │ 홍로        [···]│ │ □ │원재료│부사 정품 4다이 │  150.0 ││
│ │ 🍇 포도     [···]│ │ 아오리      [···]│ │ □ │원재료│부사 상2번(원물)│   80.5 ││
│ │ 🍊 감      [···]│ │ 시나노골드   [···]│ │ □ │반재료│부사 상2번(선별)│   45.0 ││
│ │ 🍊 귤      [···]│ │                  │ │ □ │원재료│부사 보통1번    │  200.0 ││
│ │ 📦 부재료   [···]│ │                  │ │                                    ││
│ │                  │ │                  │ │                                    ││
│ └──────────────────┘ └──────────────────┘ └────────────────────────────────────┘│
│  선택: 사과           선택: 전체            총 4개                               │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📐 레이아웃 비율

| 영역 | 너비 비율 | 설명 |
|------|:--------:|------|
| 대분류 | 20% | 왼쪽 고정 |
| 중분류 | 20% | 중앙 |
| 재료 목록 | 60% | 오른쪽 (메인) |

---

## 🔧 기능 상세

### 1) 대분류 관리

#### 대분류 목록
- 왼쪽 패널에 대분류 목록 표시
- 클릭 시 선택 (하이라이트)
- 선택된 대분류의 중분류가 중앙 패널에 표시
- 선택된 대분류의 재료가 오른쪽 패널에 표시

#### [+ 대분류 추가]

```
┌─────────────────────────────────┐
│ 대분류 추가                      │
├─────────────────────────────────┤
│                                 │
│ 대분류명: [____________]        │
│                                 │
│           [취소] [추가]         │
└─────────────────────────────────┘
```

#### [...] 메뉴 (수정/삭제)

```
┌─────────┐
│ 수정    │
│ 삭제    │
└─────────┘
```

**삭제 시 확인:**
```
┌───────────────────────────────────┐
│ 대분류 삭제                        │
├───────────────────────────────────┤
│                                   │
│ ⚠️ "사과" 대분류를 삭제하시겠습니까? │
│                                   │
│ 하위 중분류와 재료도 함께           │
│ 삭제됩니다.                        │
│                                   │
│ ※ 재료가 상품에 매핑되어 있으면     │
│   삭제할 수 없습니다.              │
│                                   │
│             [취소] [삭제]          │
└───────────────────────────────────┘
```

---

### 2) 중분류 관리

#### 중분류 목록
- 중앙 패널에 선택된 대분류의 중분류 표시
- 대분류 미선택 시: "대분류를 선택해주세요"
- 클릭 시 선택 (하이라이트)
- 선택된 중분류의 재료만 오른쪽 패널에 표시

#### [+ 중분류 추가]

```
┌─────────────────────────────────┐
│ 중분류 추가                      │
├─────────────────────────────────┤
│                                 │
│ 대분류: 사과 (자동 표시)          │
│ 중분류명: [____________]        │
│                                 │
│           [취소] [추가]         │
└─────────────────────────────────┘
```

#### [...] 메뉴 (수정/삭제)
- 대분류와 동일한 방식

---

### 3) 재료 목록

#### 재료 필터링 동작

| 대분류 선택 | 중분류 선택 | 재료 목록 표시 |
|:-----------:|:-----------:|---------------|
| ❌ | ❌ | 전체 재료 |
| ✅ 사과 | ❌ | 사과 대분류의 모든 재료 |
| ✅ 사과 | ✅ 부사 | 사과 > 부사의 재료만 |

#### 재료 테이블 컬럼

| 순번 | 컬럼명 | 설명 |
|:----:|--------|------|
| 1 | 체크박스 | 선택용 |
| 2 | 재료타입 | 원재료 / 반재료 / 부재료 |
| 3 | 대분류 | 카테고리 |
| 4 | 중분류 | 카테고리 |
| 5 | 재료코드 | 고유 코드 |
| 6 | 재료명 | 재료 이름 |
| 7 | 현재재고 | 수량 (소수점 1자리) |
| 8 | 관리 | [수정] 버튼 |

---

### 4) 재료 등록

#### [+ 재료 등록] 클릭 시 모달

```
┌─────────────────────────────────────────┐
│ 재료 등록                                │
├─────────────────────────────────────────┤
│                                         │
│ 재료타입: [원재료 ▼]                     │
│           ○ 원재료  ○ 반재료  ○ 부재료   │
│                                         │
│ 대분류:   [선택 ▼]    [+ 새 대분류]      │
│                                         │
│ 중분류:   [선택 ▼]    [+ 새 중분류]      │
│                                         │
│ 재료코드: [____________] (자동생성 가능)  │
│                                         │
│ 재료명:   [________________________]    │
│                                         │
│ 초기재고: [0         ] (소수점 1자리)    │
│                                         │
│                   [취소]  [등록]         │
└─────────────────────────────────────────┘
```

#### [+ 새 대분류] / [+ 새 중분류] 클릭 시
- 카테고리 관리 페이지로 이동 없이 바로 추가 가능
- 추가 후 자동 선택됨

#### 재료코드 규칙 (자동생성 예시)
```
원재료: R001, R002, R003...
반재료: S001, S002, S003...
부재료: B001, B002, B003...
```

---

### 5) 재료 수정

#### [수정] 버튼 클릭 시 모달

```
┌─────────────────────────────────────────┐
│ 재료 수정                                │
├─────────────────────────────────────────┤
│                                         │
│ 재료타입: [원재료 ▼]                     │
│                                         │
│ 대분류:   [사과 ▼]      [+ 새 대분류]    │
│                                         │
│ 중분류:   [부사 ▼]      [+ 새 중분류]    │
│                                         │
│ 재료코드: [R001      ] (수정 불가)       │
│                                         │
│ 재료명:   [부사 정품 4다이(원물)___]     │
│                                         │
│ 현재재고: 150.0 (입고 관리에서 변경)     │
│                                         │
│                   [취소]  [저장]         │
└─────────────────────────────────────────┘
```

**주의:** 
- 재료코드는 수정 불가
- 현재재고는 "입고 관리"에서만 변경 (여기서는 조회만)

---

### 6) 재료 삭제

#### [선택 삭제] 클릭 시

```
┌───────────────────────────────────────┐
│ 재료 삭제                              │
├───────────────────────────────────────┤
│                                       │
│ ⚠️ 선택한 3개 재료를 삭제하시겠습니까?  │
│                                       │
│ • R001 - 부사 정품 4다이(원물)         │
│ • R002 - 부사 상2번(원물)              │
│ • S001 - 부사 상2번(선별)              │
│                                       │
│ ※ 상품에 매핑된 재료는 삭제할 수        │
│   없습니다.                           │
│                                       │
│               [취소] [삭제]            │
└───────────────────────────────────────┘
```

---

## 📥 엑셀 일괄 등록

### [양식 다운로드] 버튼

클릭 시 엑셀 템플릿 파일 다운로드

**파일명:** `재료_등록_양식.xlsx`

#### 엑셀 양식 구조

| 재료타입 | 대분류 | 중분류 | 재료코드 | 재료명 | 초기재고 |
|---------|--------|--------|----------|--------|---------|
| 원재료 | 사과 | 부사 | R001 | 부사 정품 4다이(원물) | 0 |
| 원재료 | 사과 | 부사 | R002 | 부사 상2번(원물) | 0 |
| 반재료 | 사과 | 부사 | S001 | 부사 상2번(선별) | 0 |
| 부재료 | 부재료 | 박스 | B001 | 3kg 선물박스 | 0 |

#### 양식 파일 상단 안내문 (첫 번째 시트 또는 상단 행)

```
[재료 등록 양식 안내]

1. 재료타입: "원재료", "반재료", "부재료" 중 하나 입력
2. 대분류: 과일 종류 (사과, 배, 포도 등) 또는 "부재료"
3. 중분류: 품종 (부사, 홍로 등) 또는 부재료 종류 (박스, 아웃박스, 보자기)
4. 재료코드: 고유 코드 (중복 불가, 미입력 시 자동 생성)
5. 재료명: 재료 이름
6. 초기재고: 숫자 (소수점 1자리까지, 미입력 시 0)

※ 대분류/중분류가 없으면 자동으로 생성됩니다.
※ 재료코드가 이미 존재하면 해당 행은 건너뜁니다.
```

---

### [엑셀 일괄등록] 버튼

클릭 시 파일 업로드 모달

```
┌───────────────────────────────────────────┐
│ 엑셀 일괄 등록                             │
├───────────────────────────────────────────┤
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │                                     │  │
│  │     📄 엑셀 파일을 드래그하거나      │  │
│  │        클릭하여 업로드               │  │
│  │                                     │  │
│  │     (.xlsx, .xls 파일만 가능)       │  │
│  │                                     │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  [양식 다운로드]                           │
│                                           │
│                   [취소]  [업로드]         │
└───────────────────────────────────────────┘
```

---

### 엑셀 업로드 처리 로직

```javascript
const processExcelUpload = async (file) => {
  // 1. 엑셀 파일 파싱
  const rows = parseExcel(file);
  
  // 2. 검증
  const errors = [];
  const validRows = [];
  
  for (const row of rows) {
    // 필수값 체크
    if (!row.재료타입 || !row.대분류 || !row.중분류 || !row.재료명) {
      errors.push(`행 ${row.rowNum}: 필수값 누락`);
      continue;
    }
    
    // 재료타입 체크
    if (!['원재료', '반재료', '부재료'].includes(row.재료타입)) {
      errors.push(`행 ${row.rowNum}: 재료타입이 올바르지 않습니다`);
      continue;
    }
    
    // 재료코드 중복 체크
    if (row.재료코드) {
      const exists = await checkMaterialCodeExists(row.재료코드);
      if (exists) {
        errors.push(`행 ${row.rowNum}: 재료코드 [${row.재료코드}] 이미 존재`);
        continue;
      }
    }
    
    validRows.push(row);
  }
  
  // 3. 결과 표시
  return { validRows, errors };
};
```

---

### 업로드 결과 확인 모달

```
┌───────────────────────────────────────────────┐
│ 업로드 결과                                    │
├───────────────────────────────────────────────┤
│                                               │
│ 📊 분석 결과                                   │
│ ─────────────────────────────────────────     │
│ 전체: 50행                                    │
│ ✅ 등록 가능: 47행                             │
│ ⚠️ 오류: 3행                                  │
│                                               │
│ ■ 오류 목록                                   │
│ ┌───────────────────────────────────────────┐ │
│ │ • 행 15: 필수값 누락 (재료명)              │ │
│ │ • 행 23: 재료코드 [R001] 이미 존재         │ │
│ │ • 행 41: 재료타입이 올바르지 않습니다       │ │
│ └───────────────────────────────────────────┘ │
│                                               │
│ ※ 오류가 있는 행은 제외하고 등록됩니다.         │
│                                               │
│               [취소]  [47개 등록하기]          │
└───────────────────────────────────────────────┘
```

---

### 등록 완료 알림

```
✅ 47개 재료가 등록되었습니다.
   - 신규 대분류 2개 생성
   - 신규 중분류 5개 생성
```

---

## 📊 데이터 스키마

### material_categories_large (대분류)

```typescript
{
  id: number;
  name: string;              // 대분류명 (예: 사과, 배, 부재료)
  sortOrder: number;         // 정렬 순서
  createdAt: Date;
  updatedAt: Date;
}
```

### material_categories_medium (중분류)

```typescript
{
  id: number;
  largeCategoryId: number;   // 대분류 FK
  name: string;              // 중분류명 (예: 부사, 홍로, 박스)
  sortOrder: number;         // 정렬 순서
  createdAt: Date;
  updatedAt: Date;
}
```

### materials (재료)

```typescript
{
  id: number;
  materialType: 'raw' | 'semi' | 'sub';  // 원재료/반재료/부재료
  largeCategoryId: number;    // 대분류 FK
  mediumCategoryId: number;   // 중분류 FK
  materialCode: string;       // 재료코드 (unique)
  materialName: string;       // 재료명
  currentStock: number;       // 현재재고 (소수점 1자리)
  createdAt: Date;
  updatedAt: Date;
}
```

### 재료타입 값

| DB 값 | 표시 값 |
|-------|--------|
| raw | 원재료 |
| semi | 반재료 |
| sub | 부재료 |

---

## 🔔 알림

| 상황 | 타입 | 메시지 |
|------|------|--------|
| 카테고리 추가 | ✅ success | "대분류가 추가되었습니다." / "중분류가 추가되었습니다." |
| 카테고리 삭제 | ✅ success | "대분류가 삭제되었습니다." / "중분류가 삭제되었습니다." |
| 재료 등록 | ✅ success | "재료가 등록되었습니다." |
| 재료 수정 | ✅ success | "재료가 수정되었습니다." |
| 재료 삭제 | ✅ success | "N개 재료가 삭제되었습니다." |
| 엑셀 등록 | ✅ success | "N개 재료가 등록되었습니다." |
| 삭제 불가 (매핑됨) | ⚠️ error | "상품에 매핑된 재료는 삭제할 수 없습니다." |
| 중복 코드 | ⚠️ error | "이미 존재하는 재료코드입니다." |

---

## 🔌 API 엔드포인트

```
# 대분류
GET    /api/material-categories/large              # 대분류 목록
POST   /api/material-categories/large              # 대분류 추가
PUT    /api/material-categories/large/:id          # 대분류 수정
DELETE /api/material-categories/large/:id          # 대분류 삭제

# 중분류
GET    /api/material-categories/medium             # 중분류 목록 (쿼리: largeCategoryId)
POST   /api/material-categories/medium             # 중분류 추가
PUT    /api/material-categories/medium/:id         # 중분류 수정
DELETE /api/material-categories/medium/:id         # 중분류 삭제

# 재료
GET    /api/materials                              # 재료 목록 (필터: type, largeCategoryId, mediumCategoryId)
POST   /api/materials                              # 재료 등록
PUT    /api/materials/:id                          # 재료 수정
DELETE /api/materials/:id                          # 재료 삭제
DELETE /api/materials/bulk                         # 재료 선택 삭제

# 엑셀
GET    /api/materials/template                     # 양식 다운로드
POST   /api/materials/upload                       # 엑셀 일괄 등록
```

---

## ✅ 체크리스트

### 메뉴 구조 수정
- [ ] "재료 카테고리 관리" 메뉴 삭제
- [ ] 재고관리 메뉴 5개로 변경

### 대분류 관리
- [ ] 대분류 목록 표시
- [ ] 대분류 추가 (모달)
- [ ] 대분류 수정 (모달)
- [ ] 대분류 삭제 (확인 모달)
- [ ] 대분류 선택 시 하이라이트

### 중분류 관리
- [ ] 중분류 목록 표시 (선택된 대분류 기준)
- [ ] 대분류 미선택 시 안내 메시지
- [ ] 중분류 추가 (모달)
- [ ] 중분류 수정 (모달)
- [ ] 중분류 삭제 (확인 모달)

### 재료 관리
- [ ] 재료 목록 표시 (카테고리 필터 연동)
- [ ] 재료 등록 (모달)
- [ ] 재료 수정 (모달)
- [ ] 재료 선택 삭제
- [ ] 재료코드 자동 생성
- [ ] 재료 등록 시 새 카테고리 바로 추가 가능

### 엑셀 기능
- [ ] 양식 다운로드 버튼
- [ ] 엑셀 템플릿 파일 생성
- [ ] 엑셀 일괄 등록 버튼
- [ ] 파일 업로드 모달
- [ ] 엑셀 파싱 및 검증
- [ ] 오류 목록 표시
- [ ] 유효한 행만 등록
- [ ] 신규 카테고리 자동 생성

### 검증
- [ ] 중복 재료코드 체크
- [ ] 매핑된 재료/카테고리 삭제 방지
- [ ] 필수값 체크

---

## ⚠️ 중요

| 항목 | 설명 |
|------|------|
| **메뉴 축소** | 6개 → 5개 (재료 카테고리 관리 삭제) |
| **3단 레이아웃** | 대분류 / 중분류 / 재료 목록 |
| **카테고리 연동** | 카테고리 선택 → 재료 목록 필터링 |
| **바로 추가** | 재료 등록 시 카테고리 없으면 바로 추가 가능 |
| **재고 수정** | 재료 수정에서는 불가, "입고 관리"에서만 |
| **수량 소수점** | 1자리까지 (예: 150.0, 80.5) |
| **엑셀 등록** | 양식 다운로드 → 작성 → 일괄 업로드 |
| **삭제 제한** | 상품에 매핑된 재료/카테고리 삭제 불가 |
