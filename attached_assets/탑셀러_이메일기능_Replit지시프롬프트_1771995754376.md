# 탑셀러 이메일 발송 시스템 구축 지시서

Resend를 사용해서 이메일 발송 시스템을 구축해줘.

## ⚠️ 절대 원칙
- 기존 코드, DB 구조, UI, 기능은 절대 수정하지 말 것
- 새로운 파일 추가와 기존 파일에 코드 추가만 허용
- TypeScript 타입 오류 없도록 작성
- 모든 에러는 try-catch로 처리

---

## STEP 1 — 패키지 설치

```
npm install resend
```

---

## STEP 2 — 환경변수 2개 등록

```
RESEND_API_KEY = (Resend에서 발급받은 API Key)
SENDER_EMAIL = noreply@topsel.kr
```

---

## STEP 3 — 이메일 유틸 파일 생성

`server/utils/email.ts` 파일을 새로 만들어줘.

아래 2가지 함수를 작성해줘:

```
sendVerificationCode(toEmail, code, type)
- type: 'email_change' | 'signup'
- 탑셀러 브랜드 스타일 한국어 HTML 템플릿
- 인증번호 6자리 크고 굵게 표시
- 유효시간 5분 안내 문구 포함

sendTempPassword(toEmail, tempPassword)
- 임시 비밀번호 발송용
- 탑셀러 브랜드 스타일 한국어 HTML 템플릿
- 보안을 위해 로그인 후 즉시 비밀번호 변경 안내 문구 포함
```

---

## STEP 4 — DB 테이블 추가

기존 DB 스키마에 `email_verifications` 테이블만 추가해줘.
기존 테이블은 절대 건드리지 말 것.

```
id (serial primary key)
user_id (integer, FK → users)
new_email (varchar)
code (varchar 6)
type (varchar) -- 'signup' | 'email_change'
expires_at (timestamp)
is_used (boolean, default false)
created_at (timestamp)
```

---

## STEP 5 — API 엔드포인트 3개 추가

기존 routes.ts 코드는 절대 수정하지 말고 추가만 해줘.

### POST /api/auth/email-verify/send
- 요청 body: { newEmail, type }
- 이메일 형식 유효성 검사
- 회원가입 타입: 이미 사용 중인 이메일이면 거부
- 이메일 변경 타입: 현재 이메일과 동일하면 거부, 로그인 세션 확인
- 6자리 랜덤 숫자 코드 생성
- email_verifications 테이블에 저장 (만료 5분)
- 기존 미사용 인증 요청 만료 처리
- Resend로 인증번호 이메일 발송
- 성공: { success: true, message: "인증번호가 발송되었습니다." }

### POST /api/auth/email-verify/confirm
- 요청 body: { newEmail, code, type }
- email_verifications 테이블에서 유효한 코드 확인
- 만료 여부, 사용 여부 체크
- 이메일 변경 타입: users 테이블 이메일 업데이트
- is_used = true 처리
- 성공: { success: true, message: "인증이 완료되었습니다." }

### POST /api/auth/password-reset/send
- 요청 body: { email }
- 해당 이메일 회원 존재 여부 확인
- 랜덤 임시 비밀번호 8자리 생성 (영문+숫자 조합)
- users 테이블 비밀번호 bcrypt 암호화 후 업데이트
- Resend로 임시 비밀번호 이메일 발송
- 성공: { success: true, message: "임시 비밀번호가 이메일로 발송되었습니다." }

---

## STEP 6 — 기존 비밀번호 초기화 TODO 연동

server/routes.ts 2069줄 근처 비밀번호 초기화 TODO 주석 부분을
STEP 3에서 만든 sendTempPassword 함수를 사용해서 실제 동작하도록 구현해줘.

---

## 완료 후 보고사항
- 추가/수정된 파일 목록
- 각 파일의 변경 내용 요약
- 테스트 방법
- 모두 한국어로 작성해줘
