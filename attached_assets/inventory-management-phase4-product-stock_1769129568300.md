# 공급상품 재고 관리 (4단계)

## 📋 개요

**재고관리 > 공급상품 재고 관리** 페이지를 구현해주세요.
완성된 공급상품(미리 포장해 놓은 상품)의 재고를 관리하는 페이지입니다.

---

## 🎯 목적

**완성품(공급상품)의 재고를 원재료와 분리해서 관리**

| 구분 | 원재료 관리 | 공급상품 재고 관리 |
|------|------------|-------------------|
| **관리 대상** | 원재료/반재료/부재료 | 완성된 상품 (포장 완료) |
| **카테고리** | 재료 카테고리 | **상품 카테고리** |
| **재고 단위** | 소수점 1자리 (kg 등) | **정수 (개)** |
| **상품 출처** | 직접 등록 | **상품 매핑에서 가져옴** |
| **출고 우선순위** | 2순위 | **1순위 (먼저 차감!)** |

---

## 🔗 데이터 연결 관계

```
[상품관리]
    │
    │ 상품 카테고리 (대/중/소분류)
    ▼
[상품 매핑] ──────────────────────────────┐
    │                                     │
    │ 상품 목록 (매핑된 상품)              │
    │ 상품 ↔ 원재료 연결 정보              │
    ▼                                     │
[공급상품 재고 관리]                        │
    │                                     │
    │ • 상품 목록: 상품 매핑에서 가져옴      │
    │ • 카테고리: 상품 카테고리 사용        │
    │ • 재고: 완성품 재고 (정수)           │
    │                                     │
    ▼                                     │
[주문 출고 시]                             │
    │                                     │
    ├─→ 1순위: 공급상품 재고 차감          │
    │                                     │
    └─→ 2순위: 원재료 재고 차감 ←──────────┘
              (상품 매핑 정보 기반)
```

---

## 🎨 페이지 레이아웃

```
┌──────────────────────────────────────────────────────────────────────────────────┐
│ 공급상품 재고 관리                                                                 │
│ 완성된 공급상품의 재고를 관리합니다.                                                │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                    [양식 다운로드] [엑셀 업로드]   │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 검색 필터 (상품 카테고리)                                                       │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 대분류: [전체 ▼]  중분류: [전체 ▼]  소분류: [전체 ▼]                          │ │
│ │ 상품코드: [________]  상품명: [______________]       [검색] [초기화]          │ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│  ※ 상품 카테고리는 "상품관리 > 카테고리 관리"에서 설정한 카테고리입니다.              │
│                                                                                  │
│ [+ 입고 등록]  [재고 조정]                                  총 3개 (재고 있는 상품) │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│ ■ 공급상품 재고 현황 (재고 > 0 인 상품만 표시)                                      │
│ ┌──────────────────────────────────────────────────────────────────────────────┐ │
│ │ 대분류 │ 중분류 │ 소분류 │ 상품코드 │ 상품명            │ 현재재고 │ 관리     │ │
│ ├──────────────────────────────────────────────────────────────────────────────┤ │
│ │ 과일  │ 사과  │ 부사  │ A001    │ 부사 3kg 선물세트  │   10    │[입고][조정]│ │
│ │ 과일  │ 사과  │ 부사  │ A002    │ 부사 5kg 가정용    │    5    │[입고][조정]│ │
│ │ 과일  │ 배   │ 신고  │ B001    │ 신고 3kg 선물세트  │    8    │[입고][조정]│ │
│ └──────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│ ※ 재고가 0인 상품은 표시되지 않습니다.                                            │
│ ※ 입고/조정 시에는 모든 상품(상품 매핑에 등록된)을 검색할 수 있습니다.               │
│                                                                                  │
│                              [1] [2] [3] ... [5]                                 │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 테이블 컬럼

| 순번 | 컬럼명 | 설명 |
|:----:|--------|------|
| 1 | 대분류 | 상품 카테고리 |
| 2 | 중분류 | 상품 카테고리 |
| 3 | 소분류 | 상품 카테고리 |
| 4 | 상품코드 | 고유 코드 |
| 5 | 상품명 | 상품 이름 |
| 6 | 현재재고 | 재고 수량 (정수, 개) |
| 7 | 관리 | [입고] [조정] 버튼 |

---

## 🔍 검색 필터

| 필터 | 타입 | 설명 |
|------|------|------|
| 대분류 | 드롭다운 | **상품 카테고리** |
| 중분류 | 드롭다운 | **상품 카테고리** (대분류 선택 시 연동) |
| 소분류 | 드롭다운 | **상품 카테고리** (중분류 선택 시 연동) |
| 상품코드 | 텍스트 | 부분 일치 검색 |
| 상품명 | 텍스트 | 부분 일치 검색 |

**※ 상품 카테고리는 "상품관리 > 카테고리 관리"에서 설정한 카테고리를 사용합니다.**

---

## 🔧 기능 상세

### 1) 입고 등록

#### [+ 입고 등록] 또는 테이블의 [입고] 클릭 시 모달

```
┌─────────────────────────────────────────────────────────────┐
│ 공급상품 입고 등록                                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ■ 상품 검색 (상품 카테고리)                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 대분류: [전체 ▼]  중분류: [전체 ▼]  소분류: [전체 ▼]     │ │
│ │ 상품명: [________________] 🔍                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ■ 상품 선택 (상품 매핑에 등록된 모든 상품)                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ A001 - 부사 3kg 선물세트          (현재 재고: 10)     │ │
│ │ ○ A002 - 부사 5kg 가정용            (현재 재고: 5)      │ │
│ │ ○ A003 - 부사 10kg 가정용           (현재 재고: 0)      │ │
│ │ ○ B001 - 신고 3kg 선물세트          (현재 재고: 8)      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 입고 수량: [________] 개 (정수만 입력)                       │
│                                                             │
│ 비고:      [____________________] (선택)                    │
│                                                             │
│                              [취소]  [입고 등록]             │
└─────────────────────────────────────────────────────────────┘
```

#### 테이블의 [입고] 버튼 클릭 시
- 해당 상품이 자동 선택된 상태로 모달 열림
- 입고 수량만 입력하면 됨

#### 입고 등록 처리
```javascript
const handleProductStockIn = async (productCode, quantity, note, adminId) => {
  // 1. 재고 증가
  await increaseProductStock(productCode, quantity);
  
  // 2. 재고 이력 기록
  await createStockHistory({
    type: 'product',           // 공급상품
    actionType: 'in',          // 입고
    productCode,
    quantity: quantity,        // +수량
    note,
    adminId                    // 담당자 아이디
  });
};
```

---

### 2) 재고 조정

#### [재고 조정] 또는 테이블의 [조정] 클릭 시 모달

```
┌─────────────────────────────────────────────────────────────┐
│ 재고 조정                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ■ 상품 검색 (상품 카테고리)                                  │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 대분류: [전체 ▼]  중분류: [전체 ▼]  소분류: [전체 ▼]     │ │
│ │ 상품명: [________________] 🔍                           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ■ 상품 선택 (상품 매핑에 등록된 모든 상품)                    │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ ○ A001 - 부사 3kg 선물세트          (현재 재고: 10)     │ │
│ │ ○ A002 - 부사 5kg 가정용            (현재 재고: 5)      │ │
│ │ ○ A003 - 부사 10kg 가정용           (현재 재고: 0)      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 조정 유형: ○ 증가 (+)  ○ 감소 (-)                           │
│                                                             │
│ 조정 수량: [________] 개 (정수만 입력)                       │
│                                                             │
│ 조정 사유: [선택 ▼]                                         │
│            ├─ 파손                                          │
│            ├─ 오차 수정                                     │
│            ├─ 폐기                                          │
│            └─ 기타                                          │
│                                                             │
│ 비고:      [____________________]                           │
│                                                             │
│ ───────────────────────────────────────────────────────── │
│ 현재 재고:   10개                                           │
│ 조정 후 재고: 8개                                            │
│ ───────────────────────────────────────────────────────── │
│                                                             │
│                              [취소]  [조정 완료]             │
└─────────────────────────────────────────────────────────────┘
```

#### 테이블의 [조정] 버튼 클릭 시
- 해당 상품이 자동 선택된 상태로 모달 열림

#### 조정 사유 옵션

| 사유 | 설명 |
|------|------|
| 파손 | 상품 파손으로 인한 재고 감소 |
| 오차 수정 | 실사 결과 재고 오차 수정 |
| 폐기 | 유통기한 등 사유로 폐기 |
| 기타 | 기타 사유 |

#### 재고 조정 처리
```javascript
const handleProductStockAdjust = async (productCode, adjustType, quantity, reason, note, adminId) => {
  // 1. 재고 조정
  if (adjustType === 'increase') {
    await increaseProductStock(productCode, quantity);
  } else {
    await decreaseProductStock(productCode, quantity);
  }
  
  // 2. 재고 이력 기록
  await createStockHistory({
    type: 'product',           // 공급상품
    actionType: 'adjust',      // 조정
    productCode,
    quantity: adjustType === 'increase' ? quantity : -quantity,
    reason,                    // 조정 사유
    note,
    adminId                    // 담당자 아이디
  });
};
```

#### 감소 시 검증
```javascript
// 현재 재고보다 많이 감소 불가
if (adjustType === 'decrease' && quantity > currentStock) {
  showAlert({
    type: 'error',
    message: '현재 재고보다 많은 수량을 감소할 수 없습니다.'
  });
  return;
}
```

---

## 📥 엑셀 기능

### [양식 다운로드] 버튼

클릭 시 엑셀 템플릿 파일 다운로드

**파일명:** `공급상품_입고_양식.xlsx`

> ⚠️ **탑셀러 엑셀 파일 규칙**
> - 모든 엑셀 파일은 **xlsx 또는 xls 형식**만 사용
> - **CSV 형식 사용 금지**
> - 다운로드 파일: `.xlsx` 형식
> - 업로드 허용: `.xlsx`, `.xls` 형식

#### 엑셀 양식 구조

| 상품코드 | 상품명 | 입고수량 | 비고 |
|---------|--------|:-------:|------|
| A001 | 부사 3kg 선물세트 | 10 | |
| A002 | 부사 5kg 가정용 | 5 | |
| B001 | 신고 3kg 선물세트 | 8 | |

#### 양식 파일 안내문

```
[공급상품 입고 양식 안내]

1. 상품코드: 상품 매핑에 등록된 상품코드 (필수)
2. 상품명: 상품 이름 (참고용, 검증하지 않음)
3. 입고수량: 정수만 입력 (필수)
4. 비고: 메모 (선택)

※ 상품코드는 "상품 매핑"에 등록된 상품만 입고 가능합니다.
※ 입고수량은 정수만 입력 가능합니다.
※ 존재하지 않는 상품코드는 오류 처리됩니다.
```

---

### [엑셀 업로드] 버튼

클릭 시 파일 업로드 모달

```
┌───────────────────────────────────────────┐
│ 엑셀 업로드                                │
├───────────────────────────────────────────┤
│                                           │
│  ┌─────────────────────────────────────┐  │
│  │                                     │  │
│  │     📄 엑셀 파일을 드래그하거나      │  │
│  │        클릭하여 업로드               │  │
│  │                                     │  │
│  │     (.xlsx, .xls 파일만 가능)       │  │
│  │                                     │  │
│  └─────────────────────────────────────┘  │
│                                           │
│  [양식 다운로드]                           │
│                                           │
│                   [취소]  [업로드]         │
└───────────────────────────────────────────┘
```

---

### 엑셀 업로드 처리 로직

```javascript
const processExcelUpload = async (file, adminId) => {
  const rows = parseExcel(file);
  
  const results = {
    success: [],
    errors: []
  };
  
  for (const row of rows) {
    // 1. 필수값 체크
    if (!row.상품코드 || !row.입고수량) {
      results.errors.push(`행 ${row.rowNum}: 상품코드 또는 입고수량 누락`);
      continue;
    }
    
    // 2. 상품코드 존재 여부 체크 (상품 매핑에서)
    const product = await getProductFromMapping(row.상품코드);
    if (!product) {
      results.errors.push(`행 ${row.rowNum}: 상품코드 [${row.상품코드}]가 상품 매핑에 존재하지 않습니다.`);
      continue;
    }
    
    // 3. 입고수량 정수 체크
    const quantity = parseInt(row.입고수량);
    if (isNaN(quantity) || quantity <= 0) {
      results.errors.push(`행 ${row.rowNum}: 입고수량은 양의 정수만 가능합니다.`);
      continue;
    }
    
    results.success.push({
      productCode: row.상품코드,
      productName: product.productName,
      quantity,
      note: row.비고 || ''
    });
  }
  
  return results;
};
```

---

### 업로드 결과 확인 모달

```
┌───────────────────────────────────────────────────────────────┐
│ 엑셀 업로드 결과                                               │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│ 📊 분석 결과                                                   │
│ ─────────────────────────────────────────────────────────     │
│ 전체: 10행                                                    │
│ ✅ 입고 가능: 8행                                              │
│ ⚠️ 오류: 2행                                                  │
│                                                               │
│ ■ 입고 예정 목록                                               │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ 상품코드 │ 상품명              │ 입고수량                  │ │
│ │ A001    │ 부사 3kg 선물세트    │ 10                       │ │
│ │ A002    │ 부사 5kg 가정용      │ 5                        │ │
│ │ B001    │ 신고 3kg 선물세트    │ 8                        │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                               │
│ ■ 오류 목록                                                   │
│ ┌───────────────────────────────────────────────────────────┐ │
│ │ • 행 5: 상품코드 [X999]가 상품 매핑에 존재하지 않습니다.    │ │
│ │ • 행 8: 입고수량은 양의 정수만 가능합니다.                  │ │
│ └───────────────────────────────────────────────────────────┘ │
│                                                               │
│ ※ 오류가 있는 항목은 제외하고 입고됩니다.                       │
│                                                               │
│                          [취소]  [8개 상품 입고하기]           │
└───────────────────────────────────────────────────────────────┘
```

---

## 📊 데이터 스키마

### product_stocks (공급상품 재고)

```typescript
{
  id: number;
  productCode: string;       // 상품코드 (상품 매핑과 연결, unique)
  productName: string;       // 상품명
  currentStock: number;      // 현재 재고 (정수, 기본값 0)
  createdAt: Date;
  updatedAt: Date;
}
```

---

## 🔄 주문 출고 시 재고 차감 로직

**※ 이 로직은 주문관리 연동 시 적용됩니다.**

```javascript
const processOrderShipment = async (productCode, orderQuantity, adminId) => {
  
  // 1️⃣ 공급상품 재고 확인
  const productStock = await getProductStock(productCode);
  const currentProductStock = productStock?.currentStock || 0;
  
  // 2️⃣ 공급상품 재고로 충당 가능한 수량
  const fromProductStock = Math.min(currentProductStock, orderQuantity);
  
  // 3️⃣ 공급상품 재고 차감
  if (fromProductStock > 0) {
    await decreaseProductStock(productCode, fromProductStock);
    
    // 재고 이력 기록
    await createStockHistory({
      type: 'product',
      actionType: 'out',
      productCode,
      quantity: -fromProductStock,
      note: '주문 출고',
      adminId
    });
  }
  
  // 4️⃣ 부족분 계산
  const remaining = orderQuantity - fromProductStock;
  
  // 5️⃣ 부족분은 원재료에서 차감 (상품 매핑 정보 기반)
  if (remaining > 0) {
    const materials = await getProductMaterials(productCode);
    
    for (const material of materials) {
      const reduceQty = material.quantity * remaining;
      
      await decreaseMaterialStock(material.materialCode, reduceQty);
      
      // 재고 이력 기록
      await createStockHistory({
        type: 'material',
        actionType: 'out',
        materialCode: material.materialCode,
        quantity: -reduceQty,
        note: `주문 출고 (${productCode})`,
        adminId
      });
    }
  }
};
```

### 출고 예시

```
[주문: 부사 3kg 선물세트 15개]

상품 매핑 정보:
- 부사 보통 3번(원물) × 2
- 부사 상 2번(원물) × 1
- 3kg 선물박스 × 1

현재 재고:
- 공급상품 "부사 3kg 선물세트": 10개
- 원재료 "부사 보통 3번(원물)": 100
- 원재료 "부사 상 2번(원물)": 50
- 부재료 "3kg 선물박스": 200

출고 처리:
1️⃣ 공급상품 10개 출고 → 0개 남음
2️⃣ 부족분 5개는 원재료에서:
   - 부사 보통 3번(원물): 100 - (2×5) = 90
   - 부사 상 2번(원물): 50 - (1×5) = 45
   - 3kg 선물박스: 200 - (1×5) = 195
```

---

## 🔔 알림

| 상황 | 타입 | 메시지 |
|------|------|--------|
| 입고 성공 | ✅ success | "입고가 완료되었습니다." |
| 조정 성공 | ✅ success | "재고 조정이 완료되었습니다." |
| 엑셀 입고 성공 | ✅ success | "N개 상품이 입고되었습니다." |
| 재고 부족 | ⚠️ error | "현재 재고보다 많은 수량을 감소할 수 없습니다." |
| 상품 없음 | ⚠️ error | "상품 매핑에 존재하지 않는 상품입니다." |
| 수량 오류 | ⚠️ error | "입고수량은 양의 정수만 가능합니다." |

---

## 🔌 API 엔드포인트

```
# 공급상품 재고 현황
GET    /api/product-stocks                      # 재고 목록 (재고 > 0, 필터 지원)
GET    /api/product-stocks/:productCode         # 단일 상품 재고 조회

# 입고
POST   /api/product-stocks/in                   # 입고 등록

# 재고 조정
POST   /api/product-stocks/adjust               # 재고 조정

# 엑셀
GET    /api/product-stocks/template             # 양식 다운로드
POST   /api/product-stocks/upload               # 엑셀 업로드 (일괄 입고)

# 상품 목록 (상품 매핑에서)
GET    /api/product-mappings/all                # 입고/조정용 전체 상품 목록
```

---

## ✅ 체크리스트

### 페이지 기본
- [ ] 재고 현황 테이블 (재고 > 0 인 상품만)
- [ ] 검색 필터 (**상품 카테고리** 대/중/소분류)
- [ ] 상품코드, 상품명 검색
- [ ] 페이지네이션

### 입고 등록
- [ ] [+ 입고 등록] 버튼 → 모달
- [ ] 테이블 [입고] 버튼 → 해당 상품 선택된 모달
- [ ] 상품 검색 (**상품 카테고리** 필터)
- [ ] 상품 매핑에 등록된 **모든 상품** 검색 가능
- [ ] 현재 재고 표시
- [ ] 입고 수량 입력 (정수만)
- [ ] 비고 입력 (선택)
- [ ] 입고 시 재고 이력 자동 기록
- [ ] 담당자(아이디) 자동 기록

### 재고 조정
- [ ] [재고 조정] 버튼 → 모달
- [ ] 테이블 [조정] 버튼 → 해당 상품 선택된 모달
- [ ] 상품 검색 (**상품 카테고리** 필터)
- [ ] 상품 매핑에 등록된 **모든 상품** 검색 가능
- [ ] 현재 재고 표시
- [ ] 조정 유형 선택 (증가/감소)
- [ ] 조정 수량 입력 (정수만)
- [ ] 조정 사유 선택 (파손/오차수정/폐기/기타)
- [ ] 비고 입력
- [ ] 조정 후 재고 미리보기
- [ ] 감소 시 현재 재고 초과 검증
- [ ] 조정 시 재고 이력 자동 기록
- [ ] 담당자(아이디) 자동 기록

### 엑셀 기능
- [ ] [양식 다운로드] (.xlsx)
- [ ] [엑셀 업로드] (.xlsx, .xls)
- [ ] 업로드 시 상품코드 검증 (상품 매핑 존재 여부)
- [ ] 업로드 시 수량 검증 (양의 정수)
- [ ] 업로드 결과 확인 모달
- [ ] 오류 항목 제외 후 입고 처리
- [ ] 업로드 시 담당자(아이디) 자동 기록

---

## ⚠️ 중요 규칙

| 항목 | 규칙 |
|------|------|
| **테이블 표시** | 재고 > 0 인 상품만 |
| **입고/조정 시 상품 검색** | 상품 매핑의 **모든 상품** 검색 가능 |
| **카테고리** | **상품 카테고리** 사용 (재료 카테고리 아님!) |
| **재고 단위** | **정수 (개)** |
| **상품 출처** | **상품 매핑에 등록된 상품만** 입고/조정 가능 |
| **출고 우선순위** | 공급상품 먼저 → 부족분만 원재료 (주문관리 연동 시) |
| **엑셀 형식** | .xlsx, .xls (CSV 금지) |
| **이력 기록** | 모든 입고/조정 시 담당자(아이디) 자동 기록 |
