# 비용관리 — 분류/세부항목 관리 기능 추가

## ⚠️ 최우선 원칙

1. **⛔ 기존 CSS, 글씨체, 폰트, 전역 스타일을 절대 수정하거나 새로 추가하지 마세요.**
2. **기존 비용관리 기능(자동완성, 정기비용, 차트, 키워드 사전 관리 등)을 깨뜨리지 마세요.**
3. **기존 기술 스택(React + TanStack Query + shadcn/ui + Drizzle ORM)을 그대로 유지하세요.**
4. 작업 진행 상황과 결과는 항상 **한글**로 보여주세요.

---

## 📋 작업 개요

현재 "⚙️ 분류 사전 관리" 다이얼로그에는 **키워드 관리** 기능만 있습니다.
여기에 **분류 관리 탭**을 추가하여, 관리자가 대분류와 세부항목을 직접 추가/수정/삭제할 수 있게 합니다.

```
현재: ⚙️ 분류 사전 관리 → [키워드 관리]
변경: ⚙️ 분류 사전 관리 → [분류 관리] [키워드 관리]  ← 탭 2개
```

---

## 1단계: DB 스키마 수정

### 1-1. expenseCategories 테이블에 is_system 컬럼 추가

```sql
ALTER TABLE expense_categories ADD COLUMN IF NOT EXISTS is_system BOOLEAN DEFAULT true;
```

- 기존 8개 대분류: is_system = true (기본 제공, 삭제 불가)
- 관리자가 새로 추가하는 분류: is_system = false (삭제 가능)

### 1-2. expenseSubCategories 테이블에 is_system 컬럼 추가

```sql
ALTER TABLE expense_sub_categories ADD COLUMN IF NOT EXISTS is_system BOOLEAN DEFAULT true;
```

- 기존 세부항목: is_system = true
- 관리자가 새로 추가하는 세부항목: is_system = false

### 1-3. 기존 데이터 업데이트

```sql
-- 기존 대분류/세부항목 모두 is_system = true로 설정
UPDATE expense_categories SET is_system = true WHERE is_system IS NULL;
UPDATE expense_sub_categories SET is_system = true WHERE is_system IS NULL;
```

### 1-4. Zod 스키마 업데이트

`shared/schema.ts`에 is_system 필드를 추가하세요.

---

## 2단계: API

### 2-1. 대분류 API

```
GET /api/admin/accounting/expenses/categories
```
- 이미 존재하는 API라면 응답에 `is_system`, `expenseCount`(해당 분류 사용 비용 건수), `subCategoryCount`(세부항목 수) 추가
- 응답 예시:
```json
[
  {
    "id": 1,
    "name": "물류/배송비",
    "emoji": "🚚",
    "color": "blue",
    "is_system": true,
    "subCategoryCount": 5,
    "expenseCount": 12
  }
]
```

```
POST /api/admin/accounting/expenses/categories
```
- 요청: `{ name, emoji, color }`
- is_system: false로 설정
- 검증: 같은 name이 이미 존재하면 400 에러

```
PUT /api/admin/accounting/expenses/categories/:id
```
- 요청: `{ name?, emoji?, color? }`
- is_system=true인 기본 분류도 이름/이모지/색상 수정은 허용

```
DELETE /api/admin/accounting/expenses/categories/:id
```
- is_system=true → 400 에러: "기본 분류는 삭제할 수 없습니다"
- is_system=false → 삭제 진행:
  1. 해당 분류를 사용 중인 expenses의 categoryId를 "기타" 분류 ID로 변경
  2. 해당 분류를 사용 중인 expense_keywords의 categoryId도 "기타"로 변경
  3. 해당 분류의 세부항목(expenseSubCategories)도 함께 삭제
  4. 분류 레코드 삭제

### 2-2. 세부항목 API

```
GET /api/admin/accounting/expenses/subcategories?categoryId=1
```
- 특정 대분류의 세부항목 목록
- 응답에 `is_system`, `expenseCount` 포함
```json
[
  {
    "id": 1,
    "categoryId": 1,
    "name": "택배비",
    "is_system": true,
    "expenseCount": 8
  }
]
```

```
POST /api/admin/accounting/expenses/subcategories
```
- 요청: `{ categoryId, name }`
- is_system: false
- 검증: 같은 categoryId + name 조합이 이미 존재하면 400 에러

```
PUT /api/admin/accounting/expenses/subcategories/:id
```
- 요청: `{ name }`

```
DELETE /api/admin/accounting/expenses/subcategories/:id
```
- is_system=true → 400 에러: "기본 세부항목은 삭제할 수 없습니다"
- is_system=false → 삭제 진행:
  1. 해당 세부항목을 사용 중인 expenses의 subCategoryId를 null로 변경
  2. 해당 세부항목을 사용 중인 expense_keywords의 subCategoryId도 null로 변경
  3. 세부항목 레코드 삭제

---

## 3단계: 프론트엔드 UI

### 3-1. 분류 사전 관리 다이얼로그 수정

기존 "⚙️ 분류 사전 관리" 다이얼로그에 **탭 2개**를 추가합니다:

```
┌──────────────────────────────────────────────────────────────┐
│  ⚙️ 분류 사전 관리                                      [✕]   │
├──────────────────────────────────────────────────────────────┤
│  [분류 관리]  [키워드 관리]                                     │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  (선택된 탭 내용)                                               │
│                                                                │
└──────────────────────────────────────────────────────────────┘
```

- "키워드 관리" 탭: **기존 키워드 관리 UI 그대로 유지** (변경 없음)
- "분류 관리" 탭: **새로 추가** (아래 설명)

### 3-2. 분류 관리 탭

**상단: 대분류 테이블**

```
┌──────────────────────────────────────────────────────────────┐
│  대분류                                        [+ 대분류 추가] │
│                                                                │
│  ┌──────┬────────────┬──────┬────────┬──────────┬──────┐     │
│  │ 이모지│ 분류명       │ 색상  │ 세부항목 │ 사용 비용수 │ 액션  │     │
│  ├──────┼────────────┼──────┼────────┼──────────┼──────┤     │
│  │ 🚚   │ 물류/배송비  │ 🔵   │ 5개    │ 12건      │  ✏️  │     │
│  │ 👤   │ 인건비      │ 🟣   │ 4개    │ 8건       │  ✏️  │     │
│  │ 🏢   │ 시설/임대료  │ 🟡   │ 4개    │ 5건       │  ✏️  │     │
│  │ 📢   │ 마케팅/광고  │ 🩷   │ 4개    │ 3건       │  ✏️  │     │
│  │ 💻   │ IT/시스템   │ 🩵   │ 4개    │ 2건       │  ✏️  │     │
│  │ 📎   │ 사무/관리   │ ⚪   │ 5개    │ 1건       │  ✏️  │     │
│  │ 🏦   │ 금융비용    │ 🟢   │ 3개    │ 0건       │  ✏️  │     │
│  │ 📝   │ 기타       │ ⚫   │ 0개    │ 2건       │  ✏️  │     │
│  │ 🎁   │ 복리후생    │ 🟠   │ 0개    │ 0건       │ ✏️🗑 │     │ ← 추가한 분류
│  └──────┴────────────┴──────┴────────┴──────────┴──────┘     │
└──────────────────────────────────────────────────────────────┘
```

- 기본 분류(is_system=true): ✏️만 표시 (삭제 불가)
- 추가 분류(is_system=false): ✏️🗑 표시
- 색상 컬럼: Tailwind 색상에 대응하는 컬러 dot 표시

**하단: 세부항목 테이블 (대분류 행 클릭 시 표시)**

```
┌──────────────────────────────────────────────────────────────┐
│  ── 🚚 물류/배송비 세부항목 (5개) ──          [+ 세부항목 추가]  │
│                                                                │
│  ┌──────────────┬──────────┬──────┐                           │
│  │ 세부항목명     │ 사용 비용수│ 액션  │                           │
│  ├──────────────┼──────────┼──────┤                           │
│  │ 택배비        │ 8건       │  ✏️  │                           │
│  │ 화물운송비     │ 2건       │  ✏️  │                           │
│  │ 배송비        │ 1건       │  ✏️  │                           │
│  │ 포장재비      │ 1건       │  ✏️  │                           │
│  │ 도서산간추가비  │ 0건       │  ✏️  │                           │
│  │ 퀵서비스      │ 0건       │ ✏️🗑 │ ← 추가한 항목              │
│  └──────────────┴──────────┴──────┘                           │
└──────────────────────────────────────────────────────────────┘
```

- 기본 세부항목(is_system=true): ✏️만 표시
- 추가 세부항목(is_system=false): ✏️🗑 표시
- 대분류를 선택하지 않은 초기 상태: "대분류를 선택하면 세부항목이 표시됩니다" 안내

### 3-3. 대분류 추가/수정 다이얼로그

```
┌─────────────────────────────────────┐
│  대분류 추가 (또는 수정)              │
├─────────────────────────────────────┤
│                                       │
│  분류명: [복리후생__________]          │
│                                       │
│  이모지: [🎁]                         │
│  (직접 입력하거나 아래에서 선택)        │
│  💰💳🎁🎯🔧📦🛒🏭⚡🔌              │
│  🚗✈️🍽️🏥📚🎓🏋️🎪📱🖥️           │
│                                       │
│  색상: [orange ▼]                    │
│  ● red  ● orange  ● amber           │
│  ● yellow  ● green  ● emerald       │
│  ● cyan  ● blue  ● indigo           │
│  ● violet  ● purple  ● pink         │
│  ● slate  ● gray                    │
│                                       │
│             [취소]  [저장]             │
└─────────────────────────────────────┘
```

- 이모지: 텍스트 입력 (이모지 직접 타이핑) + 자주 쓰는 이모지 버튼
- 색상: 드롭다운 또는 그리드형 색상 선택, 각 옵션에 Tailwind 색상 dot 미리보기

### 3-4. 세부항목 추가/수정 다이얼로그

```
┌─────────────────────────────────────┐
│  세부항목 추가 (또는 수정)             │
├─────────────────────────────────────┤
│                                       │
│  대분류: 🚚 물류/배송비 (고정)         │
│                                       │
│  세부항목명: [퀵서비스________]         │
│                                       │
│             [취소]  [저장]             │
└─────────────────────────────────────┘
```

### 3-5. 삭제 확인 다이얼로그

**사용 중인 비용이 없는 경우:**
```
"복리후생" 분류를 삭제하시겠습니까?
[취소] [삭제]
```

**사용 중인 비용이 있는 경우:**
```
⚠️ "복리후생" 분류를 사용 중인 비용이 3건 있습니다.
삭제하면 해당 비용의 분류가 "기타"로 변경됩니다.
계속하시겠습니까?
[취소] [삭제]
```

### 3-6. 추가한 분류가 즉시 반영되는 곳

분류/세부항목 추가 후, 아래 UI에 즉시 반영되어야 합니다:
- 비용 등록 다이얼로그의 대분류 Select 드롭다운
- 비용 등록 다이얼로그의 세부항목 Select 드롭다운
- 비용관리 탭의 분류 필터 탭
- 월간 요약 카드

TanStack Query의 캐시를 invalidate하여 자동 반영되도록 하세요.

---

## 검증 체크리스트

### DB
1. ✅ expenseCategories에 is_system 컬럼이 추가되었는가?
2. ✅ expenseSubCategories에 is_system 컬럼이 추가되었는가?
3. ✅ 기존 데이터가 is_system=true로 설정되었는가?

### 대분류 관리
4. ✅ 대분류 목록에 이모지, 이름, 색상, 세부항목 수, 사용 비용수가 표시되는가?
5. ✅ 대분류 추가가 동작하는가? (이모지, 색상 선택 포함)
6. ✅ 대분류 수정이 동작하는가?
7. ✅ 기본 분류(is_system=true)는 삭제 버튼이 없는가?
8. ✅ 추가한 분류(is_system=false)는 삭제가 동작하는가?
9. ✅ 사용 중인 비용이 있는 분류 삭제 시 경고 + "기타"로 이동하는가?

### 세부항목 관리
10. ✅ 대분류 클릭 시 세부항목 목록이 표시되는가?
11. ✅ 세부항목 추가/수정/삭제가 동작하는가?
12. ✅ 기본 세부항목은 삭제 불가인가?

### 연동
13. ✅ 추가한 분류가 비용 등록 Select에 즉시 나타나는가?
14. ✅ 추가한 세부항목이 세부항목 Select에 즉시 나타나는가?
15. ✅ 분류 필터 탭에 추가한 분류가 나타나는가?

### 기존 기능 보존
16. ✅ 기존 키워드 관리 탭이 정상 동작하는가?
17. ✅ 자동완성, 정기비용, 차트 등 기존 기능이 정상인가?
18. ✅ **기존 CSS, 글씨체가 변경 없이 유지되는가?**

결과를 한글로 보고해 주세요.
