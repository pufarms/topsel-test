# 작업 지시서: 회원등급별 가격 체계 점검 및 적용

## 📋 작업 개요

이 시스템의 **모든 가격은 회원 등급에 따라 다릅니다.** 동일한 상품이라도 회원 등급에 따라 공급가가 다르게 적용됩니다. 현재 시스템에서 가격이 올바르게 회원등급별로 적용되고 있는지 **전체적으로 점검**하고, 잘못된 부분이 있으면 수정해야 합니다.

---

## ⚠️ 핵심 가격 체계 (매우 중요 - 반드시 숙지!)

### 회원 등급 3단계

| 등급 | 설명 | 공급가 수준 |
|------|------|-----------|
| **Start** (스타트) | 기본 등급 | 가장 높은 공급가 |
| **Driving** (드라이빙) | 중간 등급 | 중간 공급가 |
| **Top** (탑셀러) | 최상위 등급 | 최저 공급가 (가장 저렴) |

### 가격의 유일한 기준: `current_products` (현재 공급가) 테이블

`current_products` 테이블에 각 상품별로 3개 등급의 공급가가 설정되어 있습니다.
**모든 가격은 10원 단위입니다:**

```
예시: 상품 "제주 감귤 5kg"
  - Start 등급 공급가: 15,000원  (10원 단위)
  - Driving 등급 공급가: 13,500원  (10원 단위)
  - Top 등급 공급가: 12,000원  (10원 단위)
```

### 가격 체계 3단계 흐름 및 가격 단위

```
[1단계] 상품등록 (product_registrations)
  → 1원 단위로 정밀 계산 (예: 14,723원)
  → 관리자가 원가, 마진 등을 기반으로 계산하는 단계
    ↓
[2단계] 차주 예상공급가 (next_week_products)
  → 10원 올림 적용: Math.ceil(price/10)*10
  → 예: 14,723원 → 14,730원
  → 다음 주에 적용 예정인 가격을 미리 보여주는 단계
    ↓
[3단계] ★ 현재 공급가 (current_products) ★
  → 최종 확정된 가격, 10원 단위
  → 모든 주문/매출/매입/정산의 유일한 가격 기준
```

**⚡ 가격 단위 핵심 정리:**
- **현재 공급가(current_products)의 모든 가격은 10원 단위입니다** (1원 단위 없음)
- 예시: 15,000원, 13,500원, 12,000원, 14,730원 등 (모두 10원 단위)
- 주문, 매출, 매입, 정산 등 시스템 전체에서 사용되는 가격은 모두 이 10원 단위 가격입니다
- 1원 단위는 상품등록(product_registrations) 단계에서만 존재하며, 실제 운영에는 사용되지 않습니다

**이 가격은 관리자가 상품관리에서 수시로 변경 가능합니다.**

---

## 🔴 가격 확정 시점 규칙 (매우 중요 - 절대 규칙!)

### 가격이 확정되는 시점 = "배송중"으로 전환되는 순간

```
대기 → 상품준비중 → 배송준비중 → ★★★ 배송중 ★★★ (이 시점에 가격 확정·잠금)
                                        ↑
                                  이 순간의 current_products 등급별 공급가로 확정
```

**단계별 가격 적용 규칙:**

| 주문 단계 | 가격 상태 | 설명 |
|-----------|----------|------|
| 대기 | **항상 표시 (미확정)** | current_products의 현재 등급별 공급가를 조회하여 **항상 가격 표시**. 단, 아직 확정은 아님 |
| 상품준비중 | **항상 표시 (미확정)** | current_products의 현재 등급별 공급가를 조회하여 **항상 가격 표시**. 단, 아직 확정은 아님 |
| 배송준비중 | **항상 표시 (미확정)** | current_products의 현재 등급별 공급가를 조회하여 **항상 가격 표시**. 단, 아직 확정은 아님 |
| **배송중** | **✅ 확정·잠금** | 배송중 전환 시점의 가격이 pending_orders에 확정 저장. 이후 절대 변경 불가 |
| 배송완료 | **✅ 확정 유지** | 배송중에서 확정된 가격 그대로 유지 |

**⚡ 중요:** 대기~배송준비중 단계에서도 해당 회원 등급의 공급가가 주문 목록 테이블에 **항상 표시**되어야 합니다. 가격이 보이지 않거나 빈칸이면 안 됩니다. 다만 이 가격은 current_products가 변경되면 함께 변경될 수 있는 "미확정" 상태이고, **배송중으로 전환되는 순간 그 시점의 가격으로 최종 확정**됩니다.

### 절대 규칙 3가지

**규칙 1: 배송중 전환 시 가격 확정 저장**
- 배송준비중 → 배송중으로 상태가 전환되는 시점에
- current_products에서 해당 회원 등급의 공급가를 조회하여
- pending_orders의 가격 필드에 확정 저장 (unit_price, total_price 등)

**규칙 2: 가격 변동은 변동 이후 주문건부터 적용**
- current_products의 가격이 변경되면
- 아직 배송중이 아닌 주문건(대기~배송준비중)에는 변경된 가격이 반영됨
- 이미 배송중/배송완료인 주문건에는 절대 영향 없음

**규칙 3: 배송중 이후 가격 변경 절대 금지**
- 이미 배송중으로 전환된 주문의 가격은 어떤 경우에도 변경 불가
- 동일 상품의 current_products 가격이 나중에 변경되더라도
- 이전에 배송중으로 넘어간 주문건의 가격은 절대 수정하면 안 됨

### 구현 예시

```
[시나리오]
2/7: "제주 감귤 5kg" Start 공급가 = 15,000원
  → Start회원A가 10박스 주문 (대기 상태)
  → Start회원B가 5박스 주문 (대기 상태)

2/8: 회원A의 주문이 배송중으로 전환
  → 이 시점 current_products Start 공급가 = 15,000원
  → 회원A 주문: 단가 15,000원으로 확정·잠금 → 총액 150,000원

2/9: 관리자가 "제주 감귤 5kg" Start 공급가를 16,000원으로 변경
  → 회원A 주문 (이미 배송중): 15,000원 유지 (절대 변경 안 됨!)
  → 회원B 주문 (아직 대기 상태): 16,000원으로 반영

2/10: 회원B의 주문이 배송중으로 전환
  → 이 시점 current_products Start 공급가 = 16,000원
  → 회원B 주문: 단가 16,000원으로 확정·잠금 → 총액 80,000원
```

---

## 🎯 점검 및 수정 대상

### 1. 배송중 전환 시 가격 확정 로직

**배송준비중 → 배송중 전환 API (가장 핵심!):**
- 전환 시점에 current_products에서 해당 상품의 회원등급별 공급가 조회
- 주문하는 회원의 등급 확인 (members.grade)
- **해당 등급의 공급가를 pending_orders의 가격 필드에 확정 저장**
- 이 저장된 가격은 이후 절대 변경되지 않음

```
배송중 전환 시 실행되어야 하는 로직:
1. 해당 주문의 회원 등급 조회 (members.grade)
2. current_products에서 해당 상품의 등급별 공급가 조회
3. pending_orders.unit_price = 해당 등급 공급가 (10원 단위)
4. pending_orders.total_price = unit_price × quantity
5. 상태를 "배송중"으로 변경
```

### 2. 대기~배송준비중 단계의 가격 표시

**아직 배송중이 아닌 주문의 가격 표시:**
- 주문 목록 테이블에 가격을 표시할 때
- current_products에서 해당 회원 등급의 **현재** 공급가를 실시간 조회하여 표시
- 또는 주문 등록 시점에 임시 가격을 저장하되, 배송중 전환 전까지는 current_products 변경에 따라 업데이트 가능

### 3. 주문 등록(엑셀 업로드) 시 임시 가격 적용

**회원이 주문을 등록(엑셀 업로드)할 때:**
- 주문하는 회원의 등급을 확인 (members.grade)
- `current_products`에서 해당 상품의 회원 등급 공급가를 조회
- pending_orders에 **임시 가격**으로 저장 (대기~배송준비중 단계에서 참조용)
- **이 가격은 아직 확정이 아님** → 배송중 전환 시 그 시점의 가격으로 다시 확정 저장됨

### 4. 관리자 대시보드 - 매출 현황 계산

**총매출 = 해당 기간 내 모든 정상 주문의 (확정 단가 × 수량) 합계**

- **배송중/배송완료 주문**: pending_orders/orders에 확정 저장된 가격 사용
- **대기~배송준비중 주문**: current_products의 현재 가격 기준으로 임시 집계
- 취소/주문조정 건 제외

### 5. 회원 대시보드 - 매입 총액 계산

**해당 회원의 매입 총액 = 해당 기간 내 해당 회원의 정상 주문의 (확정 단가 × 수량) 합계**

- 배송중/배송완료: 확정된 가격 사용
- 대기~배송준비중: current_products 현재 가격으로 임시 집계

### 6. 주문 목록 테이블에 표시되는 가격

관리자/회원의 모든 주문 관련 테이블에서:
- **대기~배송준비중**: current_products의 현재 등급별 공급가 표시 (가격 변동 시 반영됨)
- **배송중~배송완료**: pending_orders/orders에 확정 저장된 가격 표시 (절대 변경 안 됨)

### 7. 향후 정산 (참고)

정산은 반드시 **배송중 전환 시 확정된 가격**을 기준으로 진행:
- pending_orders/orders에 저장된 확정 가격 사용
- 현재 current_products 가격과 무관하게 주문 당시 확정 가격으로 정산

---

## 🔧 구체적 점검 사항

### 점검 1: pending_orders 테이블 구조 확인

```sql
-- pending_orders에 가격 관련 컬럼이 있는지 확인
-- 필요한 컬럼들:
-- unit_price (단가) - 배송중 전환 시 확정 저장되는 회원등급별 공급가 (10원 단위)
-- quantity (수량)
-- total_price (총액) - unit_price × quantity
-- price_confirmed (가격확정여부) - boolean (선택사항: 배송중 전환 시 true로 설정)
```

- 배송중 전환 시 unit_price가 정확히 확정 저장되는지 확인
- 대기~배송준비중 단계에서는 임시 가격이 저장되어 있거나, 표시 시 current_products에서 조회

### 점검 2: 배송중 전환 API 로직 확인 (가장 핵심!)

배송준비중 → 배송중 전환 시의 서버 로직:
1. 해당 주문의 회원 조회 → members.grade 확인
2. 해당 상품의 current_products 조회 → 등급별 공급가 조회
3. **회원 등급에 맞는 공급가를 pending_orders.unit_price에 확정 저장**
4. pending_orders.total_price = unit_price × quantity 계산 저장
5. 상태를 "배송중"으로 변경

→ 이 과정이 올바르게 구현되어 있는지 확인. 잘못되어 있으면 수정.

### 점검 3: 가격 변경 시 기존 배송중 주문 보호

current_products의 가격이 변경될 때:
- 이미 배송중/배송완료인 주문의 가격이 영향을 받지 않는지 확인
- pending_orders에 확정 저장된 가격이 변경되지 않는지 확인

### 점검 4: 매출/매입 집계 API 확인

관리자 대시보드 매출 API, 회원 대시보드 매입 API에서:
- 배송중/배송완료: 확정 저장된 가격으로 집계하는지 확인
- orders(완료 아카이브) 테이블도 동일하게 확정 가격이 저장되어 있는지 확인

### 점검 5: current_products 테이블의 등급별 가격 컬럼명 확인

실제 컬럼명을 확인하여 코드에서 올바르게 참조하고 있는지 확인:
```
예상 컬럼명 (실제 확인 필요):
- start_price 또는 startPrice (10원 단위)
- driving_price 또는 drivingPrice (10원 단위)
- top_price 또는 topPrice (10원 단위)
```

---

## 📋 작업 순서

1. **먼저 현재 상태 파악**: pending_orders, current_products, members 테이블의 스키마와 실제 데이터를 확인하여 현재 가격이 어떻게 저장/사용되고 있는지 파악
2. **문제점 식별**: 등급별 가격이 올바르게 적용되지 않는 부분 식별
3. **수정 작업**: 식별된 문제점 수정
4. **전체 검증**: 주문등록 → 주문목록 표시 → 매출/매입 집계까지 일관되게 등급별 가격이 적용되는지 확인

---

## 🚨 필수 안전 규칙 (모든 작업 시 반드시 준수)

1. **작업 전 체크**: 수정/추가하려는 부분이 기존에 저장된 기능, 구조, 설정에 영향을 주는지 먼저 확인한 후 작업 시작
2. **작업 중 체크**: 코드 변경 시 관련된 다른 컴포넌트, API, DB 스키마, 스타일이 깨지지 않는지 확인하면서 진행
3. **작업 후 체크**: 하나의 작업이 완료되면, 해당 작업으로 인해 기존 전체 시스템(기능, 구조, 설정, UI)에 오류/에러/변형이 발생하지 않았는지 반드시 전체 점검
4. **기존 기능 보존**: 새로운 기능 추가나 수정으로 인해 기존에 정상 작동하던 기능이 망가지는 일이 절대 없어야 함

## 📝 작업 언어 규칙

- 모든 작업 상황 보고, 작업 결과, 진행 설명, 에러 메시지 설명 등을 **한글(한국어)**로 작성해주세요
- 코드 주석도 가능하면 한글로 작성
- 커밋 메시지, 콘솔 로그 설명 등도 한글로 작성

---

## ✅ 완료 기준
- [ ] current_products 테이블의 등급별 가격 컬럼 구조 확인 완료 (10원 단위)
- [ ] 배송중 전환 시: 해당 시점의 current_products 등급별 공급가가 pending_orders에 확정 저장됨
- [ ] 배송중/배송완료 주문의 가격은 current_products 가격 변경 시에도 절대 변경되지 않음
- [ ] 대기~배송준비중 주문: current_products 현재 가격 기준으로 표시
- [ ] 주문 등록(엑셀 업로드) 시 회원 등급 확인 → 임시 가격 적용
- [ ] 관리자 매출 현황: 확정 가격 기반으로 정확히 집계
- [ ] 회원 매입 현황: 해당 회원 등급의 확정 가격 기반으로 정확히 집계
- [ ] 모든 주문 목록 테이블에 회원등급별 공급가가 올바르게 표시
- [ ] 기존 기능에 영향 없음 확인
