import { SolapiMessageService } from 'solapi';

export class SolapiService {
  private messageService: SolapiMessageService;
  private apiKey: string;
  private apiSecret: string;
  private sender: string;
  private pfId: string;

  constructor() {
    this.apiKey = process.env.SOLAPI_API_KEY || '';
    this.apiSecret = process.env.SOLAPI_API_SECRET || '';
    this.sender = process.env.SOLAPI_SENDER || '';
    this.pfId = process.env.KAKAO_PFID || '';

    // ì†”ë¼í”¼ ê³µì‹ SDK ì´ˆê¸°í™”
    this.messageService = new SolapiMessageService(this.apiKey, this.apiSecret);
    
    console.log('âœ… Solapi SDK ì´ˆê¸°í™” ì™„ë£Œ');
  }

  /**
   * í…œí”Œë¦¿ ìƒì„¸ ì¡°íšŒ (ì†”ë¼í”¼ ê³µì‹ SDK ì‚¬ìš©)
   */
  async getTemplateDetail(templateId: string): Promise<any> {
    try {
      console.log('ğŸ” í…œí”Œë¦¿ ì¡°íšŒ ì‹œì‘:', templateId);

      // ì†”ë¼í”¼ SDKì˜ ë‚´ì¥ ë©”ì„œë“œ ì‚¬ìš©
      const response = await this.messageService.getKakaoTemplates({
        templateId: templateId
      });

      console.log('âœ… í…œí”Œë¦¿ ì¡°íšŒ ì„±ê³µ:', response);

      return {
        success: true,
        data: response
      };
    } catch (error: any) {
      console.error('âŒ í…œí”Œë¦¿ ì¡°íšŒ ì‹¤íŒ¨:', error);
      
      return {
        success: false,
        error: {
          status: error.statusCode || 500,
          message: error.message || 'í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
          code: error.errorCode || 'UNKNOWN_ERROR',
          details: error
        }
      };
    }
  }

  /**
   * ì•Œë¦¼í†¡ ë°œì†¡ (ë‹¨ì¼)
   */
  async sendAlimtalk(params: {
    to: string;
    templateId: string;
    variables?: Record<string, string>;
  }): Promise<any> {
    try {
      const response = await this.messageService.send({
        to: params.to,
        from: this.sender,
        kakaoOptions: {
          pfId: this.pfId,
          templateId: params.templateId,
          variables: params.variables || {}
        }
      });

      return {
        success: true,
        data: response
      };
    } catch (error: any) {
      console.error('âŒ ì•Œë¦¼í†¡ ë°œì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.message || 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'
      };
    }
  }

  /**
   * ì•Œë¦¼í†¡ ëŒ€ëŸ‰ ë°œì†¡
   */
  async sendAlimtalkBulk(recipients: Array<{
    to: string;
    templateId: string;
    variables?: Record<string, string>;
  }>): Promise<any> {
    try {
      const messages = recipients.map(recipient => ({
        to: recipient.to,
        from: this.sender,
        kakaoOptions: {
          pfId: this.pfId,
          templateId: recipient.templateId,
          variables: recipient.variables || {}
        }
      }));

      const response = await this.messageService.send(messages);

      return {
        success: true,
        data: response
      };
    } catch (error: any) {
      console.error('âŒ ëŒ€ëŸ‰ ë°œì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.message || 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'
      };
    }
  }

  /**
   * ë¸Œëœë“œí†¡ ë°œì†¡
   */
  async sendBrandtalk(params: {
    recipients: string[];
    title: string;
    message: string;
    buttonName?: string;
    buttonUrl?: string;
  }): Promise<any> {
    try {
      const messages = params.recipients.map(to => ({
        to,
        from: this.sender,
        type: 'CTA',
        kakaoOptions: {
          pfId: this.pfId,
          templateId: null, // ë¸Œëœë“œí†¡ì€ í…œí”Œë¦¿ ë¶ˆí•„ìš”
          ad: {
            title: params.title,
            message: params.message
          },
          buttons: params.buttonName && params.buttonUrl ? [
            {
              buttonName: params.buttonName,
              buttonType: 'WL',
              linkMo: params.buttonUrl,
              linkPc: params.buttonUrl
            }
          ] : undefined
        }
      }));

      const response = await this.messageService.send(messages);

      return {
        success: true,
        data: response
      };
    } catch (error: any) {
      console.error('âŒ ë¸Œëœë“œí†¡ ë°œì†¡ ì‹¤íŒ¨:', error);
      return {
        success: false,
        error: error.message || 'ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤'
      };
    }
  }
}

export const solapiService = new SolapiService();
