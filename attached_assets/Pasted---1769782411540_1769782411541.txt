ìˆ˜ì • ìš”ì²­
====================================
ğŸ”§ ë¸Œëœë“œí†¡ ë°œì†¡ ê¸°ëŠ¥ êµ¬í˜„
====================================

ğŸ“‹ ì‘ì—… ë‚´ìš©:

1. server/services/solapi.tsì— ë¸Œëœë“œí†¡ ë°œì†¡ ë©”ì„œë“œ ì¶”ê°€:

ê¸°ì¡´ SolapiService í´ë˜ìŠ¤ì— ë‹¤ìŒ ë©”ì„œë“œ ì¶”ê°€:

```typescript
// ë¸Œëœë“œí†¡ ì§ì ‘ ë°œì†¡ (í…œí”Œë¦¿ ì—†ì´)
async sendBrandTalk(params: {
  to: string[];           // ìˆ˜ì‹  ë²ˆí˜¸ ë°°ì—´
  from: string;           // ë°œì‹  ë²ˆí˜¸
  content: string;        // ë©”ì‹œì§€ ë‚´ìš©
  buttons?: any[];        // ë²„íŠ¼ ë°°ì—´
  targeting?: string;     // I, M, N (ê¸°ë³¸: I)
}) {
  try {
    console.log('ğŸš€ [Solapi] ë¸Œëœë“œí†¡ ë°œì†¡ ì‹œì‘');
    console.log('   - ìˆ˜ì‹ ì:', params.to.length, 'ëª…');

    const messages = params.to.map(phoneNumber => ({
      to: phoneNumber,
      from: params.from,
      kakaoOptions: {
        pfId: this.kakaoPfId,
        templateId: null,  // í…œí”Œë¦¿ ì—†ì´ ì§ì ‘ ë°œì†¡
        variables: {},
        bms: {
          targeting: params.targeting || 'I',
          content: params.content,
          buttons: params.buttons || []
        }
      }
    }));

    const result = await this.solapiClient.send(messages);
    
    console.log('âœ… [Solapi] ë¸Œëœë“œí†¡ ë°œì†¡ ì„±ê³µ:', result.groupId);

    return {
      success: true,
      data: result
    };

  } catch (error: any) {
    console.error('âŒ [Solapi] ë¸Œëœë“œí†¡ ë°œì†¡ ì‹¤íŒ¨:', error);
    return {
      success: false,
      error: {
        message: error.message || 'ë°œì†¡ ì‹¤íŒ¨'
      }
    };
  }
}
server/routes.tsì— ë°œì†¡ ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„:
ê¸°ì¡´ POST /api/admin/brandtalk/send ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì•„ë˜ë¡œ êµì²´:

Copyapp.post('/api/admin/brandtalk/send', async (req, res) => {
  try {
    if (!req.isAuthenticated() || req.user?.role !== 'admin') {
      return res.status(403).json({ 
        success: false, 
        error: 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' 
      });
    }

    const { templateId, recipients, targeting } = req.body;

    if (!templateId || !Array.isArray(recipients) || recipients.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'í…œí”Œë¦¿ê³¼ ìˆ˜ì‹ ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”'
      });
    }

    console.log('ğŸ“¥ ë¸Œëœë“œí†¡ ë°œì†¡ ìš”ì²­');
    console.log('   - í…œí”Œë¦¿ ID:', templateId);
    console.log('   - ìˆ˜ì‹ ì ìˆ˜:', recipients.length);

    // DBì—ì„œ í…œí”Œë¦¿ ì¡°íšŒ
    const template = await storage.db
      .prepare('SELECT * FROM brandtalk_templates WHERE id = ?')
      .get(templateId);

    if (!template) {
      return res.status(404).json({
        success: false,
        error: 'í…œí”Œë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'
      });
    }

    // ë²„íŠ¼ íŒŒì‹±
    let buttons = [];
    try {
      buttons = JSON.parse(template.buttons || '[]');
    } catch (e) {
      console.warn('ë²„íŠ¼ íŒŒì‹± ì‹¤íŒ¨:', e);
    }

    // ì†”ë¼í”¼ë¡œ ë°œì†¡
    const result = await solapiService.sendBrandTalk({
      to: recipients,
      from: process.env.SOLAPI_SENDER || '',
      content: template.message_content,
      buttons: buttons,
      targeting: targeting || 'I'
    });

    if (!result.success) {
      return res.status(500).json({
        success: false,
        error: result.error?.message || 'ë°œì†¡ ì‹¤íŒ¨'
      });
    }

    // ë°œì†¡ ì´ë ¥ ì €ì¥
    const cost = recipients.length * 27; // ë¸Œëœë“œí†¡ 27ì›/ê±´

    await storage.db
      .prepare(`
        INSERT INTO brandtalk_history (
          template_id, sent_count, success_count, failed_count, 
          total_cost, sent_at
        ) VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
      `)
      .run(templateId, recipients.length, recipients.length, 0, cost);

    console.log('âœ… ë¸Œëœë“œí†¡ ë°œì†¡ ì™„ë£Œ');

    return res.json({
      success: true,
      sentCount: recipients.length,
      cost: cost,
      message: `${recipients.length}ê±´ ë°œì†¡ ì™„ë£Œ (${cost.toLocaleString()}ì›)`
    });

  } catch (error: any) {
    console.error('âŒ ë¸Œëœë“œí†¡ ë°œì†¡ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});
Copy
í”„ë¡ íŠ¸ì—”ë“œëŠ” ìˆ˜ì • ë¶ˆí•„ìš” (ì´ë¯¸ ë°œì†¡ ëª¨ë‹¬ êµ¬í˜„ë˜ì–´ ìˆìŒ)
==================================== âœ… ì™„ë£Œ í›„ í…ŒìŠ¤íŠ¸:

ë¸Œëœë“œí†¡ ì‘ì„± í›„ ì €ì¥
[ë°œì†¡] ë²„íŠ¼ í´ë¦­
ìˆ˜ì‹ ì ì„ íƒ
[ë°œì†¡í•˜ê¸°] í´ë¦­
ì‹¤ì œ ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ë©”ì‹œì§€ ìˆ˜ì‹  í™•ì¸ ====================================
