ë°±ì—”ë“œ ë¼ìš°íŠ¸ ì¶”ê°€ (server/routes.ts)
Copy// ì†”ë¼í”¼ ë¸Œëœë“œ í…œí”Œë¦¿ ëª©ë¡ ì¡°íšŒ
app.get('/api/admin/brandtalk/solapi/templates', async (req, res) => {
  try {
    if (!req.isAuthenticated() || req.user?.role !== 'admin') {
      return res.status(403).json({ 
        success: false, 
        error: 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' 
      });
    }

    console.log('ğŸ“¥ ì†”ë¼í”¼ ë¸Œëœë“œ í…œí”Œë¦¿ ì¡°íšŒ ìš”ì²­');

    const result = await solapiService.getBrandTemplates();

    if (!result.success) {
      return res.status(result.error?.status || 500).json({
        success: false,
        error: result.error?.message || 'í…œí”Œë¦¿ ì¡°íšŒ ì‹¤íŒ¨'
      });
    }

    return res.json({
      success: true,
      templates: result.data
    });

  } catch (error: any) {
    console.error('âŒ ë¸Œëœë“œ í…œí”Œë¦¿ ì¡°íšŒ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});

// ì†”ë¼í”¼ ë¸Œëœë“œ í…œí”Œë¦¿ ë™ê¸°í™” (DBì— ì €ì¥)
app.post('/api/admin/brandtalk/solapi/sync', async (req, res) => {
  try {
    if (!req.isAuthenticated() || req.user?.role !== 'admin') {
      return res.status(403).json({ 
        success: false, 
        error: 'ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤' 
      });
    }

    const { templateIds } = req.body; // ì„ íƒí•œ í…œí”Œë¦¿ ID ë°°ì—´

    if (!Array.isArray(templateIds) || templateIds.length === 0) {
      return res.status(400).json({
        success: false,
        error: 'í…œí”Œë¦¿ì„ ì„ íƒí•´ì£¼ì„¸ìš”'
      });
    }

    console.log('ğŸ“¥ ì†”ë¼í”¼ ë¸Œëœë“œ í…œí”Œë¦¿ ë™ê¸°í™” ìš”ì²­:', templateIds.length, 'ê°œ');

    const syncedTemplates = [];
    const errors = [];

    for (const templateId of templateIds) {
      // ì†”ë¼í”¼ì—ì„œ í…œí”Œë¦¿ ìƒì„¸ ì¡°íšŒ
      const result = await solapiService.getBrandTemplateDetail(templateId);

      if (!result.success) {
        errors.push({ templateId, error: result.error?.message });
        continue;
      }

      const template = result.data;

      // DBì— ì €ì¥ (ì¤‘ë³µ ì²´í¬)
      const existing = await storage.db
        .prepare('SELECT id FROM brandtalk_templates WHERE template_id = ?')
        .get(templateId);

      if (existing) {
        // ì—…ë°ì´íŠ¸
        await storage.db
          .prepare(`
            UPDATE brandtalk_templates 
            SET title = ?, message_content = ?, buttons = ?, updated_at = CURRENT_TIMESTAMP
            WHERE template_id = ?
          `)
          .run(
            template.name || 'ì œëª© ì—†ìŒ',
            template.content || '',
            JSON.stringify(template.buttons || []),
            templateId
          );
      } else {
        // ì‹ ê·œ ë“±ë¡
        await storage.db
          .prepare(`
            INSERT INTO brandtalk_templates (
              template_id, title, message_content, buttons, created_at, updated_at
            ) VALUES (?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
          `)
          .run(
            templateId,
            template.name || 'ì œëª© ì—†ìŒ',
            template.content || '',
            JSON.stringify(template.buttons || [])
          );
      }

      syncedTemplates.push(template);
    }

    console.log('âœ… ë™ê¸°í™” ì™„ë£Œ:', syncedTemplates.length, 'ê°œ ì„±ê³µ,', errors.length, 'ê°œ ì‹¤íŒ¨');

    return res.json({
      success: true,
      synced: syncedTemplates.length,
      errors: errors.length > 0 ? errors : undefined,
      message: `${syncedTemplates.length}ê°œ í…œí”Œë¦¿ì´ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`
    });

  } catch (error: any) {
    console.error('âŒ í…œí”Œë¦¿ ë™ê¸°í™” ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: 'ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
    });
  }
});
Copy
í”„ë¡ íŠ¸ì—”ë“œ UI ìˆ˜ì • (client/src/pages/admin/kakao-notifications/brandtalk.tsx)
ë¸Œëœë“œí†¡ ê´€ë¦¬ íƒ­ ìƒë‹¨ì— [ì†”ë¼í”¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°] ë²„íŠ¼ ì¶”ê°€:

Copy// ìƒíƒœ ì¶”ê°€
const [showSolapiModal, setShowSolapiModal] = useState(false);
const [solapiTemplates, setSolapiTemplates] = useState([]);
const [selectedTemplates, setSelectedTemplates] = useState<string[]>([]);
const [isSyncing, setIsSyncing] = useState(false);

// ì†”ë¼í”¼ í…œí”Œë¦¿ ì¡°íšŒ ì¿¼ë¦¬
const { data: solapiData, isLoading: isLoadingSolapi, refetch: refetchSolapi } = useQuery({
  queryKey: ['/api/admin/brandtalk/solapi/templates'],
  enabled: showSolapiModal,
  retry: 1
});

// ë™ê¸°í™” mutation
const syncMutation = useMutation({
  mutationFn: async (templateIds: string[]) => {
    const response = await fetch('/api/admin/brandtalk/solapi/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ templateIds })
    });
    
    if (!response.ok) throw new Error('ë™ê¸°í™” ì‹¤íŒ¨');
    return response.json();
  },
  onSuccess: () => {
    toast({ title: 'ë™ê¸°í™” ì™„ë£Œ', description: 'í…œí”Œë¦¿ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤' });
    setShowSolapiModal(false);
    setSelectedTemplates([]);
    refetch(); // ë¸Œëœë“œí†¡ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
  },
  onError: () => {
    toast({ title: 'ë™ê¸°í™” ì‹¤íŒ¨', description: 'ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”', variant: 'destructive' });
  }
});

// ë¸Œëœë“œí†¡ ê´€ë¦¬ íƒ­ ìƒë‹¨ ë²„íŠ¼ ì˜ì—­ì— ì¶”ê°€
<div className="flex gap-2">
  <Button onClick={() => setShowSolapiModal(true)}>
    <Download className="w-4 h-4 mr-2" />
    ì†”ë¼í”¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°
  </Button>
  <Button onClick={() => setIsCreating(true)}>
    <Plus className="w-4 h-4 mr-2" />
    ìƒˆ ë¸Œëœë“œí†¡ ì‘ì„±
  </Button>
</div>

// ì†”ë¼í”¼ í…œí”Œë¦¿ ì„ íƒ ëª¨ë‹¬ ì¶”ê°€
<Dialog open={showSolapiModal} onOpenChange={setShowSolapiModal}>
  <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
    <DialogHeader>
      <DialogTitle>ì†”ë¼í”¼ ë¸Œëœë“œí†¡ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°</DialogTitle>
      <DialogDescription>
        ì†”ë¼í”¼ ì½˜ì†”ì— ë“±ë¡ëœ ë¸Œëœë“œí†¡ í…œí”Œë¦¿ì„ ì„ íƒí•˜ì—¬ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤
      </DialogDescription>
    </DialogHeader>

    {isLoadingSolapi ? (
      <div className="flex justify-center py-8">
        <Loader2 className="w-8 h-8 animate-spin" />
      </div>
    ) : solapiData?.templates?.length > 0 ? (
      <div className="space-y-2">
        {solapiData.templates.map((template: any) => (
          <div
            key={template.templateId}
            className="flex items-start gap-3 p-4 border rounded-lg hover:bg-gray-50 cursor-pointer"
            onClick={() => {
              setSelectedTemplates(prev =>
                prev.includes(template.templateId)
                  ? prev.filter(id => id !== template.templateId)
                  : [...prev, template.templateId]
              );
            }}
          >
            <input
              type="checkbox"
              checked={selectedTemplates.includes(template.templateId)}
              onChange={() => {}}
              className="mt-1"
            />
            <div className="flex-1">
              <h4 className="font-medium">{template.name || 'ì œëª© ì—†ìŒ'}</h4>
              <p className="text-sm text-gray-500 mt-1">
                {template.content?.substring(0, 100)}...
              </p>
              <p className="text-xs text-gray-400 mt-2">
                ID: {template.templateId}
              </p>
            </div>
          </div>
        ))}
      </div>
    ) : (
      <div className="text-center py-8 text-gray-500">
        ë“±ë¡ëœ ë¸Œëœë“œí†¡ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤
      </div>
    )}

    <DialogFooter>
      <Button variant="outline" onClick={() => setShowSolapiModal(false)}>
        ì·¨ì†Œ
      </Button>
      <Button
        onClick={() => syncMutation.mutate(selectedTemplates)}
        disabled={selectedTemplates.length === 0 || syncMutation.isPending}
      >
        {syncMutation.isPending ? (
          <>
            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            ë™ê¸°í™” ì¤‘...
          </>
        ) : (
          `ì„ íƒí•œ ${selectedTemplates.length}ê°œ ë¶ˆëŸ¬ì˜¤ê¸°`
        )}
      </Button>
    </DialogFooter>
  </DialogContent>
</Dialog>
Copy
í•„ìš”í•œ import ì¶”ê°€:

Copyimport { Download, Loader2 } from 'lucide-react';