# 매출 통계 시스템 구현 요구사항 — Phase 1

## 1. 목적

기존 "통계관리" 페이지(현재 "준비중" 상태)를 실제 매출 통계 대시보드로 구현합니다.
주문 데이터를 기반으로 회원별, 상품별, 업체별 매출 현황을 시각적으로 파악할 수 있어야 합니다.

---

## 2. 페이지 구조

통계관리 페이지를 **탭 구조**로 구성합니다.

```
통계관리
├─ [매출 개요]          ← 전체 매출 요약 + 차트
├─ [회원별(업체별) 매출]  ← 회원(셀러/업체)별 매출 분석
└─ [상품별 매출]         ← 상품별 매출 분석
```

> **용어 정리**: "회원" = "업체" = "셀러" = 물건을 주문하는 사업자입니다.
> 공급자(Vendor) 관련 매입/원가 분석은 별도 "회계장부" 기능에서 다루며, 이 통계에서는 다루지 않습니다.

모든 탭에 공통으로 **기간 필터**를 적용합니다:
- 오늘 / 이번 주 / 이번 달 / 지난 달 / 3개월 / 6개월 / 1년 / 사용자 지정
- 기간 필터 변경 시 모든 차트와 테이블이 동시에 업데이트

---

## 3. 매출 기준 정의

### 매출 확정 시점
- **"배송중" 상태로 전환된 주문**만 매출로 인정합니다
- 대기/상품준비중/배송준비중 = 예상 매출 (확정 아님)
- 매출 확정 시점 = 주문의 status가 'shipping'으로 변경된 시점

### 매출액 계산
- 매출액 = 각 주문행(order_items)의 (단가 × 수량)
- 회원별 매출 = 해당 회원의 확정 주문 합계
- 상품별 매출 = 해당 상품의 확정 주문 합계
- 업체별 매출 = 해당 업체 상품의 확정 주문 합계

---

## 4. 탭별 상세 요구사항

### 4-1. 매출 개요 탭

#### 상단 요약 카드 (4개)
| 카드 | 내용 |
|------|------|
| 총 매출액 | 선택 기간의 확정 매출 합계 (전기간 대비 증감률 %) |
| 총 주문 건수 | 확정 주문 수 (전기간 대비 증감률 %) |
| 평균 주문금액 | 총 매출액 ÷ 주문 건수 |
| 활성 회원 수 | 기간 내 주문한 회원 수 |

#### 매출 추이 차트 (메인 차트)
- **라인 차트**: 일별 매출액 추이
- X축: 날짜, Y축: 매출액
- 기간이 길면 자동으로 주별/월별로 집계 단위 변경
- 차트 위에 마우스 오버 시 해당 날짜의 매출액/건수 툴팁

#### 매출 구성 차트 (하단 2개 나란히)
- **도넛 차트**: 회원별(업체별) 매출 비중 (상위 5명 + 기타)
- **막대 차트**: 상품별 매출 순위 (상위 10개)

### 4-2. 회원별(업체별) 매출 탭

#### 회원 매출 테이블
| 컬럼 | 설명 |
|------|------|
| 순위 | 매출 순위 |
| 회원명(업체명) | 회원 이름 + 상호명 |
| 주문 건수 | 기간 내 확정 주문 수 |
| 매출액 | 기간 내 총 매출액 |
| 평균 주문금액 | 매출액 ÷ 주문 건수 |
| 매출 비중 | 전체 매출 대비 비율 (%) |
| 추이 | 미니 스파크라인 차트 (최근 7일/7주 추이) |

- 정렬: 매출액 내림차순 (기본), 컬럼 클릭으로 정렬 변경 가능
- 검색: 회원명/상호명으로 검색

#### 회원 상세 보기 (행 클릭 시 확장)
- 해당 회원의 기간 내 일별 매출 차트
- 해당 회원이 주문한 상품별 매출 내역

### 4-3. 상품별 매출 탭

#### 상품 필터 영역 (테이블 상단)
| 필터 | 설명 |
|------|------|
| 대분류 | 드롭다운 선택 (예: 과일, 채소 등) — 선택 시 중분류 목록 갱신 |
| 중분류 | 드롭다운 선택 (예: 사과, 배, 감귤 등) — 대분류 선택 후 활성화, 선택 시 소분류 목록 갱신 |
| 소분류 | 드롭다운 선택 (예: 부사, 홍로 등) — 중분류 선택 후 활성화 |
| 상품명 검색 | 텍스트 입력으로 상품명 직접 검색 |

- 대분류 → 중분류 → 소분류 **연동 필터** (상위 선택에 따라 하위 목록 자동 갱신)
- 각 드롭다운에 "전체" 옵션 포함
- 카테고리 필터와 상품명 검색은 동시 적용 가능

#### 상품 매출 테이블
| 컬럼 | 설명 |
|------|------|
| 순위 | 매출 순위 |
| 상품명 | 상품 이름 |
| 분류 | 대분류 > 중분류 > 소분류 |
| 판매 수량 | 기간 내 총 판매 수량 |
| 매출액 | 기간 내 총 매출액 |
| 매출 비중 | 전체 매출 대비 비율 (%) |
| 추이 | 미니 스파크라인 차트 |

- 정렬: 매출액 내림차순 (기본)

#### 상품 상세 보기 (행 클릭 시 확장)
- 해당 상품의 기간 내 일별 판매 차트
- 해당 상품을 구매한 회원별 내역

---

## 5. 드릴다운 상세 조회 (중요)

모든 통계 화면에서 **요약 → 상세 → 개별 주문**까지 단계적으로 확인할 수 있어야 합니다.

### 드릴다운 흐름

```
[Level 1] 차트/요약 카드
    │ 클릭
    ▼
[Level 2] 해당 항목의 상세 테이블
    │ 클릭
    ▼
[Level 3] 개별 주문 내역
```

### 탭별 드릴다운 시나리오

#### 매출 개요 탭
| 클릭 대상 | 드릴다운 결과 |
|----------|-------------|
| 매출 추이 차트의 특정 날짜 | 해당 날짜의 전체 주문 목록 (주문번호, 회원, 상품, 수량, 금액, 상태) |
| 요약카드 "총 주문 건수" | 기간 내 전체 주문 목록 테이블로 이동 |
| 회원별 도넛 차트의 특정 회원 | "회원별(업체별) 매출" 탭 → 해당 회원 상세로 이동 |
| 상품별 막대 차트의 특정 상품 | "상품별 매출" 탭 → 해당 상품 상세로 이동 |

#### 회원별(업체별) 매출 탭
| 클릭 대상 | 드릴다운 결과 |
|----------|-------------|
| 회원 행 클릭 | 확장: 해당 회원의 일별 매출 차트 + 상품별 구매 내역 테이블 |
| 상품별 내역에서 상품 클릭 | 해당 회원이 해당 상품을 주문한 개별 주문 목록 |
| 개별 주문 클릭 | 주문 상세 모달 (주문 전체 정보, 배송정보, 정산내역) |

#### 상품별 매출 탭
| 클릭 대상 | 드릴다운 결과 |
|----------|-------------|
| 상품 행 클릭 | 확장: 해당 상품의 일별 판매 차트 + 구매 회원별 내역 테이블 |
| 회원별 내역에서 회원 클릭 | 해당 회원이 해당 상품을 주문한 개별 주문 목록 |
| 개별 주문 클릭 | 주문 상세 모달 |

### 주문 상세 모달 (Level 3 공통)

모든 드릴다운의 최종 단계에서 개별 주문을 클릭하면 표시되는 모달:

| 항목 | 내용 |
|------|------|
| 주문 정보 | 주문번호, 주문일시, 현재 상태 |
| 회원 정보 | 회원명, 상호명, 아이디 |
| 주문 상품 | 상품명, 수량, 단가, 소계 (전체 주문 상품 목록) |
| 배송 정보 | 택배사, 운송장번호, 배송상태 |
| 정산 내역 | 포인터 차감액, 예치금 차감액, 정산일시 |
| 합계 | 총 주문금액 |

### 주문 목록 테이블 (Level 2 공통)

드릴다운 시 표시되는 주문 목록 테이블의 공통 컬럼:

| 컬럼 | 설명 |
|------|------|
| 주문번호 | 클릭 시 주문 상세 모달 |
| 주문일시 | KST 기준 |
| 회원명 | 주문 회원 |
| 상품명 | 주문 상품 (여러 개일 수 있음) |
| 수량 | 총 수량 |
| 주문금액 | 총 금액 |
| 상태 | 배송중/배송완료 등 |

- 페이지네이션 적용 (20건 단위)
- 엑셀 다운로드 버튼 (해당 목록을 엑셀로 내보내기)

---

## 6. 백엔드 API

### 필요한 엔드포인트

| 엔드포인트 | Method | 설명 |
|-----------|--------|------|
| GET /api/admin/statistics/overview | GET | 매출 개요 (요약카드 + 차트 데이터) |
| GET /api/admin/statistics/by-member | GET | 회원별(업체별) 매출 목록 |
| GET /api/admin/statistics/by-member/:id | GET | 특정 회원 매출 상세 |
| GET /api/admin/statistics/by-product | GET | 상품별 매출 목록 |
| GET /api/admin/statistics/by-product/:id | GET | 특정 상품 매출 상세 |
| GET /api/admin/statistics/orders | GET | 드릴다운용 주문 목록 (필터: date, memberId, productId) |
| GET /api/admin/statistics/orders/:id | GET | 주문 상세 모달용 데이터 (주문정보 + 배송 + 정산내역) |
| GET /api/admin/statistics/orders/export | GET | 주문 목록 엑셀 다운로드 |

### 공통 쿼리 파라미터
- `startDate`: 시작일 (YYYY-MM-DD)
- `endDate`: 종료일 (YYYY-MM-DD)
- `groupBy`: 집계 단위 (day / week / month) — 차트용

### 매출 데이터 조회 기준
```sql
-- 확정 매출 = 배송중 상태의 주문
-- orders 테이블에서 status = 'shipping' 또는 'delivered' 또는 'completed'인 주문
-- (배송중 전환된 이후의 모든 상태 포함)
-- 매출 확정 시점 = settlement_history의 createdAt 또는 orders의 상태 변경 시점
```

---

## 6. 차트 라이브러리

- **Recharts** 사용 (이미 프로젝트에 설치되어 있을 가능성 높음)
- 반응형 차트 (모바일에서도 보기 좋게)
- 차트 종류: LineChart (추이), BarChart (비교), PieChart/DonutChart (비중)

---

## 7. UI/UX 가이드라인

### 디자인 원칙
- 기존 관리자 페이지 디자인 패턴과 일관성 유지
- 차트는 깔끔하고 읽기 쉽게 (과도한 색상 사용 지양)
- 숫자는 천 단위 콤마 + "원" / "건" 등 단위 표시
- 증감률은 초록(증가)/빨강(감소) 색상으로 구분

### 반응형
- 데스크톱: 차트 2개 나란히 배치
- 모바일: 차트 세로 배치

### 로딩 상태
- 데이터 로딩 중 스켈레톤 UI 표시
- 데이터 없을 때 "해당 기간에 매출 데이터가 없습니다" 메시지

---

## 8. 데이터 기준 참고

### 주문 상태값 (참고)
현재 시스템의 주문 상태 흐름:
```
pending(대기) → preparing(상품준비중) → ready(배송준비중) → shipping(배송중) → delivered(배송완료)
```

매출 확정 = shipping 이후 상태의 주문 (shipping, delivered, completed)

### 기존 테이블 활용
- orders: 주문 정보 (회원, 상태, 날짜)
- order_items: 주문 상세 (상품, 수량, 단가)
- members: 회원 정보 (이름, 상호명) — 회원 = 업체 = 셀러
- products: 상품 정보 (상품명)
- settlement_history: 정산 이력 (확정 시점 참고)

> **참고**: 공급업체(vendors) 관련 매입/원가 분석은 이 통계에 포함하지 않으며, 별도 "회계장부" 기능에서 다룹니다.

---

## 9. 중요 규칙

1. **매출 = 배송중 이후 상태만**: 대기/준비중은 "예상 매출"이지 확정 매출이 아닙니다.
2. **기간 필터는 KST 기준**: UTC가 아닌 한국 시간 기준으로 필터링합니다.
3. **성능 고려**: 데이터가 많아질 수 있으므로, 집계 쿼리는 인덱스를 활용하고 필요시 캐싱을 적용합니다.
4. **전기간 대비 증감률**: "이번 달" 선택 시 → "지난 달" 대비 증감률 자동 계산. "사용자 지정 30일" → 이전 30일 대비.
5. **빈 데이터 처리**: 매출이 0인 날짜도 차트에 0으로 표시 (빈 공간이 아닌 연속 라인 유지).

---

## 10. 향후 확장 예정 (Phase 2~4)

이 Phase 1이 완료된 후 아래 기능들을 추가할 예정이므로, 확장 가능한 구조로 만들어주세요:

- **AI 자연어 질의**: 관리자가 "이번 달 사과 매출 알려줘" 같은 질문을 입력하면 데이터를 조회해서 답변
- **매출 예측**: 과거 데이터 기반 다음 주/월 예상 매출
- **이상 감지**: 매출 급등/급락 자동 알림
- **AI 리포트**: 주간/월간 자동 분석 보고서 생성

이를 위해 통계 API는 범용적으로 설계하고, 통계 페이지에 나중에 "AI 분석" 탭을 추가할 수 있도록 탭 구조를 확장 가능하게 만들어주세요.
