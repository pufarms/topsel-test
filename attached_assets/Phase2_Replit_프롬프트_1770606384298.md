# 탑셀러 외주 협력업체 시스템 - Phase 2 구현 프롬프트

## 배분 시스템 (주문마감 → 외주상품 분류 → 업체 알림 → 가능수량 접수 → 배분 확정)

> **사용법**: Phase 2-1부터 순서대로 Replit AI에 붙여넣기 하세요.
> 각 단계 완료 후 다음 단계로 넘어갑니다.
> **Phase 1이 완료된 상태에서 진행**해야 합니다.

---

## Phase 2-1: 배분 관련 DB 테이블 생성 (order_allocations + allocation_details)

```
[작업 지시]
외주 주문 배분을 위한 2개의 신규 테이블을 생성합니다.
Phase 1에서 만든 vendors, product_vendors, pending_orders 확장 필드를 기반으로 합니다.

⚠️ 중요 원칙:
- 기존 테이블(vendors, product_vendors, pending_orders 등)은 수정하지 마세요.
- 신규 테이블 2개만 추가합니다.
- 기존 코드, 라우트, 화면에 영향을 주지 마세요.
- 작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[1단계: DB - order_allocations 테이블 생성]

일일 배분 마스터 테이블입니다. 주문 마감 후 외주상품별 총 필요수량을 집계합니다.

order_allocations 테이블 스키마:
- id: serial PRIMARY KEY
- allocationDate: date NOT NULL — 배분 날짜 (주문 마감일)
- productCode: varchar NOT NULL — 상품코드
- productName: varchar(200) — 상품명 (조회 편의용)
- totalQuantity: integer NOT NULL — 총 필요수량 (해당 날짜 전체 주문 합계)
- allocatedQuantity: integer DEFAULT 0 — 배분 완료 수량
- unallocatedQuantity: integer — 미배분 수량 (totalQuantity - allocatedQuantity)
- status: varchar(20) DEFAULT 'pending' — 상태값:
  * 'pending': 배분 대기 (초기 상태)
  * 'notifying': 업체 알림 발송 중
  * 'waiting': 업체 회신 대기 중
  * 'confirmed': 배분 확정 완료
  * 'cancelled': 취소
- memo: text — 관리자 메모
- createdAt: timestamp DEFAULT NOW()
- updatedAt: timestamp DEFAULT NOW()
- UNIQUE(allocationDate, productCode) — 같은 날짜+상품 중복 방지

[2단계: DB - allocation_details 테이블 생성]

업체별 배분 상세 테이블입니다.
v4 설계서 확정: 주문 분할 가능 (1개 allocation → N개 details)

allocation_details 테이블 스키마:
- id: serial PRIMARY KEY
- allocationId: integer NOT NULL REFERENCES order_allocations(id) — 배분 마스터 참조
- vendorId: integer REFERENCES vendors(id) — 외주업체 ID (NULL이면 탑셀러 자체 발송)
- vendorName: varchar(100) — 업체명 (조회 편의용)
- requestedQuantity: integer DEFAULT 0 — 관리자가 요청한 수량
- confirmedQuantity: integer DEFAULT NULL — 업체가 확인(회신)한 가능 수량
- allocatedQuantity: integer DEFAULT 0 — 최종 배분 확정 수량
- vendorPrice: integer — 해당 업체의 매입가 (product_vendors에서 가져옴)
- status: varchar(20) DEFAULT 'pending' — 상태값:
  * 'pending': 대기
  * 'notified': 알림 발송됨 (업체에게 알림톡+대시보드)
  * 'responded': 업체 회신 완료
  * 'confirmed': 배분 확정
  * 'rejected': 업체 거절 또는 관리자 취소
- notifiedAt: timestamp — 알림 발송 시각
- respondedAt: timestamp — 업체 회신 시각
- confirmedAt: timestamp — 배분 확정 시각
- memo: text — 메모
- createdAt: timestamp DEFAULT NOW()
- updatedAt: timestamp DEFAULT NOW()

[3단계: Storage 메서드 추가]

IStorage 인터페이스와 DatabaseStorage 클래스에 다음 메서드를 추가합니다.
기존 메서드는 수정하지 마세요. 새 메서드만 추가합니다.

order_allocations 관련:
- createOrderAllocation(data) — 배분 마스터 생성
- getOrderAllocationsByDate(date) — 날짜별 배분 목록 조회
- getOrderAllocationById(id) — 배분 마스터 상세 조회
- updateOrderAllocation(id, data) — 배분 마스터 수정 (상태, 수량 등)

allocation_details 관련:
- createAllocationDetail(data) — 배분 상세 생성
- getAllocationDetailsByAllocationId(allocationId) — 배분 마스터별 상세 목록
- getAllocationDetailsByVendorId(vendorId) — 업체별 배분 상세 목록
- updateAllocationDetail(id, data) — 배분 상세 수정 (확인수량, 상태 등)
- deleteAllocationDetail(id) — 배분 상세 삭제

[완료 확인]
- order_allocations, allocation_details 테이블이 정상 생성되는지 확인
- Storage 메서드가 모두 추가되었는지 확인
- 기존 테이블과 기존 storage 메서드에 영향이 없는지 확인
- db:push (또는 마이그레이션)가 정상 실행되는지 확인
- 결과를 한글로 보고해 주세요
```

---

## Phase 2-2: 주문 마감 후 외주상품 자동 분류 + 수량 집계

```
[작업 지시]
주문 마감 후 외주상품을 자동 분류하고 상품별 총 필요수량을 집계하는 기능을 구현합니다.

⚠️ 중요 원칙:
- 기존 주문 마감 프로세스를 수정하지 마세요.
- 배분 집계는 "별도 API"로 관리자가 수동 실행합니다 (자동 트리거 아님).
- 기존 pending_orders 데이터를 읽기만 하고, 이 단계에서는 수정하지 마세요.
- 작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[1단계: API - 외주상품 자동 분류 + 집계]

POST /api/admin/allocations/generate
관리자가 특정 날짜의 외주상품을 집계하는 API입니다.

요청 본문: { date: "2026-02-09" } (배분 대상 날짜)

처리 로직:
1. 해당 날짜의 pending_orders에서 외주 가능 상품을 추출합니다.
   - product_vendors 테이블에 매핑이 있는 상품(productCode)을 찾습니다.
   - 또는 product_registrations.isVendorProduct = true인 상품을 찾습니다.
   - 이미 vendorId가 배정된 주문(배분 완료)은 제외합니다.
   - 주문 상태가 '대기' 또는 '상품준비중'인 것만 대상으로 합니다.

2. 상품별로 총 필요수량을 집계합니다.
   예) NGK-3KG: 주문 5건, 총 수량 150박스
       SAG-5KG: 주문 3건, 총 수량 80박스

3. 집계 결과를 order_allocations 테이블에 저장합니다.
   - 같은 날짜+상품이 이미 존재하면 수량을 업데이트합니다 (UPSERT).
   - status = 'pending'

4. 각 상품별로 공급 가능한 업체 목록도 함께 반환합니다.
   - product_vendors에서 해당 상품의 활성 업체 조회
   - 업체별 매입가 포함

응답 형식:
{
  "date": "2026-02-09",
  "totalProducts": 2,
  "allocations": [
    {
      "id": 1,
      "productCode": "NGK-3KG",
      "productName": "노지감귤 3kg",
      "totalQuantity": 150,
      "status": "pending",
      "availableVendors": [
        { "vendorId": 1, "companyName": "A농원", "vendorPrice": 8000 },
        { "vendorId": 2, "companyName": "B과수원", "vendorPrice": 8500 }
      ]
    }
  ]
}

[2단계: API - 배분 현황 조회]

GET /api/admin/allocations?date=2026-02-09
날짜별 배분 현황을 조회합니다.

응답에 포함할 정보:
- order_allocations 목록 (해당 날짜)
- 각 allocation별 allocation_details 목록
- 각 allocation별 공급 가능 업체 목록 (product_vendors에서)
- 전체 요약: 총 상품 수, 배분 완료 수, 대기 수

GET /api/admin/allocations/:id
특정 배분 마스터의 상세 정보를 조회합니다.
- allocation_details 포함
- 해당 상품의 관련 주문 목록 (pending_orders에서 해당 productCode)

[완료 확인]
- 외주상품 집계 API가 정상 동작하는지 확인
- 같은 날짜로 재실행 시 UPSERT (수량 업데이트)가 되는지 확인
- 배분 현황 조회가 정상 동작하는지 확인
- ⚡ 기존 주문 관련 API가 정상 동작하는지 확인
- 결과를 한글로 보고해 주세요
```

---

## Phase 2-3: 업체별 예상수량 알림 발송 (알림톡 + 대시보드)

```
[작업 지시]
관리자가 배분할 업체를 선택하여 예상수량 알림을 발송하는 기능을 구현합니다.
알림 채널: 알림톡(솔라피) + 대시보드 알림 (v4 확정)

⚠️ 중요 원칙:
- 기존 솔라피 연동 코드가 있다면 그 패턴을 따르세요.
- 기존 알림 기능에 영향을 주지 마세요.
- 솔라피 발송이 실패해도 대시보드 알림은 정상 저장되어야 합니다.
- 작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[1단계: API - 업체에 예상수량 알림 발송]

POST /api/admin/allocations/:allocationId/notify
관리자가 특정 배분 건에 대해 업체에 알림을 보냅니다.

요청 본문:
{
  "vendors": [
    { "vendorId": 1, "requestedQuantity": 100 },
    { "vendorId": 2, "requestedQuantity": 50 }
  ]
}

처리 로직:
1. allocation_details에 각 업체별 레코드를 생성합니다.
   - requestedQuantity: 관리자가 요청한 수량
   - vendorPrice: product_vendors에서 해당 상품+업체의 매입가 조회
   - status: 'notified'
   - notifiedAt: NOW()

2. order_allocations 상태를 'notifying' → 'waiting'으로 변경

3. 알림 발송 (2채널 동시):

   [채널 A: 솔라피 알림톡]
   기존 프로젝트에서 솔라피(Solapi) 연동 코드를 찾아서 동일한 패턴으로 발송합니다.
   - 수신자: vendors.contactPhone
   - 메시지 내용 (예시):
     "[탑셀러] 배분 요청
      상품: {상품명}
      요청수량: {requestedQuantity}박스
      매입가: {vendorPrice}원
      마감시간: {현재시각 + 2시간}
      대시보드에서 가능수량을 입력해 주세요."

   ※ 솔라피 API 키가 설정되어 있지 않거나 발송 실패 시:
   - 에러 로그만 남기고 진행 (대시보드 알림은 정상 저장)
   - 응답에 알림톡 발송 실패 여부를 포함

   [채널 B: 대시보드 알림]
   allocation_details의 status = 'notified'로 저장하면,
   Phase 3에서 만들 외주업체 대시보드에서 이 데이터를 조회할 수 있습니다.
   (이 단계에서는 DB에 저장하는 것까지만 구현)

4. 응답:
{
  "allocationId": 1,
  "notifiedVendors": [
    { "vendorId": 1, "companyName": "A농원", "requestedQuantity": 100, "notified": true, "kakaoSent": true },
    { "vendorId": 2, "companyName": "B과수원", "requestedQuantity": 50, "notified": true, "kakaoSent": false }
  ],
  "deadline": "2026-02-09T16:00:00"
}

[2단계: API - 알림/회신 현황 조회]

GET /api/admin/allocations/:allocationId/details
해당 배분 건의 업체별 알림/회신 상태를 조회합니다.

응답에 포함:
- 업체별 상태 (notified / responded / confirmed / rejected)
- 요청수량, 확인수량(회신), 확정수량
- 알림 발송 시각, 회신 시각
- 마감시간 초과 여부

[완료 확인]
- 업체 알림 발송 API가 정상 동작하는지 확인
- allocation_details에 레코드가 생성되는지 확인
- 솔라피 연동이 기존 패턴과 동일한지 확인 (키 미설정 시 에러 없이 진행)
- 알림/회신 현황 조회가 정상인지 확인
- ⚡ 기존 솔라피 알림 기능(주문 알림 등)에 영향이 없는지 확인
- 결과를 한글로 보고해 주세요
```

---

## Phase 2-4: 가능수량 접수 + 관리자 배분 확정

```
[작업 지시]
업체가 회신한 가능수량을 접수하고, 관리자가 최종 배분을 확정하는 기능을 구현합니다.

⚠️ 중요 원칙:
- 기존 주문 데이터(pending_orders)는 배분 확정 단계(Phase 2-5)에서만 수정합니다.
- 이 단계에서는 allocation_details의 수량/상태만 관리합니다.
- 주문 분할 가능: 1개 상품의 수량을 여러 업체에 나눠서 배분할 수 있습니다.
- 작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[1단계: API - 가능수량 접수 (관리자 대신 입력)]

PUT /api/admin/allocation-details/:detailId/respond
관리자가 업체의 가능수량을 대신 입력합니다.
(업체가 카톡/전화로 알려준 경우, 또는 Phase 3 대시보드에서 직접 입력한 경우)

요청 본문:
{
  "confirmedQuantity": 80,
  "memo": "전화 통화로 확인"
}

처리 로직:
1. allocation_details 업데이트:
   - confirmedQuantity: 업체가 확인한 가능 수량
   - status: 'responded'
   - respondedAt: NOW()
   - memo 업데이트

2. 가능수량이 요청수량 이상이면 → 충분
   가능수량이 요청수량 미만이면 → 부족 (관리자가 다른 업체 추가 필요)

[2단계: API - 추가 업체 알림]

POST /api/admin/allocations/:allocationId/notify-additional
부족분에 대해 추가 업체에 알림을 보냅니다.

요청 본문:
{
  "vendors": [
    { "vendorId": 3, "requestedQuantity": 20 }
  ]
}

처리 로직:
1. 새 allocation_details 레코드를 추가 생성
2. 알림 발송 (솔라피 + 대시보드)
3. Phase 2-3과 동일한 로직

이를 통해 부족분을 다른 업체에 분할 배분할 수 있습니다.

[3단계: API - 배분 확정]

POST /api/admin/allocations/:allocationId/confirm
관리자가 최종 배분을 확정합니다.

요청 본문:
{
  "details": [
    { "detailId": 1, "allocatedQuantity": 80 },
    { "detailId": 2, "allocatedQuantity": 50 },
    { "detailId": 3, "allocatedQuantity": 20 }
  ],
  "selfQuantity": 0
}

처리 로직:
1. 각 allocation_details의 allocatedQuantity를 업데이트
   - status: 'confirmed'
   - confirmedAt: NOW()

2. allocatedQuantity가 0인 detail은 status를 'rejected'로 변경

3. selfQuantity > 0이면:
   - vendorId = NULL인 allocation_detail을 생성 (탑셀러 자체 발송분)
   - allocatedQuantity = selfQuantity
   - status: 'confirmed'

4. order_allocations 업데이트:
   - allocatedQuantity = 모든 detail의 allocatedQuantity 합계
   - unallocatedQuantity = totalQuantity - allocatedQuantity
   - status: 'confirmed' (전량 배분 시) 또는 유지 (부분 배분 시)

5. 검증:
   - 배분 총량이 필요수량(totalQuantity)을 초과하지 않는지 확인
   - 초과 시 에러 반환

6. 응답:
{
  "allocationId": 1,
  "productCode": "NGK-3KG",
  "totalQuantity": 150,
  "allocatedQuantity": 150,
  "unallocatedQuantity": 0,
  "details": [
    { "vendorId": 1, "companyName": "A농원", "allocatedQuantity": 80, "vendorPrice": 8000 },
    { "vendorId": 2, "companyName": "B과수원", "allocatedQuantity": 50, "vendorPrice": 8500 },
    { "vendorId": 3, "companyName": "C농장", "allocatedQuantity": 20, "vendorPrice": 8200 }
  ],
  "status": "confirmed"
}

[완료 확인]
- 가능수량 접수 API가 정상 동작하는지 확인
- 추가 업체 알림 API가 정상인지 확인
- 배분 확정 API가 정상 동작하는지 확인
- 배분 총량 > 필요수량일 때 에러가 반환되는지 확인
- 자체 발송분(selfQuantity) 처리가 되는지 확인
- ⚡ 기존 주문 데이터(pending_orders)가 이 단계에서는 수정되지 않는지 확인
- 결과를 한글로 보고해 주세요
```

---

## Phase 2-5: 배분 확정 → 주문 배정 연결 + 관리자 배분 화면

```
[작업 지시]
배분 확정 후 실제 주문(pending_orders)에 공급자를 배정하고,
관리자가 전체 배분 프로세스를 관리할 수 있는 화면을 구현합니다.

⚠️ 중요 원칙:
- pending_orders 수정은 이 단계에서만 수행합니다.
- vendorId, fulfillmentType, vendorPrice 필드만 업데이트합니다.
- 기존 주문 상태(status), 회원 정보, 공급가 등은 수정하지 마세요.
- 주문 분할: 1개 주문 내 수량을 여러 업체에 나누는 것이 아니라,
  상품 단위로 주문들을 업체에 배분하는 것입니다.
  (예: NGK-3KG 주문 5건 중 3건은 A업체, 2건은 B업체)
- 작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[1단계: API - 배분 확정 → 주문 배정]

POST /api/admin/allocations/:allocationId/assign-orders
배분 확정 후 실제 주문에 업체를 배정합니다.

처리 로직:
1. 해당 allocationId의 confirmed allocation_details를 조회합니다.

2. 해당 상품코드(productCode)의 미배정 주문을 조회합니다.
   - pending_orders에서 productCode 일치
   - vendorId IS NULL (아직 미배정)
   - 상태가 '대기' 또는 '상품준비중'

3. 주문을 업체별 allocatedQuantity에 맞게 순서대로 배정합니다.
   배정 규칙:
   - 주문을 생성일 순으로 정렬
   - 첫 번째 업체의 allocatedQuantity만큼 주문에 vendorId 배정
   - 다음 업체의 allocatedQuantity만큼 다음 주문들에 배정
   - 자체 발송(vendorId=NULL인 detail)은 fulfillmentType='self' 유지

   예) A업체 80박스, B업체 50박스, 자체 20박스인 경우:
   - 주문1(30박스) → A업체 배정
   - 주문2(50박스) → A업체 배정 (A업체 누계 80)
   - 주문3(40박스) → B업체 배정
   - 주문4(10박스) → B업체 배정 (B업체 누계 50)
   - 주문5(20박스) → 자체 발송 유지

4. 배정 시 pending_orders 업데이트:
   - vendorId: 배정된 업체 ID (자체는 NULL)
   - fulfillmentType: 'vendor' (외주) 또는 'self' (자체)
   - vendorPrice: 해당 업체의 매입가

5. 트랜잭션으로 처리 (전체 성공 또는 전체 롤백)

6. 응답:
{
  "allocationId": 1,
  "assignedOrders": 5,
  "byVendor": [
    { "vendorId": 1, "companyName": "A농원", "orderCount": 2, "totalQuantity": 80 },
    { "vendorId": 2, "companyName": "B과수원", "orderCount": 2, "totalQuantity": 50 },
    { "vendorId": null, "companyName": "자체발송", "orderCount": 1, "totalQuantity": 20 }
  ]
}

[2단계: 관리자 화면 - 일일 배분 페이지]

관리자 대시보드에 "일일 배분" 메뉴를 추가합니다.
기존 메뉴에 항목만 추가하고, 기존 페이지는 수정하지 마세요.

화면 구성 — 3영역 레이아웃:

영역 1: 배분 현황 요약 (상단)
- 날짜 선택 (datepicker, 기본값: 오늘)
- "외주상품 집계" 버튼 → POST /api/admin/allocations/generate 호출
- 요약 카드: 총 상품 수, 배분 대기, 알림 발송, 회신 대기, 배분 완료

영역 2: 상품별 배분 목록 (중간)
- 테이블: 상품코드, 상품명, 총 필요수량, 배분완료수량, 미배분수량, 상태
- 상태별 색상 구분: pending(회색), notifying(파랑), waiting(노랑), confirmed(초록)
- 각 행 클릭 시 영역 3에 상세 표시

영역 3: 선택 상품 배분 상세 (하단)
- 선택된 상품의 배분 상세 (allocation_details)
- 테이블: 업체명, 요청수량, 확인수량, 확정수량, 매입가, 상태
- 액션 버튼들:
  a) "업체 알림 발송" → 업체 선택 + 요청수량 입력 모달
  b) "가능수량 입력" → 업체별 확인수량 입력 (관리자 대신 입력)
  c) "추가 업체 알림" → 부족분에 대해 추가 업체 선택
  d) "배분 확정" → 최종 배분 수량 확인 후 확정
  e) "주문 배정" → 확정된 배분을 실제 주문에 반영

전체 워크플로우 (화면에서의 흐름):
1. 날짜 선택 → "외주상품 집계" 클릭 → 상품별 필요수량 표시
2. 상품 선택 → "업체 알림 발송" → 업체+수량 지정 → 알림 발송
3. 업체 회신 대기 → "가능수량 입력" (관리자가 대신)
4. 부족분 있으면 → "추가 업체 알림"
5. 수량 조정 후 → "배분 확정"
6. "주문 배정" → pending_orders에 실제 반영

[완료 확인]
- 주문 배정 API가 정상 동작하는지 확인
- 배정 후 pending_orders에 vendorId, fulfillmentType, vendorPrice가 정상 설정되는지 확인
- 관리자 배분 페이지가 정상 로드되는지 확인
- 전체 워크플로우(집계→알림→회신→확정→배정)가 동작하는지 확인
- ⚡ 기존 주문 목록 페이지에서 배정된 주문의 발송구분/공급업체가 표시되는지 확인
- ⚡ 기존 주문 상태 변경, 정산 프로세스에 영향이 없는지 확인
- 결과를 한글로 보고해 주세요
```

---

## Phase 2 완료 후 통합 테스트 프롬프트

```
[작업 지시]
Phase 2 전체 작업의 통합 테스트를 진행합니다.
작업 진행 상황 설명과 작업 결과는 항상 한글로 보여주세요.

[테스트 시나리오]

1. 기존 기능 회귀 테스트
   - 자체상품 등록/전송/주문/배송/정산이 기존과 동일한지
   - 회원 엑셀 업로드 주문 생성이 정상인지
   - Phase 1에서 구현한 기능(업체관리, 상품매핑 등)이 정상인지

2. 배분 전체 플로우 테스트

   사전 준비:
   - 외주업체 2개 등록 (A농원, B과수원)
   - 상품 1개에 외주 플래그 설정 + 두 업체 매핑 (매입가 각각 8000, 8500)
   - 해당 상품으로 주문 5건 생성

   테스트 흐름:
   a) 외주상품 집계
      - POST /api/admin/allocations/generate 호출
      - order_allocations에 집계 결과가 생성되는지
      - 총 필요수량이 올바른지

   b) 업체 알림 발송
      - A농원에 100박스, B과수원에 50박스 요청
      - allocation_details에 2건 생성되는지
      - 상태가 'notified'인지
      - 솔라피 발송 시도 (실패해도 OK)

   c) 가능수량 접수
      - A농원: 80박스 가능 (부족)
      - B과수원: 50박스 가능
      - 상태가 'responded'로 변경되는지

   d) 추가 업체 알림 (선택)
      - 부족분 20박스에 대해 추가 업체 또는 자체 발송 결정

   e) 배분 확정
      - A농원 80, B과수원 50, 자체 20으로 확정
      - 배분 총량 = 필요수량 검증

   f) 주문 배정
      - pending_orders 5건에 vendorId, fulfillmentType, vendorPrice 배정
      - 주문 목록에서 발송구분/공급업체 컬럼 확인

   g) 이후 주문 처리
      - 배정된 외주 주문 → 배송중 전환 → 재고 미차감 확인
      - 배정된 자체 주문 → 배송중 전환 → 재고 차감 확인
      - 정산 정상 동작 확인

[결과 보고]
각 테스트 항목별로 ✅ 통과 / ❌ 실패를 한글로 보고해 주세요.
실패 항목이 있으면 원인과 수정 방안을 함께 알려주세요.
```

---

## 트러블슈팅 가이드

### 기존 기능이 깨졌을 때:

```
[기존 기능 복구 요청]
Phase 2 작업 후 기존 기능에 문제가 발생했습니다.

깨진 기능: [여기에 문제가 된 기존 기능 설명]

⚠️ 복구 원칙:
- Phase 2에서 추가/수정한 코드에서 원인을 찾아주세요.
- 기존 코드를 원래대로 되돌리고, 새 기능은 다른 방법으로 구현해 주세요.
- 특히 pending_orders 관련 기존 쿼리가 영향받지 않았는지 확인해 주세요.
- 결과를 한글로 보고해 주세요.
```

### 배분 수량 불일치 시:

```
[배분 수량 불일치 수정 요청]
배분 확정 또는 주문 배정 시 수량이 맞지 않습니다.

문제 상황: [여기에 구체적인 수량 불일치 설명]

확인 사항:
- order_allocations.totalQuantity와 실제 주문 수량 합계가 일치하는지
- allocation_details의 allocatedQuantity 합계가 totalQuantity 이하인지
- 주문 배정 시 배정된 주문 수량 합계와 allocatedQuantity가 일치하는지
- 결과를 한글로 보고해 주세요.
```
