# 계산서 / 세금계산서 관리 시스템 가이드

> 문서 최종 업데이트: 2026년 2월 17일  
> 시스템 위치: 관리자 > 회계관리 > 매출 요약 탭

---

## 1. 시스템 개요

### 1.1 목적
월별 계산서(면세) 및 세금계산서(과세) 발행 내역을 통합 관리하는 시스템입니다.  
회원(B2B 거래처)과 매입업체(벤더)를 하나의 화면에서 조회하고, 발행 상태를 추적하며, 중복 발행을 방지합니다.

### 1.2 핵심 특징
| 특징 | 설명 |
|------|------|
| 통합 관리 | 회원과 매입업체를 하나의 테이블에서 조회 |
| 중복 방지 | 주문 단위(orderIds)로 이미 발행된 건은 재발행 불가 |
| 발행 시점 구분 | 같은 업체라도 발행 시점이 다르면 별도 행으로 표시 |
| 서버 측 금액 검증 | 발행 시 금액을 서버에서 직접 재계산 (클라이언트 값 불신) |
| 자동 발행 대비 | `isAutoIssued` 플래그로 수동/자동 발행 구분 가능 |

---

## 2. 데이터 구조

### 2.1 데이터베이스 테이블: `invoice_records`

| 컬럼명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| `id` | serial (PK) | 자동 | 고유 식별자 |
| `target_type` | varchar(20) | O | 대상 유형: `member` 또는 `vendor` |
| `target_id` | varchar(100) | O | 대상 ID (회원 ID 또는 업체 ID) |
| `target_name` | varchar(200) | O | 대상 이름 (회사명 또는 회원명) |
| `business_number` | varchar(50) | X | 사업자번호 |
| `invoice_type` | varchar(20) | O | 계산서 유형: `exempt`(면세), `taxable`(과세), `mixed`(혼합) |
| `year` | integer | O | 발행 연도 |
| `month` | integer | O | 발행 월 |
| `order_ids` | jsonb (string[]) | O | 발행 대상 주문 ID 배열 (중복 방지 핵심) |
| `order_count` | integer | O | 발행 주문 건수 |
| `supply_amount` | integer | O | 공급가액 합계 |
| `vat_amount` | integer | O | 부가세 합계 |
| `total_amount` | integer | O | 총액 합계 |
| `is_auto_issued` | boolean | O | 자동 발행 여부 (기본: false) |
| `memo` | text | X | 발행 메모 |
| `issued_at` | timestamp | O | 발행 일시 |
| `issued_by` | varchar(100) | X | 발행자 이름 |
| `created_at` | timestamp | 자동 | 레코드 생성 일시 |

### 2.2 주문 ID 체계

시스템 내에서 주문의 출처에 따라 ID 접두사가 다릅니다:

| ID 형식 | 출처 | 설명 |
|---------|------|------|
| `일반 ID` (접두사 없음) | 사이트 주문 | 정산 이력(settlement_history)에서 추출 |
| `ds_숫자` | 회원 직접판매 | direct_sales 테이블의 회원 연결 건 |
| `vds_숫자` | 매입업체 직접판매 | direct_sales 테이블의 매입업체 연결 건 |

---

## 3. 세금 계산 로직

### 3.1 면세 (계산서) - 농산물 등

```
공급가액 = 예치금 사용액 (depositAmount)
부가세   = 0원
합계     = 공급가액
```

면세 품목은 부가세가 없으므로, 실제 결제된 예치금 금액이 그대로 공급가액이 됩니다.

### 3.2 과세 (세금계산서)

```
공급가액 = Math.round(예치금 사용액 / 1.1)
부가세   = 예치금 사용액 - 공급가액
합계     = 예치금 사용액
```

과세 품목은 예치금 사용액에 부가세(10%)가 포함되어 있으므로, 역산하여 공급가액과 부가세를 분리합니다.

### 3.3 포인터 처리

포인터(point) 사용분은 계산서/세금계산서 발행 대상에서 **제외**됩니다.  
실제 예치금(deposit)으로 결제된 금액만 발행 대상입니다.

```
총 주문액 = 포인터 사용액 + 예치금 사용액
계산서 발행 대상 금액 = 예치금 사용액만
```

### 3.4 혼합 (mixed)

한 업체의 주문 중 면세 품목과 과세 품목이 모두 포함된 경우:
- 면세 품목: 계산서 로직 적용
- 과세 품목: 세금계산서 로직 적용
- `invoice_type`은 `mixed`로 기록

---

## 4. 데이터 흐름 및 시나리오

### 4.1 전체 흐름도

```
[주문 등록] → [정산 완료(배송중 전환)] → [정산 이력 생성]
                                              ↓
[직접 판매 등록] ────────────────────→ [직접 판매 이력]
                                              ↓
                                    [월별 계산서 요약 조회]
                                              ↓
                                    ┌─────────┴─────────┐
                                    │                   │
                              [미발행 건]          [발행 건]
                                    │                   │
                              [수동 발행]      [발행 이력 표시]
                                    │
                              [invoice_records 생성]
                                    │
                              [발행 완료 표시]
```

### 4.2 시나리오 1: 기본 조회

**상황:** 관리자가 2026년 1월 계산서 내역을 확인하려 합니다.

1. 관리자 > 회계관리 > 매출 요약 탭 접속
2. 상단에서 **2026년 1월** 선택
3. 시스템이 다음 데이터를 수집:
   - 해당 월 정산 완료된 사이트 주문 (settlement_history 기준)
   - 해당 월 직접 판매 건 (direct_sales 기준)
   - 기존 발행 이력 (invoice_records 기준)
4. 결과를 통합 테이블에 표시:
   - 발행된 건: "발행" 뱃지 + 발행일자
   - 미발행 건: "미발행" 뱃지 + "발행" 버튼

### 4.3 시나리오 2: 수동 발행

**상황:** "한길농산" 회원의 1월 미발행 건을 발행합니다.

1. 통합 테이블에서 "한길농산" 행의 **발행** 버튼 클릭
2. 발행 확인 다이얼로그 표시:
   - 대상: 한길농산 (사업자번호: 123-45-67890)
   - 구분: 회원
   - 주문 건수: 15건
   - 면세 공급가액: 2,500,000원 / 과세 공급가액: 1,000,000원
   - 부가세: 100,000원
   - 합계: 3,600,000원
3. 메모 입력 (선택사항): "1월분 일괄 발행"
4. **발행** 버튼 클릭
5. 서버에서 실행되는 작업:
   - 해당 orderIds가 이미 발행되었는지 중복 확인
   - 금액을 DB에서 직접 재계산 (클라이언트 값 무시)
   - invoice_records에 새 레코드 생성
6. 테이블이 자동 갱신되어 해당 건이 "발행" 상태로 변경

### 4.4 시나리오 3: 중복 발행 차단

**상황:** 이미 발행된 주문을 다시 발행하려 합니다.

1. A 관리자가 "한길농산" 1월분을 발행 완료
2. B 관리자가 같은 시간에 같은 건을 발행 시도
3. 서버가 orderIds를 확인하여 중복 감지
4. 오류 메시지 반환: "이미 발행된 주문이 N건 포함되어 있습니다. 중복 발행은 불가합니다."
5. 발행 차단

### 4.5 시나리오 4: 동일 업체 분할 발행

**상황:** "한길농산"의 1월 주문 20건 중 10건만 먼저 발행합니다.

> 현재 시스템에서는 미발행 건 전체를 일괄 발행하는 방식입니다.  
> 부분 발행이 필요한 경우, 향후 주문 선택 기능을 추가할 수 있습니다.

1. 1차 발행: 20건 전체를 1월 10일에 발행
   - invoice_records 행 1개 생성 (issued_at: 1월 10일)
2. 만약 1월 15일에 추가 주문이 정산되면:
   - 해당 건은 새로운 미발행 행으로 표시
   - 2차 발행: 추가 5건을 1월 20일에 발행
   - invoice_records 행 1개 추가 생성 (issued_at: 1월 20일)
3. 테이블 표시:
   ```
   한길농산 | 20건 | 발행 (2026.1.10)
   한길농산 |  5건 | 발행 (2026.1.20)
   ```
   같은 업체이지만 발행 시점이 달라 **별도 행으로 구분** 표시됩니다.

### 4.6 시나리오 5: 필터 및 검색

**상황:** 특정 매입업체의 계산서 내역만 확인합니다.

1. 필터 드롭다운에서 **매입업체** 선택
2. 검색창에 업체명 또는 사업자번호 입력
3. 자동완성 목록에서 원하는 업체 선택
4. 해당 업체의 발행/미발행 건만 필터링되어 표시

---

## 5. API 구조

### 5.1 통합 조회 API

```
GET /api/admin/accounting/invoice-summary
```

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| year | number | X | 조회 연도 (기본: 올해) |
| month | number | X | 조회 월 (기본: 이번 달) |
| filterType | string | X | 필터: `all` / `member` / `vendor` (기본: all) |
| searchId | string | X | 특정 대상 ID로 필터링 |

**응답 구조:**
```json
{
  "year": 2026,
  "month": 1,
  "rows": [
    {
      "type": "member",
      "targetId": "abc-123",
      "targetName": "한길농산",
      "businessNumber": "123-45-67890",
      "invoiceId": 1,
      "invoiceType": "exempt",
      "orderCount": 15,
      "totalOrderAmount": 3000000,
      "pointerUsed": 500000,
      "exemptAmount": 2500000,
      "taxableSupply": 0,
      "taxableVat": 0,
      "taxableAmount": 0,
      "issuedStatus": "issued",
      "issuedAt": "2026-01-15T09:00:00.000Z",
      "isAutoIssued": false,
      "memo": "1월분 일괄",
      "orderIds": ["order1", "order2", "ds_5"]
    }
  ],
  "totals": {
    "totalOrderAmount": 15000000,
    "pointerUsed": 1000000,
    "exemptAmount": 10000000,
    "taxableSupply": 3636364,
    "taxableVat": 363636,
    "taxableAmount": 4000000,
    "issuedCount": 3,
    "notIssuedCount": 5
  }
}
```

### 5.2 수동 발행 API

```
POST /api/admin/accounting/invoice-issue
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| targetType | string | O | `member` 또는 `vendor` |
| targetId | string | O | 대상 ID |
| targetName | string | O | 대상 이름 |
| businessNumber | string | X | 사업자번호 |
| invoiceType | string | O | `exempt` / `taxable` / `mixed` |
| year | number | O | 연도 |
| month | number | O | 월 |
| orderIds | string[] | O | 발행 대상 주문 ID 배열 |
| memo | string | X | 발행 메모 |

> supplyAmount, vatAmount, totalAmount는 서버에서 orderIds 기반으로 **직접 재계산**합니다.

### 5.3 검색 대상 목록 API

```
GET /api/admin/accounting/invoice-targets
```

| 파라미터 | 타입 | 설명 |
|---------|------|------|
| type | string | `member` 또는 `vendor` |
| search | string | 검색어 (업체명, 사업자번호) |

자동완성 드롭다운에 사용되며, 최대 30건까지 반환합니다.

### 5.4 엑셀 다운로드 API

```
GET /api/admin/accounting/invoice-summary-export
```

| 파라미터 | 타입 | 설명 |
|---------|------|------|
| year | number | 연도 |
| month | number | 월 |
| filterType | string | 필터 유형 |
| searchId | string | 특정 대상 필터 |

서버에서 동일한 조회 함수(`getInvoiceSummaryData`)를 사용하여 직접 데이터를 조회한 후 엑셀 파일(.xlsx)로 반환합니다.

---

## 6. UI 구성

### 6.1 화면 레이아웃

```
┌─────────────────────────────────────────────────────┐
│  [1] 월별 매출 요약                    [연도▼] [월▼]│
│  ┌──────────┐ ┌──────────┐ ┌──────────┐            │
│  │ 총 매출   │ │ 사이트   │ │ 직접판매  │            │
│  │ 15,000만  │ │ 11,000만 │ │ 4,000만  │            │
│  └──────────┘ └──────────┘ └──────────┘            │
├─────────────────────────────────────────────────────┤
│  계산서/세금계산서 내역  [3건 발행] [5건 미발행]      │
│  [전체▼] [검색입력__________] [엑셀]                │
│                                                     │
│  ⚠ 안내: 면세(농산물)=계산서, 과세=세금계산서         │
│                                                     │
│  ┌───┬───────┬──────┬────┬──────┬─────┬──────┬───┐ │
│  │구분│업체명 │사업자│건수│총주문│면세 │과세  │상태│ │
│  ├───┼───────┼──────┼────┼──────┼─────┼──────┼───┤ │
│  │회원│한길농산│123-45│15 │300만 │250만│0    │발행│ │
│  │회원│대한유통│234-56│ 8 │150만 │0   │150만│미발│ │
│  │업체│신선물류│345-67│ 5 │ 80만 │80만 │0   │미발│ │
│  └───┴───────┴──────┴────┴──────┴─────┴──────┴───┘ │
│                                                     │
│  합계: 총주문 530만 | 면세 330만 | 과세 150만        │
└─────────────────────────────────────────────────────┘
```

### 6.2 테이블 컬럼

| 컬럼 | 설명 |
|------|------|
| 구분 | 회원 / 매입업체 (색상 뱃지로 구분) |
| 업체명(회원명) | 대상 이름 |
| 사업자번호 | 사업자 등록번호 |
| 주문건수 | 해당 월 정산 완료 건수 |
| 총주문액 | 포인터 + 예치금 합계 |
| 포인터사용 | 포인터로 결제된 금액 (발행 제외 대상) |
| 면세(공급가액) | 면세 품목 공급가 합계 |
| 과세(공급가액) | 과세 품목 공급가 (부가세 전) |
| 부가세 | 과세 부가세 합계 |
| 과세합계 | 과세 공급가 + 부가세 |
| 발행상태 | 발행 완료(날짜 표시) / 미발행(발행 버튼) |

### 6.3 발행 다이얼로그

발행 버튼 클릭 시 확인 다이얼로그가 표시됩니다:

- 대상 정보: 업체명, 구분(회원/매입업체), 사업자번호
- 금액 요약: 면세 공급가, 과세 공급가, 부가세, 합계
- 메모 입력란 (선택)
- 발행 확인 / 취소 버튼

---

## 7. 데이터 수집 원천

### 7.1 회원(member) 데이터 원천

| 데이터 | 원천 테이블 | 조건 |
|--------|------------|------|
| 사이트 주문 | settlement_history + pending_orders | 해당 월에 정산 완료된 건 |
| 직접 판매 | direct_sales | memberId가 연결된 건 |

### 7.2 매입업체(vendor) 데이터 원천

| 데이터 | 원천 테이블 | 조건 |
|--------|------------|------|
| 직접 판매 | direct_sales | vendorId가 연결되고 clientType=vendor인 건 |

---

## 8. 향후 확장 계획

### 8.1 자동 발행 시스템

`is_auto_issued` 필래그가 이미 준비되어 있어, 향후 자동 발행 시스템 연동이 가능합니다.

**예상 시나리오:**
1. 매월 말일 또는 다음 달 초에 스케줄러 실행
2. 미발행 건을 자동으로 수집
3. 이미 수동 발행된 주문은 자동 제외 (orderIds 중복 체크)
4. `is_auto_issued = true`로 자동 발행 레코드 생성
5. 관리자에게 발행 완료 알림

### 8.2 부분 발행 (선택 발행)

현재는 대상별 미발행 건 전체를 일괄 발행합니다.  
향후 주문 단위 선택 발행 기능 추가가 가능합니다:
- 특정 주문만 선택하여 부분 발행
- 남은 주문은 계속 미발행 상태 유지

### 8.3 발행 취소/수정

현재는 발행 후 취소 기능이 없습니다.  
향후 필요 시:
- invoice_records에 `cancelled_at`, `cancelled_by` 컬럼 추가
- 취소 시 해당 orderIds를 다시 미발행 상태로 전환

---

## 9. 보안 및 데이터 무결성

### 9.1 접근 제어
- 모든 API는 **관리자(ADMIN, SUPER_ADMIN)** 권한 필요
- 세션 기반 인증 필수

### 9.2 금액 검증
- 발행 시 클라이언트가 전송한 금액은 **무시**
- 서버에서 orderIds 기반으로 DB에서 직접 금액 재계산
- 세금 계산 로직도 서버에서 일관되게 적용

### 9.3 중복 방지
- invoice_records의 orderIds 배열로 이미 발행된 주문 추적
- 발행 요청 시 기존 발행 건과 교차 검증
- 중복 감지 시 400 오류 반환

### 9.4 엑셀 다운로드 보안
- 서버에서 직접 데이터를 조회하여 엑셀 생성
- 클라이언트가 데이터를 조작할 수 없음
- 조회 API와 동일한 공유 함수 사용으로 데이터 일관성 보장

---

## 10. 용어 정리

| 용어 | 설명 |
|------|------|
| 계산서 | 면세 품목(농산물 등) 거래 시 발행하는 세금 증빙 |
| 세금계산서 | 과세 품목 거래 시 발행하는 세금 증빙 (부가세 포함) |
| 공급가액 | 부가세를 제외한 순수 상품/서비스 가격 |
| 부가세 | 공급가액의 10%에 해당하는 세금 |
| 면세 | 부가세가 면제되는 품목 (농산물 등) |
| 과세 | 부가세가 부과되는 품목 |
| 예치금 | 회원이 미리 충전한 결제 잔액 |
| 포인터 | 관리자가 지급한 크레딧 (계산서 발행 대상 제외) |
| 정산 | 배송중 전환 시 주문 금액이 잔액에서 차감되는 과정 |
| 직접 판매 | 사이트 외 별도 거래를 수동 등록한 건 |
